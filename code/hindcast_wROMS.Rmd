---
title: "Hindcast ROMS variables"
author: "Rebecca Howard"
date: "9/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(marmap)
library(maps)
library(mapdata)
library(fields)
library(here)
library(mgcv)
library(tidyr)
library(dplyr)
library(ggplot2)
library(raster)
library(rgdal)
library(viridis)
library(RColorBrewer)
library(colorspace)
library(scales)
source(here('code/functions', 'vis_gam_COLORS.R'))
source(here('code/functions', 'distance_function.R'))
source(here('code/functions', 'gam_selection.R'))
source(here('code/functions', 'map_vc_presentation.R'))
source(here('code/functions', 'map_vc.R'))
source(here('code/functions', 'map_phenology.R'))
source(here('code/functions', 'threepanel_base_mse.R'))
source(here('code/functions', 'vc_grids_presentation.R'))
source(here('code/functions', 'vc_grids.R'))
source(here('code/functions', 'plot_variable.R'))
source(here('code/functions', 'location_plot.R'))
source(here('code/functions', 'variable_coefficient.R'))
source(here('code/functions', 'phenology_change.R'))
source(here('code/functions', 'distribution_change.R'))
source(here('code/functions', 'plot_var_coef.R'))
source(here('code/functions', 'hindcast_pred.R'))
```

```{r}
# Load ROMS temperature means
roms_temps <- readRDS(here('data', 'roms_temps.rds'))

# Load fish data
clean_data <- function(file, temperature){
  df <- as.data.frame(filter(readRDS(here('data', file))))
  df$mean_temp <- temperature$mean[match(df$year, temperature$year)]
  df$catch <- df$larvalcatchper10m2 + 1
  df <- na.omit(df)
  return(df)
}

pk_egg <- clean_data('pk_egg.rds', roms_temps)
pk_larvae <- clean_data('pk_larvae.rds', roms_temps)
nrs_egg <- clean_data('nrs_egg.rds', roms_temps)
nrs_larvae <- clean_data('nrs_larvae.rds', roms_temps)
akp_egg <- clean_data('akp_egg.rds', roms_temps)
akp_larvae <- clean_data('akp_larvae.rds', roms_temps)
yfs_egg <- clean_data('yfs_egg.rds', roms_temps)
yfs_larvae <- clean_data('yfs_larvae.rds', roms_temps)
pcod_larvae <- clean_data('pcod_larvae.rds', roms_temps)
nrs_larvae <- clean_data('nrs_larvae.rds', roms_temps)

# Colors
contour_col <- rgb(0, 0, 255, max = 255, alpha = 0, names = "white")
```

Base models
```{r}
formula_base <- function(data){
  gam(catch ~ s(year, bs = 're') +
        te(lon, lat, bs = "tp", m = 1) + 
        s(doy, k = 9, bs = "tp", m = 1),
      data = data,
      family = tw(link = 'log'),
      method = 'REML')
}

formula_base_geog <- function(data){
  gam(catch ~ s(year, bs = 're') +
        s(doy, k = 9, bs = "tp", m = 1) +
        te(lon, lat, bs = "tp", m = 1) +
        s(lon, lat, by = mean_temp, bs = "tp", m = 1),
      data = data,
      family = tw(link = 'log'),
      method =  'REML')
}

formula_base_pheno <- function(data){
  gam(catch ~ s(year, bs = 're') +
        s(doy, k = 9, bs = "tp", m = 1) +
        te(lon, lat, bs = "tp", m = 1) +
        s(doy, by = mean_temp, bs = "tp", m = 1),
      data = data,
      family = tw(link = 'log'),
      method =  'REML')
}
```


## Pollock
Base models
```{r}
pk_egg_base_t <- formula_base(pk_egg)
summary(pk_egg_base_t)
AIC(pk_egg_base_t) # 33301, 45.6%

pk_larvae_base_t <- formula_base(pk_larvae)
summary(pk_larvae_base_t)
AIC(pk_larvae_base_t) #30602, 26.3%
```
#### Eggs

Models with flexible phenology or geography 
Note variable coefficient by year for each
```{r}
pk_egg_phenology_t <- formula_base_pheno(pk_egg)
summary(pk_egg_phenology_t)
AIC(pk_egg_phenology_t)

pk_egg_geography_t <- formula_base_geog(pk_egg)
summary(pk_egg_geography_t)
AIC(pk_egg_geography_t)
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_pkegg_phenology_t <- (summary(pk_egg_base_t)$scale - 
                      summary(pk_egg_phenology_t)$scale) / summary(pk_egg_base_t)$scale
ratio_pkegg_phenology_t #0.029

ratio_pkegg_geography_t <- (summary(pk_egg_base_t)$scale - 
                      summary(pk_egg_geography_t)$scale) / summary(pk_egg_base_t)$scale
ratio_pkegg_geography_t #0.085
```

Add ROMS mean temperatures Use a representative area with averaged values from Feb - April for each year This can then be matched to the egg/larvae data for use in variable coefficient by SST instead of year as above

Determine best GAM from 7 formulations (see function)
```{r}
pkegg_gams_t <- gam_selection(pk_egg)
AIC(pkegg_gams_t[[1]][[1]]) # 33128
AIC(pkegg_gams_t[[1]][[2]]) # 33009
AIC(pkegg_gams_t[[1]][[3]]) # 32829
summary(pkegg_gams_t[[2]]) # best model is spatial VC, remove salinity
summary(pkegg_gams_t[[1]][[1]])
summary(pkegg_gams_t[[1]][[2]])

better_pkegg <- gam(data = pk_egg,
                    formula = catch ~ s(year, bs = "re") +
                      s(doy, k = 9, bs = "tp", m = 1) +
                      te(lon, lat, bs = "tp", m = 1) +
                      s(roms_temperature, k = 5, bs = "tp", m = 1) +
                      s(lon, lat, by = mean_temp, bs = "tp", m = 1),
                    family = tw(link = "log"),
                    method = "REML")
summary(better_pkegg)
AIC(better_pkegg)

pkegg_gams_t <- list(pkegg_gams_t[[1]], better_pkegg) # switch in better GAM
AIC(pkegg_gams_t[[1]][[1]]) - AIC(pkegg_gams_t[[2]]) # 303
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(pkegg_gams_t[[1]][[2]], select = 2, main = "DOY")
plot(pkegg_gams_t[[1]][[2]], select = 4, main = "Temperature")
plot(pkegg_gams_t[[1]][[2]], select = 5, main = "Salinity")
plot(pkegg_gams_t[[1]][[2]], select = 6, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pkegg_gams_t[[1]][[2]])
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(pkegg_gams_t[[1]][[3]], select = 2, main = "DOY")
plot(pkegg_gams_t[[1]][[3]], select = 4, main = "Temperature")
plot(pkegg_gams_t[[1]][[3]], select = 5, main = "Salinity")
plot(pkegg_gams_t[[1]][[3]], select = 6, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pkegg_gams_t[[1]][[3]])
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_pkegg_month_t <- (summary(pk_egg_base_t)$scale - 
                         summary(pkegg_gams_t[[1]][[2]])$scale) / summary(pk_egg_base_t)$scale
var_ratio_pkegg_month_t #0.07

var_ratio_pkegg_space_t <- (summary(pk_egg_base_t)$scale - 
                         summary(pkegg_gams_t[[2]])$scale) / summary(pk_egg_base_t)$scale
var_ratio_pkegg_space_t #0.11
```
```{r}
nlat = 40
  nlon = 60
  latd = seq(min(pk_egg$lat), max(pk_egg$lat), length.out = nlat)
  lond = seq(min(pk_egg$lon), max(pk_egg$lon), length.out = nlon)
  
  grid_extent <- expand.grid(lond, latd)
  names(grid_extent) <- c('lon', 'lat')
  
  grid_extent$dist <- NA
  
  for (k in 1:nrow(grid_extent)) {
    dist <- distance_function(grid_extent$lat[k],
                              grid_extent$lon[k],
                              pk_egg$lat,
                              pk_egg$lon)
    grid_extent$dist[k] <- min(dist)
  }
  
  grid_extent$year <- 2014
  grid_extent$doy <- rep(134, length(grid_extent))
  grid_extent$month <- 5
  grid_extent$mean_temp <- roms_temps$mean[roms_temps$year == 2014]
  
  grid_extent[, c(8, 9)] <- as.data.frame(RANN::nn2(pk_egg[, c('lat', 'lon')],
                                                    grid_extent[, c('lat', 'lon')],
                                                    k = 1))
  grid_extent$roms_temperature <-pk_egg[c(grid_extent$nn.idx), 11] 
  grid_extent$roms_salinity <- pk_egg[c(grid_extent$nn.idx), 12] 
  grid_extent <- grid_extent[-c(8, 9)] 
  grid_extent$pred <- exp(predict(pkegg_gams_t[[2]],
                                  newdata = grid_extent,
                                  type = "link"))
  grid_extent$pred[grid_extent$dist > 30000] <- NA
  grid_extent$pred_scaled <- rescale(grid_extent$pred, na.rm = TRUE)
```


Create prediction grid to compare with projections
```{r}
pk_egg_hindcast <- hindcast_loop(1988:2014, pk_egg, 5, 134, pkegg_gams_t, roms_temps)
saveRDS(pk_egg_hindcast, here('data', 'pk_egg_hindcast'))
```


Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
pkegg_grids_t <- threepanel_base_mse(pk_egg, pk_egg_base_t)
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(pk_egg, pkegg_grids_t, ratio_pkegg_geography_t,
                 var_ratio_pkegg_space_t,
                 ratio_pkegg_phenology_t,
                 var_ratio_pkegg_month_t)
dev.copy(jpeg,
         here('results/pollock_hindcast', 
              'pollock_egg_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs
```{r}
pkegg_vcgrids_t <- vc_grids_presentation(pk_egg, pkegg_gams_t)
```

Create two panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
jet.colors <- colorRampPalette(rev(c("#FFFFCC", "#FBF2A8", "#F9E585",
                                     "#F5D363", "#EFBA55", "#EAA352",
                                     "#E68C51", "#E0754F", "#D75C4D",
                                     "#BB4A48", "#994240", "#763931", 
                                     "#542D20", "#352311", "#191900")))

# The warning seems to have something to do with using RMarkdown, not the script
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc_presentation(pk_egg, pkegg_gams_t[[2]], pkegg_vcgrids_t)
legend(50,
       6,
       legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
       lty = 1,
       bty = 'n',
       lwd = 2,
       cex = 1.2)
dev.copy(jpeg,
         here('results/pollock_hindcast',
         'pollock_egg_vc_t.jpg'),
         height = 3.5,
         width = 10,
         res = 200,
         units = 'in')
dev.off()
```

```{r}
tiff(here('results/pollock_hindcast/outputs',
         'pollock_egg_output.jpg'),
     units = "in",
     width = 40,
     height = 20,
     res = 200)
par(mfrow = c(1, 2),
    mar = c(11, 15, .5, 0.6) + 0.1,
    oma = c(3, 1, 1, 1),
    mgp = c(9, 4, 0))
plot_variable(pkegg_gams_t,
              covariate = 2,
              bounds = c(-6.5, 9),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(pkegg_gams_t,
              covariate = 4,
              bounds = c(-6.5, 9),
              "Temperature",
              " ",
              "n")
dev.off()
```

Plot the variable coefficient term
```{r, warning = FALSE}
pred_pkegg_t <- variable_coefficient2(pkegg_gams_t, pk_egg)

jet.colors <- colorRampPalette(alpha = TRUE,
                               c(sequential_hcl(alpha = 0.8, 15, palette = "Mint")))

plot_var_coef(pkegg_gams_t, pk_egg, pred_pkegg_t)
dev.copy(jpeg, here('results/pollock_hindcast', 'pkegg_var_coef.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

#### Larvae

Models with flexible phenology or geography 
Note variable coefficient by year for each
```{r}
pk_larvae_phenology_t <- gam(catch ~ s(year, bs = 're') +
                               s(doy, k = 9, bs = "tp", m = 1) +
                               te(lon, lat, bs = "tp", m = 1) +
                               s(doy, by = mean_temp, bs = "tp", m = 1),
                             data = pk_larvae,
                             family = tw(link = 'log'),
                             method = 'REML')
summary(pk_larvae_phenology_t)
AIC(pk_larvae_phenology_t)

pk_larvae_geography_t <- gam(catch ~ s(year, bs = 're') +
                               te(lon, lat, bs = "tp", m = 1) +
                               s(lon, lat, by = mean_temp, bs = "tp", m = 1) +
                               s(doy, k = 9, bs = "tp", m = 1),
                             data = pk_larvae,
                             family = tw(link = 'log'),
                             method = 'REML')
summary(pk_larvae_geography_t)
AIC(pk_larvae_geography_t)
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_pklarvae_phenology_t <- (summary(pk_larvae_base_t)$scale - 
                      summary(pk_larvae_phenology_t)$scale) / summary(pk_larvae_base_t)$scale
ratio_pklarvae_phenology_t # 0.14

ratio_pklarvae_geography_t <- (summary(pk_larvae_base_t)$scale - 
                      summary(pk_larvae_geography_t)$scale) / summary(pk_larvae_base_t)$scale
ratio_pklarvae_geography_t # 0.19
```

Determine best GAM from 7 formulations (see function)
```{r}
pklarvae_gams_t <- gam_selection(pk_larvae)
AIC(pklarvae_gams_t[[1]][[1]]) #29857
AIC(pklarvae_gams_t[[1]][[2]]) #29569
AIC(pklarvae_gams_t[[1]][[3]]) #29457
summary(pklarvae_gams_t[[2]]) # best model is spatial, retain all smooth terms
AIC(pklarvae_gams_t[[1]][[1]]) - AIC(pklarvae_gams_t[[2]]) # 400
summary(pklarvae_gams_t[[1]][[1]])
summary(pklarvae_gams_t[[1]][[2]])
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(pklarvae_gams_t[[1]][[2]], select = 2, main = "DOY")
plot(pklarvae_gams_t[[1]][[2]], select = 4, main = "Temperature")
plot(pklarvae_gams_t[[1]][[2]], select = 5, main = "Salinity")
plot(pklarvae_gams_t[[1]][[2]], select = 6, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_larvae_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pklarvae_gams_t[[1]][[2]])
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_larvae_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(pklarvae_gams_t[[1]][[3]], select = 2, main = "DOY")
plot(pklarvae_gams_t[[1]][[3]], select = 4, main = "Temperature")
plot(pklarvae_gams_t[[1]][[3]], select = 5, main = "Salinity")
plot(pklarvae_gams_t[[1]][[3]], select = 6, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_larvae_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pklarvae_gams_t[[1]][[3]])
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_larvae_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_pklarvae_month_t <- (summary(pk_larvae_base_t)$scale - 
                         summary(pklarvae_gams_t[[1]][[2]])$scale) / summary(pk_larvae_base_t)$scale
var_ratio_pklarvae_month_t #0.24

var_ratio_pklarvae_space_t <- (summary(pk_larvae_base_t)$scale - 
                         summary(pklarvae_gams_t[[1]][[3]])$scale) / summary(pk_larvae_base_t)$scale
var_ratio_pklarvae_space_t #0.26
```

Create prediction grid to compare with projections
```{r}
pk_larvae_hindcast <- hindcast_loop(1988:2014, pk_larvae, 5, 134, pklarvae_gams_t, roms_temps)
saveRDS(pk_larvae_hindcast, here('data', 'pk_larvae_hindcast'))
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
pklarvae_grids_t <- threepanel_base_mse(pk_larvae, pk_larvae_base_t)
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(pk_larvae, pklarvae_grids_t, ratio_pklarvae_geography_t,
                 var_ratio_pklarvae_space_t,
                 ratio_pklarvae_phenology_t,
                 var_ratio_pklarvae_month_t)
dev.copy(jpeg,
         here('results/pollock_hindcast', 
              'pollock_larvae_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs
```{r}
pklarvae_vcgrids_t <- vc_grids_presentation(pk_larvae, pklarvae_gams_t)
```

Create two panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
jet.colors <- colorRampPalette(rev(c("#FFFFCC", "#FBF2A8", "#F9E585",
                                     "#F5D363", "#EFBA55", "#EAA352",
                                     "#E68C51", "#E0754F", "#D75C4D",
                                     "#BB4A48", "#994240", "#763931", 
                                     "#542D20", "#352311", "#191900")))

par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc_presentation(pk_larvae, pklarvae_gams_t[[2]], pklarvae_vcgrids_t)
legend(100,
       5,
       legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
       lty = 1,
       bty = 'n',
       lwd = 2,
       cex = 1.2)
dev.copy(jpeg,
         here('results/pollock_hindcast',
         'pollock_larvae_vc_t.jpg'),
         height = 3.5,
         width = 10,
         res = 200,
         units = 'in')
dev.off()
```

```{r}
tiff(here('results/pollock_hindcast/outputs',
         'pollock_larvae_output.jpg'),
     units = "in",
     width = 40,
     height = 12,
     res = 200)

par(mfrow = c(1, 3),
    mar = c(11, 15, .5, 0.6) + 0.1,
    oma = c(3, 1, 1, 1),
    mgp = c(9, 4, 0))
plot_variable(pklarvae_gams_t,
              covariate = 2,
              bounds = c(-6.5, 9),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(pklarvae_gams_t,
              covariate = 4,
              bounds = c(-6.5, 9),
              "Temperature",
              " ",
              "n")
plot_variable(pklarvae_gams_t,
              covariate = 5,
              bounds = c(-6.5, 9),
              "Salinity",
              " ",
              "n")

dev.off()
```

Plot the variable coefficient term
```{r}
pred_pklarvae_t <- variable_coefficient(pklarvae_gams_t, pk_larvae)

jet.colors <- colorRampPalette(alpha = TRUE,
                               c(sequential_hcl(alpha = 0.8, 15, palette = "Mint")))

plot_var_coef(pklarvae_gams_t, pk_larvae, pred_pklarvae_t)
dev.copy(jpeg, here('results/pollock_hindcast', 'pklarvae_var_coef.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

## Flathead Sole
```{r}
nrs_egg_base_t <- formula_base(nrs_egg)
summary(nrs_egg_base_t)
AIC(nrs_egg_base_t) # 14919, 43.6%

nrs_larvae_base_t <- formula_base(nrs_larvae)
summary(nrs_larvae_base_t)
AIC(nrs_larvae_base_t) # 11038, 42.5%
```

#### Eggs

Models with flexible phenology or geography 
Note variable coefficient by year for each
This takes forever to run, don't do unless necessary to recreate figure
```{r}
nrs_egg_phenology_t <- formula_base_pheno(nrs_egg)
summary(nrs_egg_phenology_t)
AIC(nrs_egg_phenology_t)

nrs_egg_geography_t <- formula_base_geog(nrs_egg)
summary(nrs_egg_geography_t)
AIC(nrs_egg_geography_t)
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_nrsegg_phenology_t <- (summary(nrs_egg_base_t)$scale - 
                      summary(nrs_egg_phenology_t)$scale) / summary(nrs_egg_base_t)$scale
ratio_nrsegg_phenology_t #0.042

ratio_nrsegg_geography_t <- (summary(nrs_egg_base_t)$scale - 
                      summary(nrs_egg_geography_t)$scale) / summary(nrs_egg_base_t)$scale
ratio_nrsegg_geography_t #0.10
```

Add ROMS mean temperatures Use a representative area with averaged values from Feb - April for each year This can then be matched to the egg/larvae data for use in variable coefficient by SST instead of year as above


Determine best GAM from 7 formulations (see function)
```{r}
nrsegg_gams_t <- gam_selection(nrs_egg)
AIC(nrsegg_gams_t[[1]][[1]]) # 14765
AIC(nrsegg_gams_t[[1]][[2]]) # 14709
AIC(nrsegg_gams_t[[1]][[3]]) # 14603
summary(nrsegg_gams_t[[2]]) # best model is spatial VC
AIC(nrsegg_gams_t[[1]][[1]]) - AIC(nrsegg_gams_t[[2]]) # 162
summary(nrsegg_gams_t[[1]][[1]])
summary(nrsegg_gams_t[[1]][[2]])
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(nrsegg_gams_t[[1]][[2]], select = 2, main = "DOY")
plot(nrsegg_gams_t[[1]][[2]], select = 4, main = "Temperature")
plot(nrsegg_gams_t[[1]][[2]], select = 5, main = "Salinity")
plot(nrsegg_gams_t[[1]][[2]], select = 6, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_egg_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(nrsegg_gams_t[[1]][[2]])
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_egg_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(nrsegg_gams_t[[1]][[3]], select = 2, main = "DOY")
plot(nrsegg_gams_t[[1]][[3]], select = 4, main = "Temperature")
plot(nrsegg_gams_t[[1]][[3]], select = 5, main = "Salinity")
plot(nrsegg_gams_t[[1]][[3]], select = 6, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_egg_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(nrsegg_gams_t[[1]][[3]])
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_egg_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_nrsegg_month_t <- (summary(nrs_egg_base_t)$scale - 
                         summary(nrsegg_gams_t[[1]][[2]])$scale) / summary(nrs_egg_base_t)$scale
var_ratio_nrsegg_month_t #0.09

var_ratio_nrsegg_space_t <- (summary(nrs_egg_base_t)$scale - 
                         summary(nrsegg_gams_t[[1]][[3]])$scale) / summary(nrs_egg_base_t)$scale
var_ratio_nrsegg_space_t #0.12
```

Create prediction grid to compare with projections
```{r}
nrs_egg_hindcast <- hindcast_loop(1988:2014, nrs_egg, 6, 154, nrsegg_gams_t, roms_temps)
saveRDS(nrs_egg_hindcast, here('data', 'nrs_egg_hindcast'))
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
nrsegg_grids_t <- threepanel_base_mse(nrs_egg, nrs_egg_base_t)
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(nrs_egg, nrsegg_grids_t, ratio_nrsegg_geography_t,
                 var_ratio_nrsegg_space_t,
                 ratio_nrsegg_phenology_t,
                 var_ratio_nrsegg_month_t)
dev.copy(jpeg,
         here('results/flathead_hindcast', 
              'flathead_egg_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs
```{r}
nrsegg_vcgrids_t <- vc_grids_presentation(nrs_egg, nrsegg_gams_t)
```

Create three panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
jet.colors <- colorRampPalette(rev(c("#FFFFCC", "#FBF2A8", "#F9E585",
                                     "#F5D363", "#EFBA55", "#EAA352",
                                     "#E68C51", "#E0754F", "#D75C4D",
                                     "#BB4A48", "#994240", "#763931", 
                                     "#542D20", "#352311", "#191900")))

par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc_presentation(nrs_egg, nrsegg_gams_t[[2]], nrsegg_vcgrids_t)
legend(125,
       0,
       legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
       lty = 1,
       bty = 'n',
       lwd = 2,
       cex = 1.2)
dev.copy(jpeg,
         here('results/flathead_hindcast',
         'flathead_egg_vc_t.jpg'),
         height = 3.5,
         width = 10,
         res = 200,
         units = 'in')
dev.off()
```

```{r}
tiff(here('results/flathead_hindcast/outputs',
         'flathead_egg_output.jpg'),
     units = "in",
     width = 40,
     height = 12,
     res = 200)

par(mfrow = c(1, 3),
    mar = c(11, 15, .5, 0.6) + 0.1,
    oma = c(3, 1, 1, 1),
    mgp = c(9, 4, 0))
plot_variable(nrsegg_gams_t,
              covariate = 2,
              bounds = c(-5, 2),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(nrsegg_gams_t,
              covariate = 4,
              bounds = c(-5, 2),
              "Temperature",
              " ",
              "n")
plot_variable(nrsegg_gams_t,
              covariate = 5,
              bounds = c(-5, 2),
              "Salinity",
              " ",
              "n")

dev.off()
```

Plot the variable coefficient term
```{r}
pred_nrsegg_t <- variable_coefficient(nrsegg_gams_t, nrs_egg)

jet.colors <- colorRampPalette(alpha = TRUE,
                               c(sequential_hcl(alpha = 0.8, 15, palette = "Mint")))

plot_var_coef(nrsegg_gams_t, nrs_egg, pred_nrsegg_t)
dev.copy(jpeg, here('results/flathead_hindcast', 'nrsegg_var_coef.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

#### Larvae

Models with flexible phenology or geography 
Note variable coefficient by year for each
```{r}
nrs_larvae_phenology_t <- formula_base_pheno(nrs_larvae)
summary(nrs_larvae_phenology_t)
AIC(nrs_larvae_phenology_t)

nrs_larvae_geography_t <- formula_base_geog(nrs_larvae)
summary(nrs_larvae_geography_t)
AIC(nrs_larvae_geography_t)
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_nrslarvae_phenology_t <- (summary(nrs_larvae_base_t)$scale - 
                      summary(nrs_larvae_phenology_t)$scale) / summary(nrs_larvae_base_t)$scale
ratio_nrslarvae_phenology_t # 0.30

ratio_nrslarvae_geography_t <- (summary(nrs_larvae_base_t)$scale - 
                      summary(nrs_larvae_geography_t)$scale) / summary(nrs_larvae_base_t)$scale
ratio_nrslarvae_geography_t # 0.37
```

Add ROMS mean temperatures Use a representative area with averaged values from Feb - April for each year This can then be matched to the larvae/larvae data for use in variable coefficient by SST instead of year as above

Determine best GAM from 7 formulations (see function)
```{r}
nrslarvae_gams_t <- gam_selection(nrs_larvae)
AIC(nrslarvae_gams_t[[1]][[1]]) #10223
AIC(nrslarvae_gams_t[[1]][[2]]) #9978
AIC(nrslarvae_gams_t[[1]][[3]]) #9778
summary(nrslarvae_gams_t[[2]]) # best model is spatial VC, keep all smooth terms
AIC(nrslarvae_gams_t[[1]][[1]]) - AIC(nrslarvae_gams_t[[2]]) # 445
summary(nrslarvae_gams_t[[1]][[1]])
summary(nrslarvae_gams_t[[1]][[2]])
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(nrslarvae_gams_t[[1]][[2]], select = 2, main = "DOY")
plot(nrslarvae_gams_t[[1]][[2]], select = 4, main = "Temperature")
plot(nrslarvae_gams_t[[1]][[2]], select = 5, main = "Salinity")
plot(nrslarvae_gams_t[[1]][[2]], select = 6, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_larvae_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(nrslarvae_gams_t[[1]][[2]])
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_larvae_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(nrslarvae_gams_t[[1]][[3]], select = 2, main = "DOY")
plot(nrslarvae_gams_t[[1]][[3]], select = 4, main = "Temperature")
plot(nrslarvae_gams_t[[1]][[3]], select = 5, main = "Salinity")
plot(nrslarvae_gams_t[[1]][[3]], select = 6, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_larvae_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(nrslarvae_gams_t[[1]][[3]])
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_larvae_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Create prediction grid to compare with projections
```{r}
nrs_larvae_hindcast <- hindcast_loop(1988:2014, nrs_larvae, 5, 138, nrslarvae_gams_t, roms_temps)
saveRDS(nrs_larvae_hindcast, here('data', 'nrs_larvae_hindcast'))
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_nrslarvae_month_t <- (summary(nrs_larvae_base_t)$scale - 
                         summary(nrslarvae_gams_t[[1]][[2]])$scale) / summary(nrs_larvae_base_t)$scale
var_ratio_nrslarvae_month_t #0.35

var_ratio_nrslarvae_space_t <- (summary(nrs_larvae_base_t)$scale - 
                         summary(nrslarvae_gams_t[[1]][[3]])$scale) / summary(nrs_larvae_base_t)$scale
var_ratio_nrslarvae_space_t #0.41
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
nrslarvae_grids_t <- threepanel_base_mse(nrs_larvae, nrs_larvae_base_t)
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(nrs_larvae, nrslarvae_grids_t, ratio_nrslarvae_geography_t,
                 var_ratio_nrslarvae_space_t,
                 ratio_nrslarvae_phenology_t,
                 var_ratio_nrslarvae_month_t)
dev.copy(jpeg,
         here('results/flathead_hindcast', 
              'flathead_larvae_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs
```{r}
nrslarvae_vcgrids_t <- vc_grids_presentation(nrs_larvae, nrslarvae_gams_t)
```

Create three panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
jet.colors <- colorRampPalette(rev(c("#FFFFCC", "#FBF2A8", "#F9E585",
                                     "#F5D363", "#EFBA55", "#EAA352",
                                     "#E68C51", "#E0754F", "#D75C4D",
                                     "#BB4A48", "#994240", "#763931", 
                                     "#542D20", "#352311", "#191900")))

par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc_presentation(nrs_larvae, nrslarvae_gams_t[[2]], nrslarvae_vcgrids_t)
legend(140,
       0.5,
       legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
       lty = 1,
       bty = 'n',
       lwd = 2,
       cex = 1.2)
dev.copy(jpeg,
         here('results/flathead_hindcast',
         'flathead_larvae_vc_t.jpg'),
         height = 3.5,
         width = 10,
         res = 200,
         units = 'in')
dev.off()
```

```{r}
tiff(here('results/flathead_hindcast/outputs',
         'flathead_larvae_output.jpg'),
     units = "in",
     width = 40,
     height = 12,
     res = 200)

par(mfrow = c(1, 3),
    mar = c(11, 15, .5, 0.6) + 0.1,
    oma = c(3, 1, 1, 1),
    mgp = c(9, 4, 0))
plot_variable(nrslarvae_gams_t,
              covariate = 2,
              bounds = c(-5, 2),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(nrslarvae_gams_t,
              covariate = 4,
              bounds = c(-5, 2),
              "Temperature",
              " ",
              "n")
plot_variable(nrslarvae_gams_t,
              covariate = 5,
              bounds = c(-5, 2),
              "Salinity",
              " ",
              "n")
dev.off()
```

```{r}
pred_nrslarvae_t <- variable_coefficient(nrslarvae_gams_t, nrs_larvae)

jet.colors <- colorRampPalette(alpha = TRUE,
                               c(sequential_hcl(alpha = 0.8, 15, palette = "Mint")))

plot_var_coef(nrslarvae_gams_t, nrs_larvae, pred_nrslarvae_t)
dev.copy(jpeg, here('results/flathead_hindcast', 'nrslarvae_var_coef.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

## Yellowfin Sole
```{r}
yfs_egg_base_t <- formula_base(yfs_egg)
summary(yfs_egg_base_t)
AIC(yfs_egg_base_t)

yfs_larvae_base_t <- formula_base(yfs_larvae)
summary(yfs_larvae_base_t)
AIC(yfs_larvae_base_t) # 10360, 48.3&
```

#### Eggs

Models with flexible phenology or geography 
Note variable coefficient by year for each
This takes forever to run, don't do unless necessary to recreate figure
```{r}
yfs_egg_phenology_t <- formula_base_pheno(yfs_egg)
summary(yfs_egg_phenology_t)
AIC(yfs_egg_phenology_t)

yfs_egg_geography_t <- formula_base_geog(yfs_egg)
summary(yfs_egg_geography_t)
AIC(yfs_egg_geography_t)
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_yfsegg_phenology_t <- (summary(yfs_egg_base_t)$scale - 
                      summary(yfs_egg_phenology_t)$scale) / summary(yfs_egg_base_t)$scale
ratio_yfsegg_phenology_t # 0.13

ratio_yfsegg_geography_t <- (summary(yfs_egg_base_t)$scale - 
                      summary(yfs_egg_geography_t)$scale) / summary(yfs_egg_base_t)$scale
ratio_yfsegg_geography_t #0.18
```

Add ROMS mean temperatures Use a representative area with averaged values from Feb - April for each year This can then be matched to the egg/larvae data for use in variable coefficient by SST instead of year as above


Determine best GAM from 7 formulations (see function)
```{r}
yfsegg_gams_t <- gam_selection(yfs_egg)
AIC(yfsegg_gams_t[[1]][[1]]) # 544
AIC(yfsegg_gams_t[[1]][[2]]) # 523
AIC(yfsegg_gams_t[[1]][[3]]) # 531
summary(yfsegg_gams_t[[2]]) # best model is phenology VC, doy not significant though?
AIC(yfsegg_gams_t[[1]][[2]]) - AIC(yfsegg_gams_t[[2]]) # 0
```

Plot best model for phenology
```{r}
# Best model by AIC is model 1
par(mfrow = c(2, 2))
plot(yfsegg_gams_t[[1]][[2]], select = 1, main = "DOY")
plot(yfsegg_gams_t[[1]][[2]], select = 3, main = "Temperature")
plot(yfsegg_gams_t[[1]][[2]], select = 4, main = "Salinity")
plot(yfsegg_gams_t[[1]][[2]], select = 5, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/yellowfin_hindcast', 'yellowfin_egg_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(yfsegg_gams_t[[1]][[2]])
dev.copy(jpeg, here('results/yellowfin_hindcast', 'yellowfin_egg_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(yfsegg_gams_t[[1]][[3]], select = 1, main = "DOY")
plot(yfsegg_gams_t[[1]][[3]], select = 3, main = "Temperature")
plot(yfsegg_gams_t[[1]][[3]], select = 4, main = "Salinity")
plot(yfsegg_gams_t[[1]][[3]], select = 5, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/yellowfin_hindcast', 'yellowfin_egg_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(yfsegg_gams_t[[1]][[3]])
dev.copy(jpeg, here('results/yellowfin_hindcast', 'yellowfin_egg_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_yfsegg_month_t <- (summary(yfs_egg_base_t)$scale - 
                         summary(yfsegg_gams_t[[1]][[2]])$scale) / summary(yfs_egg_base_t)$scale
var_ratio_yfsegg_month_t #0.20

var_ratio_yfsegg_space_t <- (summary(yfs_egg_base_t)$scale - 
                         summary(yfsegg_gams_t[[1]][[3]])$scale) / summary(yfs_egg_base_t)$scale
var_ratio_yfsegg_space_t #0.20
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
yfsegg_grids_t <- threepanel_base_mse(yfs_egg, yfs_egg_base_t)
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(yfs_egg, yfsegg_grids_t, ratio_yfsegg_geography_t,
                 var_ratio_yfsegg_space_t,
                 ratio_yfsegg_phenology_t,
                 var_ratio_yfsegg_month_t)
dev.copy(jpeg,
         here('results/yellowfin_hindcast', 
              'yellowfin_egg_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs
```{r}
yfsegg_vcgrids_t <- vc_grids_presentation(yfs_egg, yfsegg_gams_t)
```

Create three panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
jet.colors <- colorRampPalette(rev(c("#FFFFCC", "#FBF2A8", "#F9E585",
                                     "#F5D363", "#EFBA55", "#EAA352",
                                     "#E68C51", "#E0754F", "#D75C4D",
                                     "#BB4A48", "#994240", "#763931", 
                                     "#542D20", "#352311", "#191900")))

par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc_presentation(yfs_egg, yfsegg_gams_t[[1]][[2]], yfsegg_vcgrids_t)
legend(240,
       -0.5,
       legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
       lty = 1,
       bty = 'n',
       lwd = 2,
       cex = 1.2)
dev.copy(jpeg,
         here('results/yellowfin_hindcast',
         'yellowfin_egg_vc_t.jpg'),
         height = 3.5,
         width = 10,
         res = 200,
         units = 'in')
dev.off()
```

```{r}
tiff(here('results/yellowfin_hindcast/outputs',
         'yellowfin_egg_output.jpg'),
     units = "in",
     width = 40,
     height = 12,
     res = 200)

par(mfrow = c(1, 3),
    mar = c(11, 15, .5, 0.6) + 0.1,
    oma = c(3, 1, 1, 1),
    mgp = c(9, 4, 0))
plot_variable(yfsegg_gams_t,
              covariate = 2,
              bounds = c(-3, 3),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(yfsegg_gams_t,
              covariate = 4,
              bounds = c(-3, 3),
              "Temperature",
              " ",
              "n")
plot_variable(yfsegg_gams_t,
              covariate = 5,
              bounds = c(-3, 3),
              "Salinity",
              " ",
              "n")

dev.off()
```

#### Larvae

Models with flexible phenology or geography 
Note variable coefficient by year for each
```{r}
yfs_larvae_phenology_t <- formula_base_pheno(yfs_larvae)
summary(yfs_larvae_phenology_t)
AIC(yfs_larvae_phenology_t)

yfs_larvae_geography_t <- formula_base_geog(yfs_larvae)
summary(yfs_larvae_geography_t)
AIC(yfs_larvae_geography_t)
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_yfslarvae_phenology_t <- (summary(yfs_larvae_base_t)$scale - 
                      summary(yfs_larvae_phenology_t)$scale) / summary(yfs_larvae_base_t)$scale
ratio_yfslarvae_phenology_t # 0.01

ratio_yfslarvae_geography_t <- (summary(yfs_larvae_base_t)$scale - 
                      summary(yfs_larvae_geography_t)$scale) / summary(yfs_larvae_base_t)$scale
ratio_yfslarvae_geography_t # 0.16
```

Add ROMS mean temperatures Use a representative area with averaged values from Feb - April for each year This can then be matched to the larvae/larvae data for use in variable coefficient by SST instead of year as above

Determine best GAM from 7 formulations (see function)
```{r}
yfslarvae_gams_t <- gam_selection(yfs_larvae)
AIC(yfslarvae_gams_t[[1]][[1]]) # 10291
AIC(yfslarvae_gams_t[[1]][[2]]) # 10141
AIC(yfslarvae_gams_t[[1]][[3]]) # 10002
summary(yfslarvae_gams_t[[2]]) # best is spatial VC, keep all smooth terms
AIC(yfslarvae_gams_t[[1]][[1]]) - AIC(yfslarvae_gams_t[[2]]) # 289
summary(yfslarvae_gams_t[[1]][[1]])
summary(yfslarvae_gams_t[[1]][[2]])
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(yfslarvae_gams_t[[1]][[2]], select = 2, main = "DOY")
plot(yfslarvae_gams_t[[1]][[2]], select = 4, main = "Temperature")
plot(yfslarvae_gams_t[[1]][[2]], select = 5, main = "Salinity")
plot(yfslarvae_gams_t[[1]][[2]], select = 6, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/yellowfin_hindcast', 'yellowfin_larvae_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(yfslarvae_gams_t[[1]][[2]])
dev.copy(jpeg, here('results/yellowfin_hindcast', 'yellowfin_larvae_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(yfslarvae_gams_t[[1]][[3]], select = 2, main = "DOY")
plot(yfslarvae_gams_t[[1]][[3]], select = 4, main = "Temperature")
plot(yfslarvae_gams_t[[1]][[3]], select = 5, main = "Salinity")
plot(yfslarvae_gams_t[[1]][[3]], select = 6, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/yellowfin_hindcast', 'yellowfin_larvae_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(yfslarvae_gams_t[[1]][[3]])
dev.copy(jpeg, here('results/yellowfin_hindcast', 'yellowfin_larvae_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Create prediction grid to compare with projections
```{r}
yfs_larvae_hindcast <- hindcast_loop(1988:2014, yfs_larvae, 9, 254, yfslarvae_gams_t, roms_temps)
saveRDS(yfs_larvae_hindcast, here('data', 'yfs_larvae_hindcast'))
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_yfslarvae_month_t <- (summary(yfs_larvae_base_t)$scale - 
                         summary(yfslarvae_gams_t[[1]][[2]])$scale) / summary(yfs_larvae_base_t)$scale
var_ratio_yfslarvae_month_t #0.11

var_ratio_yfslarvae_space_t <- (summary(yfs_larvae_base_t)$scale - 
                         summary(yfslarvae_gams_t[[1]][[3]])$scale) / summary(yfs_larvae_base_t)$scale
var_ratio_yfslarvae_space_t #0.18
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
yfslarvae_grids_t <- threepanel_base_mse(yfs_larvae, yfs_larvae_base_t)
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(yfs_larvae, yfslarvae_grids_t, ratio_yfslarvae_geography_t,
                 var_ratio_yfslarvae_space_t,
                 ratio_yfslarvae_phenology_t,
                 var_ratio_yfslarvae_month_t)
dev.copy(jpeg,
         here('results/yellowfin_hindcast', 
              'yellowfin_larvae_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs
```{r}
yfslarvae_vcgrids_t <- vc_grids_presentation(yfs_larvae, yfslarvae_gams_t)
```

Create three panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
jet.colors <- colorRampPalette(rev(c("#FFFFCC", "#FBF2A8", "#F9E585",
                                     "#F5D363", "#EFBA55", "#EAA352",
                                     "#E68C51", "#E0754F", "#D75C4D",
                                     "#BB4A48", "#994240", "#763931", 
                                     "#542D20", "#352311", "#191900")))

par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc_presentation(yfs_larvae, yfslarvae_gams_t[[2]], yfslarvae_vcgrids_t)
legend(210,
       -3,
       legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
       lty = 1,
       bty = 'n',
       lwd = 2,
       cex = 1.2)
dev.copy(jpeg,
         here('results/yellowfin_hindcast',
         'yellowfin_larvae_vc_t.jpg'),
         height = 3.5,
         width = 10,
         res = 200,
         units = 'in')
dev.off()
```

```{r}
tiff(here('results/yellowfin_hindcast/outputs',
         'yellowfin_larvae_output.jpg'),
     units = "in",
     width = 40,
     height = 12,
     res = 200)

par(mfrow = c(1, 3),
    mar = c(11, 15, .5, 0.6) + 0.1,
    oma = c(3, 1, 1, 1),
    mgp = c(9, 4, 0))
plot_variable(yfslarvae_gams_t,
              covariate = 2,
              bounds = c(-3, 3),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(yfslarvae_gams_t,
              covariate = 4,
              bounds = c(-3, 3),
              "Temperature",
              " ",
              "n")
plot_variable(yfslarvae_gams_t,
              covariate = 5,
              bounds = c(-3, 3),
              "Salinity",
              " ",
              "n")

dev.off()
```

Plot variable coefficient term
```{r}
pred_yfslarvae_t <- variable_coefficient(yfslarvae_gams_t, yfs_larvae)

jet.colors <- colorRampPalette(alpha = TRUE,
                               c(sequential_hcl(alpha = 0.8, 15, palette = "Mint")))

plot_var_coef(yfslarvae_gams_t, yfs_larvae, pred_yfslarvae_t)
dev.copy(jpeg, here('results/yellowfin_hindcast', 'yfslarvae_var_coef.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

## Alaska Plaice
```{r}
akp_egg_base_t <- formula_base(akp_egg)
summary(akp_egg_base_t)
AIC(akp_egg_base_t) # 15412, 51.1%

akp_larvae_base_t <- formula_base(akp_larvae)
summary(akp_larvae_base_t)
AIC(akp_larvae_base_t) # 7441, 63.5%
```

#### Eggs

Models with flexible phenology or geography 
Note variable coefficient by year for each
This takes forever to run, don't do unless necessary to recreate figure
```{r}
akp_egg_phenology_t <- formula_base_pheno(akp_egg)
summary(akp_egg_phenology_t)
AIC(akp_egg_phenology_t)

akp_egg_geography_t <- formula_base_geog(akp_egg)
summary(akp_egg_geography_t)
AIC(akp_egg_geography_t)
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_akpegg_phenology_t <- (summary(akp_egg_base_t)$scale - 
                      summary(akp_egg_phenology_t)$scale) / summary(akp_egg_base_t)$scale
ratio_akpegg_phenology_t # 0.23

ratio_akpegg_geography_t <- (summary(akp_egg_base_t)$scale - 
                      summary(akp_egg_geography_t)$scale) / summary(akp_egg_base_t)$scale
ratio_akpegg_geography_t # 0.32
```

Add ROMS mean temperatures Use a representative area with averaged values from Feb - April for each year This can then be matched to the egg/larvae data for use in variable coefficient by SST instead of year as above


Determine best GAM from 7 formulations (see function)
```{r}
akpegg_gams_t <- gam_selection(akp_egg)
AIC(akpegg_gams_t[[1]][[1]]) # 14441
AIC(akpegg_gams_t[[1]][[2]]) # 14353
AIC(akpegg_gams_t[[1]][[3]]) # 14092
summary(akpegg_gams_t[[2]]) # best model is spatial VC, keep all terms
AIC(akpegg_gams_t[[1]][[1]]) - AIC(akpegg_gams_t[[2]]) # 349
summary(akpegg_gams_t[[1]][[1]]) 
summary(akpegg_gams_t[[1]][[2]]) 
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(akpegg_gams_t[[1]][[2]], select = 2, main = "DOY")
plot(akpegg_gams_t[[1]][[2]], select = 4, main = "Temperature")
plot(akpegg_gams_t[[1]][[2]], select = 5, main = "Salinity")
plot(akpegg_gams_t[[1]][[2]], select = 6, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/plaice_hindcast', 'plaice_egg_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(akpegg_gams_t[[1]][[2]])
dev.copy(jpeg, here('results/plaice_hindcast', 'plaice_egg_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(akpegg_gams_t[[1]][[3]], select = 2, main = "DOY")
plot(akpegg_gams_t[[1]][[3]], select = 4, main = "Temperature")
plot(akpegg_gams_t[[1]][[3]], select = 5, main = "Salinity")
plot(akpegg_gams_t[[1]][[3]], select = 6, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/plaice_hindcast', 'plaice_egg_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(akpegg_gams_t[[1]][[3]])
dev.copy(jpeg, here('results/plaice_hindcast', 'plaice_egg_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_akpegg_month_t <- (summary(akp_egg_base_t)$scale - 
                         summary(akpegg_gams_t[[1]][[2]])$scale) / summary(akp_egg_base_t)$scale
var_ratio_akpegg_month_t # 0.29

var_ratio_akpegg_space_t <- (summary(akp_egg_base_t)$scale - 
                         summary(akpegg_gams_t[[1]][[3]])$scale) / summary(akp_egg_base_t)$scale
var_ratio_akpegg_space_t # 0.35
```

Create prediction grid to compare with projections
```{r}
akp_egg_hindcast <- hindcast_loop(1988:2014, akp_egg, 5, 134, akpegg_gams_t, roms_temps)
saveRDS(akp_egg_hindcast, here('data', 'akp_egg_hindcast'))
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
akpegg_grids_t <- threepanel_base_mse(akp_egg, akp_egg_base_t)
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(akp_egg, akpegg_grids_t, ratio_akpegg_geography_t,
                 var_ratio_akpegg_space_t,
                 ratio_akpegg_phenology_t,
                 var_ratio_akpegg_month_t)
dev.copy(jpeg,
         here('results/plaice_hindcast', 
              'plaice_egg_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs
```{r}
akpegg_vcgrids_t <- vc_grids_presentation(akp_egg, akpegg_gams_t)
```

Create three panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
jet.colors <- colorRampPalette(rev(c("#FFFFCC", "#FBF2A8", "#F9E585",
                                     "#F5D363", "#EFBA55", "#EAA352",
                                     "#E68C51", "#E0754F", "#D75C4D",
                                     "#BB4A48", "#994240", "#763931", 
                                     "#542D20", "#352311", "#191900")))

par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc_presentation(akp_egg, akpegg_gams_t[[2]], akpegg_vcgrids_t)
legend(120,
       -0.5,
       legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
       lty = 1,
       bty = 'n',
       lwd = 2,
       cex = 1.2)
dev.copy(jpeg,
         here('results/plaice_hindcast',
         'plaice_egg_vc_t.jpg'),
         height = 3.5,
         width = 10,
         res = 200,
         units = 'in')
dev.off()
```

```{r}
tiff(here('results/plaice_hindcast/outputs',
         'plaice_egg_output.jpg'),
     units = "in",
     width = 40,
     height = 12,
     res = 200)

par(mfrow = c(1, 3),
    mar = c(11, 15, .5, 0.6) + 0.1,
    oma = c(3, 1, 1, 1),
    mgp = c(9, 4, 0))
plot_variable(akpegg_gams_t,
              covariate = 2,
              bounds = c(-2.5, 2.5),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(akpegg_gams_t,
              covariate = 4,
              bounds = c(-2.5, 2.5),
              "Temperature",
              " ",
              "n")
plot_variable(akpegg_gams_t,
              covariate = 5,
              bounds = c(-2.5, 2.5),
              "Salinity",
              " ",
              "n")
dev.off()
```

Plot variable coefficient term
```{r}
pred_akpegg_t <- variable_coefficient(akpegg_gams_t, akp_egg)

jet.colors <- colorRampPalette(alpha = TRUE,
                               c(sequential_hcl(alpha = 0.8, 15, palette = "Mint")))

plot_var_coef3(akpegg_gams_t, akp_egg, pred_akpegg_t)
dev.copy(jpeg, here('results/plaice_hindcast', 'akpegg_var_coef.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

#### Larvae

Models with flexible phenology or geography 
Note variable coefficient by year for each
```{r}
akp_larvae_phenology_t <- formula_base_pheno(akp_larvae)
summary(akp_larvae_phenology_t)
AIC(akp_larvae_phenology_t)

akp_larvae_geography_t <- formula_base_geog(akp_larvae)
summary(akp_larvae_geography_t)
AIC(akp_larvae_geography_t)
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_akplarvae_phenology_t <- (summary(akp_larvae_base_t)$scale - 
                      summary(akp_larvae_phenology_t)$scale) / summary(akp_larvae_base_t)$scale
ratio_akplarvae_phenology_t # 0.19

ratio_akplarvae_geography_t <- (summary(akp_larvae_base_t)$scale - 
                      summary(akp_larvae_geography_t)$scale) / summary(akp_larvae_base_t)$scale
ratio_akplarvae_geography_t # 0.25
```

Add ROMS mean temperatures Use a representative area with averaged values from Feb - April for each year This can then be matched to the larvae/larvae data for use in variable coefficient by SST instead of year as above

Determine best GAM from 7 formulations (see function)
```{r}
akplarvae_gams_t <- gam_selection(akp_larvae)
AIC(akplarvae_gams_t[[1]][[1]]) # 7064
AIC(akplarvae_gams_t[[1]][[2]]) # 6721
AIC(akplarvae_gams_t[[1]][[3]]) # 6655
summary(akplarvae_gams_t[[2]]) # best is spatial VC
AIC(akplarvae_gams_t[[1]][[1]]) - AIC(akplarvae_gams_t[[2]]) # 409
summary(akplarvae_gams_t[[1]][[1]])
summary(akplarvae_gams_t[[1]][[2]])
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(akplarvae_gams_t[[1]][[2]], select = 2, main = "DOY")
plot(akplarvae_gams_t[[1]][[2]], select = 4, main = "Temperature")
plot(akplarvae_gams_t[[1]][[2]], select = 5, main = "Salinity")
plot(akplarvae_gams_t[[1]][[2]], select = 6, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/plaice_hindcast', 'plaice_larvae_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(akplarvae_gams_t[[1]][[2]])
dev.copy(jpeg, here('results/plaice_hindcast', 'plaice_larvae_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(akplarvae_gams_t[[1]][[3]], select = 2, main = "DOY")
plot(akplarvae_gams_t[[1]][[3]], select = 4, main = "Temperature")
plot(akplarvae_gams_t[[1]][[3]], select = 5, main = "Salinity")
plot(akplarvae_gams_t[[1]][[3]], select = 6, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/plaice_hindcast', 'plaice_larvae_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(akplarvae_gams_t[[1]][[3]])
dev.copy(jpeg, here('results/plaice_hindcast', 'plaice_larvae_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_akplarvae_month_t <- (summary(akp_larvae_base_t)$scale - 
                         summary(akplarvae_gams_t[[1]][[2]])$scale) / summary(akp_larvae_base_t)$scale
var_ratio_akplarvae_month_t # 0.29

var_ratio_akplarvae_space_t <- (summary(akp_larvae_base_t)$scale - 
                         summary(akplarvae_gams_t[[1]][[3]])$scale) / summary(akp_larvae_base_t)$scale
var_ratio_akplarvae_space_t # 0.32
```

Create prediction grid to compare with projections
```{r}
akp_larvae_hindcast <- hindcast_loop(1988:2014, akp_larvae, 5, 140, akplarvae_gams_t, roms_temps)
saveRDS(akp_larvae_hindcast, here('data', 'akp_larvae_hindcast'))
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
akplarvae_grids_t <- threepanel_base_mse(akp_larvae, akp_larvae_base_t)
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(akp_larvae, akplarvae_grids_t, ratio_akplarvae_geography_t,
                 var_ratio_akplarvae_space_t,
                 ratio_akplarvae_phenology_t,
                 var_ratio_akplarvae_month_t)
dev.copy(jpeg,
         here('results/plaice_hindcast', 
              'plaice_larvae_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs
```{r}
akplarvae_vcgrids_t <- vc_grids_presentation(akp_larvae, akplarvae_gams_t)
```

Create three panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
jet.colors <- colorRampPalette(rev(c("#FFFFCC", "#FBF2A8", "#F9E585",
                                     "#F5D363", "#EFBA55", "#EAA352",
                                     "#E68C51", "#E0754F", "#D75C4D",
                                     "#BB4A48", "#994240", "#763931", 
                                     "#542D20", "#352311", "#191900")))

par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc_presentation(akp_larvae, akplarvae_gams_t[[2]], akplarvae_vcgrids_t)
legend(112,
       1,
       legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
       lty = 1,
       bty = 'n',
       lwd = 2,
       cex = 1.2)
dev.copy(jpeg,
         here('results/plaice_hindcast',
         'plaice_larvae_vc_t.jpg'),
         height = 3.5,
         width = 10,
         res = 200,
         units = 'in')
dev.off()
```

```{r}
tiff(here('results/plaice_hindcast/outputs',
         'plaice_larvae_output.jpg'),
     units = "in",
     width = 40,
     height = 12,
     res = 200)
par(mfrow = c(1, 3),
    mar = c(11, 15, .5, 0.6) + 0.1,
    oma = c(3, 1, 1, 1),
    mgp = c(9, 4, 0))
plot_variable(akplarvae_gams_t,
              covariate = 2,
              bounds = c(-2.5, 2.5),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(akplarvae_gams_t,
              covariate = 4,
              bounds = c(-2.5, 2.5),
              "Temperature",
              " ",
              "n")
plot_variable(akplarvae_gams_t,
              covariate = 5,
              bounds = c(-2.5, 2.5),
              "Salinity",
              " ",
              "n")
dev.off()
```

Plot variable coefficient term
```{r}
pred_akplarvae_t <- variable_coefficient(akplarvae_gams_t, akp_larvae)

jet.colors <- colorRampPalette(alpha = TRUE,
                               c(sequential_hcl(alpha = 0.8, 15, palette = "Mint")))

plot_var_coef2(akplarvae_gams_t, akp_larvae, pred_akplarvae_t)
dev.copy(jpeg, here('results/plaice_hindcast', 'akplarvae_var_coef.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

## Pacific Cod
```{r}
pcod_larvae_base_t <- formula_base(pcod_larvae)
summary(pcod_larvae_base_t)
AIC(pcod_larvae_base_t) # 9004, 48.5%
```

#### Larvae

Models with flexible phenology or geography 
Note variable coefficient by year for each
```{r}
pcod_larvae_phenology_t <- formula_base_pheno(pcod_larvae)
summary(pcod_larvae_phenology_t)
AIC(pcod_larvae_phenology_t)

pcod_larvae_geography_t <- formula_base_geog(pcod_larvae)
summary(pcod_larvae_geography_t)
AIC(pcod_larvae_geography_t)
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_pcodlarvae_phenology_t <- (summary(pcod_larvae_base_t)$scale - 
                      summary(pcod_larvae_phenology_t)$scale) / summary(pcod_larvae_base_t)$scale
ratio_pcodlarvae_phenology_t # 0.10

ratio_pcodlarvae_geography_t <- (summary(pcod_larvae_base_t)$scale - 
                      summary(pcod_larvae_geography_t)$scale) / summary(pcod_larvae_base_t)$scale
ratio_pcodlarvae_geography_t # 0.10
```

Add ROMS mean temperatures Use a representative area with averaged values from Feb - April for each year This can then be matched to the larvae/larvae data for use in variable coefficient by SST instead of year as above

Determine best GAM from 7 formulations (see function)
```{r}
pcodlarvae_gams_t <- gam_selection(pcod_larvae)
AIC(pcodlarvae_gams_t[[1]][[1]]) # 8883
AIC(pcodlarvae_gams_t[[1]][[2]]) # 8685
AIC(pcodlarvae_gams_t[[1]][[3]]) # 8704
summary(pcodlarvae_gams_t[[2]]) # best is temporal VC
AIC(pcodlarvae_gams_t[[1]][[1]]) - AIC(pcodlarvae_gams_t[[2]]) # 198
summary(pcodlarvae_gams_t[[1]][[1]])
summary(pcodlarvae_gams_t[[1]][[3]])
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(pcodlarvae_gams_t[[1]][[2]], select = 2, main = "DOY")
plot(pcodlarvae_gams_t[[1]][[2]], select = 4, main = "Temperature")
plot(pcodlarvae_gams_t[[1]][[2]], select = 5, main = "Salinity")
plot(pcodlarvae_gams_t[[1]][[2]], select = 6, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/cod_hindcast', 'cod_larvae_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pcodlarvae_gams_t[[1]][[2]])
dev.copy(jpeg, here('results/cod_hindcast', 'cod_larvae_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(pcodlarvae_gams_t[[1]][[3]], select = 2, main = "DOY")
plot(pcodlarvae_gams_t[[1]][[3]], select = 4, main = "Temperature")
plot(pcodlarvae_gams_t[[1]][[3]], select = 5, main = "Salinity")
plot(pcodlarvae_gams_t[[1]][[3]], select = 6, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/cod_hindcast', 'cod_larvae_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pcodlarvae_gams_t[[1]][[3]])
dev.copy(jpeg, here('results/cod_hindcast', 'cod_larvae_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_pcodlarvae_month_t <- (summary(pcod_larvae_base_t)$scale - 
                         summary(pcodlarvae_gams_t[[1]][[2]])$scale) / summary(pcod_larvae_base_t)$scale
var_ratio_pcodlarvae_month_t # 0.12

var_ratio_pcodlarvae_space_t <- (summary(pcod_larvae_base_t)$scale - 
                         summary(pcodlarvae_gams_t[[1]][[3]])$scale) / summary(pcod_larvae_base_t)$scale
var_ratio_pcodlarvae_space_t #  0.12
```

Create prediction grid to compare with projections
```{r}
pcod_larvae_hindcast <- hindcast_loop(1988:2014, pcod_larvae, 5, 134, pcodlarvae_gams_t, roms_temps)
saveRDS(pcod_larvae_hindcast, here('data', 'pcod_larvae_hindcast'))
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
pcodlarvae_grids_t <- threepanel_base_mse(pcod_larvae, pcod_larvae_base_t)
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(pcod_larvae, pcodlarvae_grids_t, ratio_pcodlarvae_geography_t,
                 var_ratio_pcodlarvae_space_t,
                 ratio_pcodlarvae_phenology_t,
                 var_ratio_pcodlarvae_month_t)
dev.copy(jpeg,
         here('results/cod_hindcast', 
              'cod_larvae_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs
```{r}
pcodlarvae_vcgrids_t <- vc_grids_presentation(pcod_larvae, pcodlarvae_gams_t)
```

Create three panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
jet.colors <- colorRampPalette(rev(c("#FFFFCC", "#FBF2A8", "#F9E585",
                                     "#F5D363", "#EFBA55", "#EAA352",
                                     "#E68C51", "#E0754F", "#D75C4D",
                                     "#BB4A48", "#994240", "#763931", 
                                     "#542D20", "#352311", "#191900")))

par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc_presentation(pcod_larvae, pcodlarvae_gams_t[[2]], pcodlarvae_vcgrids_t)
legend(100,
       -1,
       legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
       lty = 1,
       bty = 'n',
       lwd = 2,
       cex = 1.2)
dev.copy(jpeg,
         here('results/cod_hindcast',
         'cod_larvae_vc_t.jpg'),
         height = 3.5,
         width = 10,
         res = 200,
         units = 'in')
dev.off()
```

```{r}
tiff(here('results/cod_hindcast/outputs',
         'cod_larvae_output.jpg'),
     units = "in",
     width = 52,
     height = 12,
     res = 200)

par(mfrow = c(1, 4),
    mar = c(11, 15, .5, 0.6) + 0.1,
    oma = c(3, 1, 1, 1),
    mgp = c(9, 4, 0))
plot_variable(pcodlarvae_gams_t,
              covariate = 2,
              bounds = c(-4, 3.5),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(pcodlarvae_gams_t,
              covariate = 4,
              bounds = c(-4, 3.5),
              "Temperature",
              " ",
              "n")
plot_variable(pcodlarvae_gams_t,
              covariate = 5,
              bounds = c(-4, 3.5),
              "Salinity",
              " ",
              "n")
plot_variable(pcodlarvae_gams_t,
              covariate = 6,
              bounds = c(-4, 3.5),
              "Day of Year",
              " ",
              "n")
dev.off()
```

## Northern Rock Sole
```{r}
nrs_larvae_base_t <- formula_base(nrs_larvae)
summary(nrs_larvae_base_t)
AIC(nrs_larvae_base_t) # 15812, 43.9%
```

#### Larvae

Models with flexible phenology or geography 
Note variable coefficient by year for each
```{r}
nrs_larvae_phenology_t <- formula_base_pheno(nrs_larvae)
summary(nrs_larvae_phenology_t)
AIC(nrs_larvae_phenology_t)

nrs_larvae_geography_t <- formula_base_geog(nrs_larvae)
summary(nrs_larvae_geography_t)
AIC(nrs_larvae_geography_t)
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_nrslarvae_phenology_t <- (summary(nrs_larvae_base_t)$scale - 
                      summary(nrs_larvae_phenology_t)$scale) / summary(nrs_larvae_base_t)$scale
ratio_nrslarvae_phenology_t # 0.03

ratio_nrslarvae_geography_t <- (summary(nrs_larvae_base_t)$scale - 
                      summary(nrs_larvae_geography_t)$scale) / summary(nrs_larvae_base_t)$scale
ratio_nrslarvae_geography_t # 0.06
```

Add ROMS mean temperatures Use a representative area with averaged values from Feb - April for each year This can then be matched to the larvae/larvae data for use in variable coefficient by SST instead of year as above

Determine best GAM from 7 formulations (see function)
```{r}
nrslarvae_gams_t <- gam_selection(nrs_larvae)
AIC(nrslarvae_gams_t[[1]][[1]]) # 15558
AIC(nrslarvae_gams_t[[1]][[2]]) # 15443
AIC(nrslarvae_gams_t[[1]][[3]]) # 15397
summary(nrslarvae_gams_t[[2]]) # best is spatial VC
AIC(nrslarvae_gams_t[[1]][[1]]) - AIC(nrslarvae_gams_t[[2]]) # 161
summary(nrslarvae_gams_t[[1]][[1]])
summary(nrslarvae_gams_t[[1]][[2]])
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(nrslarvae_gams_t[[1]][[2]], select = 2, main = "DOY")
plot(nrslarvae_gams_t[[1]][[2]], select = 4, main = "Temperature")
plot(nrslarvae_gams_t[[1]][[2]], select = 5, main = "Salinity")
plot(nrslarvae_gams_t[[1]][[2]], select = 6, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/rocksole_hindcast', 'rocksole_larvae_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(nrslarvae_gams_t[[1]][[2]])
dev.copy(jpeg, here('results/rocksole_hindcast', 'rocksole_larvae_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(nrslarvae_gams_t[[1]][[3]], select = 2, main = "DOY")
plot(nrslarvae_gams_t[[1]][[3]], select = 4, main = "Temperature")
plot(nrslarvae_gams_t[[1]][[3]], select = 5, main = "Salinity")
plot(nrslarvae_gams_t[[1]][[3]], select = 6, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/rocksole_hindcast', 'rocksole_larvae_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(nrslarvae_gams_t[[1]][[3]])
dev.copy(jpeg, here('results/rocksole_hindcast', 'rocksole_larvae_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Create prediction grid to compare with projections
```{r}
nrs_larvae_hindcast <- hindcast_loop(1988:2014, nrs_larvae, 5, 134, nrslarvae_gams_t, roms_temps)
saveRDS(nrs_larvae_hindcast, here('data', 'nrs_larvae_hindcast'))
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_nrslarvae_month_t <- (summary(nrs_larvae_base_t)$scale - 
                         summary(nrslarvae_gams_t[[1]][[2]])$scale) / summary(nrs_larvae_base_t)$scale
var_ratio_nrslarvae_month_t # 0.11

var_ratio_nrslarvae_space_t <- (summary(nrs_larvae_base_t)$scale - 
                         summary(nrslarvae_gams_t[[1]][[3]])$scale) / summary(nrs_larvae_base_t)$scale
var_ratio_nrslarvae_space_t # 0.13
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
nrslarvae_grids_t <- threepanel_base_mse(nrs_larvae, nrs_larvae_base_t)
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(nrs_larvae, nrslarvae_grids_t, ratio_nrslarvae_geography_t,
                 var_ratio_nrslarvae_space_t,
                 ratio_nrslarvae_phenology_t,
                 var_ratio_nrslarvae_month_t)
dev.copy(jpeg,
         here('results/rocksole_hindcast', 
              'rocksole_larvae_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs
```{r}
nrslarvae_vcgrids_t <- vc_grids_presentation(nrs_larvae, nrslarvae_gams_t)
```

Create three panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
jet.colors <- colorRampPalette(rev(c("#FFFFCC", "#FBF2A8", "#F9E585",
                                     "#F5D363", "#EFBA55", "#EAA352",
                                     "#E68C51", "#E0754F", "#D75C4D",
                                     "#BB4A48", "#994240", "#763931", 
                                     "#542D20", "#352311", "#191900")))

par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc_presentation(nrs_larvae, nrslarvae_gams_t[[2]], nrslarvae_vcgrids_t)
legend(100,
       2,
       legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
       lty = 1,
       bty = 'n',
       lwd = 2,
       cex = 1.2)
dev.copy(jpeg,
         here('results/rocksole_hindcast',
         'rocksole_larvae_vc_t.jpg'),
         height = 3.5,
         width = 10,
         res = 200,
         units = 'in')
dev.off()
```

```{r}
tiff(here('results/rocksole_hindcast/outputs',
         'rocksole_larvae_output.jpg'),
     units = "in",
     width = 40,
     height = 12,
     res = 200)

par(mfrow = c(1, 3),
    mar = c(11, 15, .5, 0.6) + 0.1,
    oma = c(3, 1, 1, 1),
    mgp = c(9, 4, 0))
plot_variable(nrslarvae_gams_t,
              covariate = 2,
              bounds = c(-4, 2),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(nrslarvae_gams_t,
              covariate = 4,
              bounds = c(-4, 2),
              "Temperature",
              " ",
              "n")
plot_variable(nrslarvae_gams_t,
              covariate = 5,
              bounds = c(-4, 2),
              "Salinity",
              " ",
              "n")
dev.off()
```

Plot variable coefficient term
```{r}
pred_nrslarvae_t <- variable_coefficient(nrslarvae_gams_t, nrs_larvae)

jet.colors <- colorRampPalette(alpha = TRUE,
                               c(sequential_hcl(alpha = 0.8, 15, palette = "Mint")))

plot_var_coef(nrslarvae_gams_t, nrs_larvae, pred_nrslarvae_t)
dev.copy(jpeg, here('results/rocksole_hindcast', 'nrslarvae_var_coef.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

## GAM multipanel figures
```{r}
# Figure containing location or doy by mean sst
tiff(here('results',
          'hindcast_output.jpg'),
     units = "in",
     width = 65,
     height = 90,
     res = 300)
par(mfrow = c(9, 5),
    mar = c(11, 15, 5, 1.5) + 0.1,
    oma = c(3, 35, 15, 1),
    mgp = c(10, 4, 0),
    family = "serif")
plot_variable(pkegg_gams_t,
              covariate = 2,
              bounds = c(-6.5, 9),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(pkegg_gams_t,
              covariate = 4,
              bounds = c(-6.5, 9),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot(0, xaxt = "n", yaxt = "n", bty = "n", pch = "", ylab = "", xlab = "")
plot(0, xaxt = "n", yaxt = "n", bty = "n", pch = "", ylab = "", xlab = "")
location_plot(pkegg_gams_t,
              pk_egg)
plot_variable(pklarvae_gams_t,
              covariate = 2,
              bounds = c(-6.5, 9),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(pklarvae_gams_t,
              covariate = 4,
              bounds = c(-6.5, 9),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(pklarvae_gams_t,
              covariate = 5,
              bounds = c(-6.5, 9),
              "Salinity",
              " ",
              "n")
plot(0, xaxt = "n", yaxt = "n", bty = "n", pch = "", ylab = "", xlab = "")
location_plot(pklarvae_gams_t,
              pk_larvae)
plot_variable(nrsegg_gams_t,
              covariate = 2,
              bounds = c(-5, 2),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(nrsegg_gams_t,
              covariate = 4,
              bounds = c(-5, 2),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(nrsegg_gams_t,
              covariate = 5,
              bounds = c(-5, 2),
              "Salinity",
              " ",
              "n")
plot(0, xaxt = "n", yaxt = "n", bty = "n", pch = "", ylab = "", xlab = "")
location_plot(nrsegg_gams_t,
              nrs_egg)
plot_variable(nrslarvae_gams_t,
              covariate = 2,
              bounds = c(-5, 2),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(nrslarvae_gams_t,
              covariate = 4,
              bounds = c(-5, 2),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(nrslarvae_gams_t,
              covariate = 5,
              bounds = c(-5, 2),
              "Salinity",
              " ",
              "n")
plot(0, xaxt = "n", yaxt = "n", bty = "n", pch = "", ylab = "", xlab = "")
location_plot(nrslarvae_gams_t,
              nrs_larvae)
plot_variable(akpegg_gams_t,
              covariate = 2,
              bounds = c(-2.5, 2.5),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(akpegg_gams_t,
              covariate = 4,
              bounds = c(-2.5, 2.5),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(akpegg_gams_t,
              covariate = 5,
              bounds = c(-2.5, 2.5),
              "Salinity",
              " ",
              "n")
plot(0, xaxt = "n", yaxt = "n", bty = "n", pch = "", ylab = "", xlab = "")
location_plot(akpegg_gams_t,
              akp_egg)
plot_variable(akplarvae_gams_t,
              covariate = 2,
              bounds = c(-2.5, 2.5),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(akplarvae_gams_t,
              covariate = 4,
              bounds = c(-2.5, 2.5),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(akplarvae_gams_t,
              covariate = 5,
              bounds = c(-2.5, 2.5),
              "Salinity",
              " ",
              "n")
plot(0, xaxt = "n", yaxt = "n", bty = "n", pch = "", ylab = "", xlab = "")
location_plot(akplarvae_gams_t,
              akp_larvae)
plot_variable(yfslarvae_gams_t,
              covariate = 2,
              bounds = c(-3, 3),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(yfslarvae_gams_t,
              covariate = 4,
              bounds = c(-3, 3),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(yfslarvae_gams_t,
              covariate = 5,
              bounds = c(-3, 3),
              "Salinity",
              " ",
              "n")
plot(0, xaxt = "n", yaxt = "n", bty = "n", pch = "", ylab = "", xlab = "")
location_plot(yfslarvae_gams_t,
              yfs_larvae)
plot_variable(pcodlarvae_gams_t,
              covariate = 2,
              bounds = c(-4, 3.5),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(pcodlarvae_gams_t,
              covariate = 4,
              bounds = c(-4, 3.5),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(pcodlarvae_gams_t,
              covariate = 5,
              bounds = c(-4, 3.5),
              "Salinity",
              " ",
              "n")
plot_variable(pcodlarvae_gams_t,
              covariate = 6,
              bounds = c(-4, 3.5),
              "Day of Year",
              " ",
              "n")
location_plot(pcodlarvae_gams_t,
              pcod_larvae)
plot_variable(nrslarvae_gams_t,
              covariate = 2,
              bounds = c(-4, 2),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(nrslarvae_gams_t,
              covariate = 4,
              bounds = c(-4, 2),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(nrslarvae_gams_t,
              covariate = 5,
              bounds = c(-4, 2),
              "Salinity",
              " ",
              "n")
plot(0, xaxt = "n", yaxt = "n", bty = "n", pch = "", ylab = "", xlab = "")
location_plot(nrslarvae_gams_t,
              nrs_larvae)
mtext("Walleye Pollock", 
      side = 2, 
      line = 25, 
      outer = TRUE, 
      cex = 7,
      at = 0.89)
mtext("Flathead Sole", 
      side = 2, 
      line = 25, 
      outer = TRUE, 
      cex = 7,
      at = 0.67)
mtext("Alaska Plaice", 
      side = 2, 
      line = 25, 
      outer = TRUE, 
      cex = 7,
      at = 0.45)
mtext("Yellowfin Sole", 
      side = 2, 
      line = 25, 
      outer = TRUE, 
      cex = 7,
      at = 0.28)
mtext("Pacific Cod", 
      side = 2, 
      line = 25, 
      outer = TRUE, 
      cex = 7,
      at = 0.17)
mtext("Northern Rock Sole", 
      side = 2, 
      line = 25, 
      outer = TRUE, 
      cex = 7,
      at = 0.06)
mtext("Day of Year", 
      side = 3, 
      line = 2, 
      outer = TRUE, 
      cex = 7,
      at = 0.11)
mtext("Temperature", 
      side = 3, 
      line = 2, 
      outer = TRUE, 
      cex = 7,
      at = 0.31)
mtext("Salinity", 
      side = 3, 
      line = 2, 
      outer = TRUE, 
      cex = 7,
      at = 0.51)
mtext("Day of Year \n by Mean SST",
      side = 3,
      line = -1.8,
      outer = TRUE,
      cex = 7,
      at = 0.71)
mtext("Location",
      side = 3,
      line = 2,
      outer = TRUE,
      cex = 7,
      at = 0.91)
mtext("Eggs", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.95)
mtext("Larvae", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.84)
mtext("Eggs", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.73)
mtext("Larvae", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.62)
mtext("Eggs", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.51)
mtext("Larvae", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.40)
mtext("Larvae", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.28)
mtext("Larvae", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.17)
mtext("Larvae", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.06)
dev.off()
```


```{r}
# Figure containing 
tiff(here('results',
          'hindcast_output2.jpg'),
     units = "in",
     width = 65,
     height = 90,
     res = 300)
par(mfrow = c(9, 5),
    mar = c(11, 15, 5, 1.5) + 0.1,
    oma = c(3, 35, 15, 1),
    mgp = c(10, 4, 0),
    family = "serif")
plot_variable(pkegg_gams_t,
              covariate = 2,
              bounds = c(-6.5, 9),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(pkegg_gams_t,
              covariate = 4,
              bounds = c(-6.5, 9),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot(0, xaxt = "n", yaxt = "n", bty = "n", pch = "", ylab = "", xlab = "")
phenology_change(pkegg_vcgrids_t)
distribution_change(pk_egg,
                    pkegg_vcgrids_t)
plot_variable(pklarvae_gams_t,
              covariate = 2,
              bounds = c(-6.5, 9),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(pklarvae_gams_t,
              covariate = 4,
              bounds = c(-6.5, 9),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(pklarvae_gams_t,
              covariate = 5,
              bounds = c(-6.5, 9),
              "Salinity",
              " ",
              "n")
phenology_change(pklarvae_vcgrids_t)
distribution_change(pk_larvae,
                    pklarvae_vcgrids_t)
plot_variable(nrsegg_gams_t,
              covariate = 2,
              bounds = c(-5, 2),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(nrsegg_gams_t,
              covariate = 4,
              bounds = c(-5, 2),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(nrsegg_gams_t,
              covariate = 5,
              bounds = c(-5, 2),
              "Salinity",
              " ",
              "n")
phenology_change(nrsegg_vcgrids_t)
distribution_change(nrs_egg,
                    nrsegg_vcgrids_t)
plot_variable(nrslarvae_gams_t,
              covariate = 2,
              bounds = c(-5, 2),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(nrslarvae_gams_t,
              covariate = 4,
              bounds = c(-5, 2),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(nrslarvae_gams_t,
              covariate = 5,
              bounds = c(-5, 2),
              "Salinity",
              " ",
              "n")
phenology_change(nrslarvae_vcgrids_t)
distribution_change(nrs_larvae,
                    nrslarvae_vcgrids_t)
plot_variable(akpegg_gams_t,
              covariate = 2,
              bounds = c(-2.5, 2.5),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(akpegg_gams_t,
              covariate = 4,
              bounds = c(-2.5, 2.5),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(akpegg_gams_t,
              covariate = 5,
              bounds = c(-2.5, 2.5),
              "Salinity",
              " ",
              "n")
phenology_change(akpegg_vcgrids_t)
distribution_change(akp_egg,
                    akpegg_vcgrids_t)
plot_variable(akplarvae_gams_t,
              covariate = 2,
              bounds = c(-2.5, 2.5),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(akplarvae_gams_t,
              covariate = 4,
              bounds = c(-2.5, 2.5),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(akplarvae_gams_t,
              covariate = 5,
              bounds = c(-2.5, 2.5),
              "Salinity",
              " ",
              "n")
phenology_change(akplarvae_vcgrids_t)
distribution_change(akp_larvae,
                    akplarvae_vcgrids_t)
plot_variable(yfslarvae_gams_t,
              covariate = 2,
              bounds = c(-3, 3),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(yfslarvae_gams_t,
              covariate = 4,
              bounds = c(-3, 3),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(yfslarvae_gams_t,
              covariate = 5,
              bounds = c(-3, 3),
              "Salinity",
              " ",
              "n")
phenology_change(yfslarvae_vcgrids_t)
distribution_change(yfs_larvae,
                    yfslarvae_vcgrids_t)
plot_variable(pcodlarvae_gams_t,
              covariate = 2,
              bounds = c(-4, 3.5),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(pcodlarvae_gams_t,
              covariate = 4,
              bounds = c(-4, 3.5),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(pcodlarvae_gams_t,
              covariate = 5,
              bounds = c(-4, 3.5),
              "Salinity",
              " ",
              "n")
phenology_change(pcodlarvae_vcgrids_t)
distribution_change(pcod_larvae,
                    pcodlarvae_vcgrids_t)
plot_variable(nrslarvae_gams_t,
              covariate = 2,
              bounds = c(-4, 2),
              "Day of Year",
              "Species Abundance Anomalies",
              "s")
plot_variable(nrslarvae_gams_t,
              covariate = 4,
              bounds = c(-4, 2),
              expression(paste("Temperature ("^0, 'C)')),
              " ",
              "n")
plot_variable(nrslarvae_gams_t,
              covariate = 5,
              bounds = c(-4, 2),
              "Salinity",
              " ",
              "n")
phenology_change(nrslarvae_vcgrids_t)
distribution_change(nrs_larvae,
                    nrslarvae_vcgrids_t)
mtext("Walleye Pollock", 
      side = 2, 
      line = 25, 
      outer = TRUE, 
      cex = 7,
      at = 0.89)
mtext("Flathead Sole", 
      side = 2, 
      line = 25, 
      outer = TRUE, 
      cex = 7,
      at = 0.67)
mtext("Alaska Plaice", 
      side = 2, 
      line = 25, 
      outer = TRUE, 
      cex = 7,
      at = 0.45)
mtext("Yellowfin Sole", 
      side = 2, 
      line = 25, 
      outer = TRUE, 
      cex = 7,
      at = 0.28)
mtext("Pacific Cod", 
      side = 2, 
      line = 25, 
      outer = TRUE, 
      cex = 7,
      at = 0.17)
mtext("Northern Rock Sole", 
      side = 2, 
      line = 25, 
      outer = TRUE, 
      cex = 7,
      at = 0.06)
mtext("Day of Year", 
      side = 3, 
      line = 2, 
      outer = TRUE, 
      cex = 7,
      at = 0.11)
mtext("Temperature", 
      side = 3, 
      line = 2, 
      outer = TRUE, 
      cex = 7,
      at = 0.31)
mtext("Salinity", 
      side = 3, 
      line = 2, 
      outer = TRUE, 
      cex = 7,
      at = 0.51)
mtext("Phenology Change",
      side = 3,
      line = 2,
      outer = TRUE,
      cex = 7,
      at = 0.71)
mtext("Location Change",
      side = 3,
      line = 2,
      outer = TRUE,
      cex = 7,
      at = 0.91)
mtext("Eggs", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.95)
mtext("Larvae", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.84)
mtext("Eggs", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.73)
mtext("Larvae", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.62)
mtext("Eggs", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.51)
mtext("Larvae", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.40)
mtext("Larvae", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.28)
mtext("Larvae", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.17)
mtext("Larvae", 
      side = 2, 
      line = 10, 
      outer = TRUE, 
      cex = 6,
      at = 0.06)
dev.off()
```