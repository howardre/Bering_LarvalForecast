---
title: "Hindcast ROMS variables"
author: "Rebecca Howard"
date: "9/29/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(marmap)
library(maps)
library(mapdata)
library(fields)
library(here)
library(mgcv)
library(tidyr)
library(dplyr)
library(ggplot2)
library(raster)
library(rgdal)
library(viridis)
source(here('code/functions', 'vis_gam_COLORS.R'))
source(here('code/functions', 'distance_function.R'))

# Load fish data
pk_egg <- readRDS(here('data', 'pk_egg.rds'))
pk_larvae <- readRDS(here('data', 'pk_larvae.rds'))
fhs_egg <- readRDS(here('data', 'fhs_egg.rds'))
fhs_larvae <- readRDS(here('data', 'fhs_larvae.rds'))
yfs_egg <- readRDS(here('data', 'yfs_egg.rds'))
yfs_larvae <- readRDS(here('data', 'yfs_larvae.rds'))
akp_egg <- readRDS(here('data', 'akp_egg.rds'))
akp_larvae <- readRDS(here('data', 'akp_larvae.rds'))

# Load ROMS temperature means
roms_temps <- readRDS(here('data', 'roms_temps.rds'))


fhs_egg <- filter(fhs_egg, lat >= 52 & lat <= 62,
                  lon >= -176.5 & lon <= -156.5)
```

In-script functions for maps and data
```{r}
# Colors
contour_col <- rgb(0, 0, 255, max = 255, alpha = 0, names = "white")
jet.colors <- colorRampPalette(rev(c("#b2182b", "#d6604d", "#f4a582", "#fddbc7",
                                 "#f7f7f7", "#d1e5f0", "#92c5de", "#4393c3", "#2166ac")))

# Select gam
gam_selection <- function(data, roms_temps){
  data <- filter(data, lat >= 52 & lat <= 62,
                  lon >= -176.5 & lon <= -156.5)
  data$mean_temp <- roms_temps$mean[match(data$year, roms_temps$year)]
  gam_base <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                    s(doy, k = 8) +
                    s(lon, lat) +
                    s(roms_temperature, k = 6) +
                    s(roms_salinity, k = 6),
                  data = data,
                  family = tw(link = 'log'),
                  method = 'REML')
  gam_vc_phen <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6) +
                       s(doy, by = mean_temp, k = 6),
                     data = data,
                     family = tw(link = 'log'),
                     method = 'REML')
  gam_interaction <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                           s(doy, k = 8) +
                           s(lon, lat) +
                           s(roms_temperature, roms_salinity),
                         data = data,
                         family = tw(link = 'log'),
                         method = 'REML')
  gam_interaction2 <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                            s(doy, k = 8) +
                            s(lon, lat) +
                            s(roms_temperature, roms_salinity) +
                            s(roms_temperature, k = 6) +
                            s(roms_salinity, k = 6),
                          data = data,
                          family = tw(link = 'log'),
                          method = 'REML')
  gam_vc_phen2 <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                        s(doy, k = 8) +
                        s(lon, lat) +
                        s(roms_temperature, roms_salinity) +
                        s(roms_temperature) +
                        s(roms_salinity, k = 4) +
                        s(doy, by = mean_temp, k = 6),
                      data = data,
                      family = tw(link = 'log'),
                      method = 'REML')
  gam_vc_geog <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6) +
                       s(lon, lat, by = mean_temp, k = 6),
                     data = data,
                     family = tw(link = 'log'),
                     method = 'REML')
  gam_vc_geog2 <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                        s(doy, k = 8) +
                        s(lon, lat) +
                        s(roms_temperature, roms_salinity) +
                        s(roms_temperature, k = 6) +
                        s(roms_salinity, k = 6) +
                        s(lon, lat, by = mean_temp, k = 6),
                      data = data,
                      family = tw(link = 'log'),
                      method = 'REML')
  gam_list <- list(gam_base, gam_interaction, gam_interaction2, gam_vc_phen, 
                   gam_vc_phen2, gam_vc_geog, gam_vc_geog2)
  best_gam <- gam_list[[which.min(sapply(1:length(gam_list),
                                         function(x) min(gam_list[[x]]$aic)))]]
  return_list <- list(gam_list, best_gam)
}

# Function to make maps
map_phenology <- function(data, grids, ratio_base_geog,
                          vc_ratio_space, ratio_base_pheno,
                          vc_ratio_time){
  nlat = 80
  nlon = 120
  latd = seq(min(grids[[1]]$lat), max(grids[[1]]$lat), length.out = nlat)
  lond = seq(min(grids[[1]]$lon), max(grids[[1]]$lon), length.out = nlon)
  my_color = colorRampPalette(c("#1C0D51", "#4C408E", "#7E77B0",
                                "#AFABCB", "#DAD9E5", "#F9F9F9",
                                "#FFDAB7", "#FFB377","#E18811",
                                "#AC6000", "#743700"))
  color_levels = 100
  max_absolute_value = max(abs(c(min(grids[[1]]$pred, na.rm = T), max(grids[[1]]$pred, na.rm = T)))) 
  color_sequence = seq(-max_absolute_value, max_absolute_value, 
                       length.out = color_levels + 1)
  n_in_class = hist(grids[[1]]$pred, breaks = color_sequence, plot = F)$counts > 0
  col_to_include = min(which(n_in_class == T)):max(which(n_in_class == T))
  breaks_to_include = min(which(n_in_class == T)):(max(which(n_in_class == T)) + 1)
  image(lond,
        latd,
        t(matrix(grids[[1]]$pred,
                 nrow = length(latd),
                 ncol = length(lond),
                 byrow = T)),
        xlim = c(-176.5, -156.5),
        ylim = c(52, 62),
        axes = FALSE,
        xlab = "",
        ylab = "")
  rect(par("usr")[1], par("usr")[3], par("usr")[2], par("usr")[4], col = "mintcream")
  par(new = TRUE)
  image(lond,
        latd,
        t(matrix(grids[[1]]$pred,
                 nrow = length(latd),
                 ncol = length(lond),
                 byrow = T)),
        col = my_color(n = color_levels)[col_to_include], 
        breaks = color_sequence[breaks_to_include],
        ylab = "Latitude",
        xlab = "Longitude",
        xlim = c(-176.5, -156.5),
        ylim = c(52, 62),
        main = "Distribution",
        cex.main = 1.2,
        cex.lab = 1.1,
        cex.axis = 1.1)
  symbols(data$lon[data$larvalcatchper10m2 > 0],
          data$lat[data$larvalcatchper10m2 > 0],
          circles = log(data$larvalcatchper10m2 + 1)[data$larvalcatchper10m2 > 0],
          inches = 0.1,
          bg = alpha('grey', 0.1),
          fg = alpha('black', 0.05),
          add = T)
  points(data$lon[data$larvalcatchper10m2 == 0], 
         data$lat[data$larvalcatchper10m2 == 0], 
         pch = '')
  maps::map("worldHires",
            fill = T,
            col = "wheat4",
            add = T)
  image.plot(legend.only = T,
             col = my_color(n = color_levels)[col_to_include],
             legend.shrink = 0.2,
             smallplot = c(.765, .79, .25, .37),
             legend.cex = 0.4,
             axis.args = list(cex.axis = 0.8),
             legend.width = 0.5,
             legend.mar = 6,
             zlim = c(min(grids[[1]]$pred, na.rm = T), max(grids[[1]]$pred, na.rm = T)),
             legend.args = list("Predicted \n Change",
                                side = 2, cex = 0.7))
  plot(grids[[2]]$doy,
       grids[[2]]$pred,
       main = 'Phenology',
       type = 'l',
       ylab = 'Egg density ln(n/10m2)',
       xlab = 'Day of the year',
       cex.lab = 1.1,
       cex.axis = 1.1,
       cex.main = 1.2,
       xlim = c(min(grids[[2]]$doy, na.rm = T), max(grids[[2]]$doy, na.rm = T)),
       ylim = range(c(grids[[2]]$pred_up, grids[[2]]$pred_lw)),
       col = 'blue',
       lwd = 2)
  polygon(c(grids[[2]]$doy, rev(grids[[2]]$doy)),
          c(grids[[2]]$pred_lw, rev(grids[[2]]$pred_up)),
          col = alpha('gray', 0.6),
          lty = 0)
  barplot(matrix(c(ratio_base_geog,
                   vc_ratio_space,
                   ratio_base_pheno,
                   vc_ratio_time) *  100,
                 ncol = 2,
                 nrow = 2),
        ylab = 'Delta MSE (%)',
        names.arg = c('Variable distribution', 'Variable phenologies'),
        ylim = c(0, 60),
        main = 'Delta MSE',
        cex.lab = 1.1,
        cex.main = 1.2,
        cex.axis = 1.1,
        cex.names = 1.1,
        space = c(0, 1),
        beside = T,
        col = c('azure4', 'azure3'))
  box()
  legend("topright",
       legend = c('D-MSE|Year', 'D-MSE|SST'),
       bty = 'n',
       col = c('azure4', 'azure3'),
       pch = 15,
       pt.cex = 2.5,
       cex = 1.1)
}

map_vc <- function(data, gam, grids, title){
  nlat = 80
  nlon = 120
  latd = seq(min(pk_egg$lat), max(pk_egg$lat), length.out = nlat)
  lond = seq(min(pk_egg$lon), max(pk_egg$lon), length.out = nlon)
     myvis_gam(gam,
          view = c('lon', 'lat'),
          too.far = 0.04,
          plot.type = 'contour',
          contour.col = contour_col,
          color = "jet" ,
          type = 'response',
        xlim = c(-176.5, -156.5),
        ylim = c(52, 62),
          xlab = "",
          ylab = "",
          main = "",
          axes = FALSE)
  rect(par("usr")[1], par("usr")[3], par("usr")[2], par("usr")[4], col = "mintcream")
  par(new = TRUE)
  myvis_gam(gam,
          view = c('lon', 'lat'),
          too.far = 0.04,
          plot.type = 'contour',
          contour.col = contour_col,
          color = "jet" ,
          type = 'response',
          xlim = c(-176.5, -156.5),
          ylim = c(52, 62),
          family = "serif",
          xlab = "Longitude",
          ylab = "Latitude",
          main = title,
          cex.main = 1.5,
          cex.lab = 1.5,
          cex.axis = 1.5)
  maps::map('worldHires',
            add = T,
            col = 'wheat4',
            fill = T)
  image.plot(legend.only = T,
             col = jet.colors(100),
             legend.shrink = 0.2,
             smallplot = c(.72, .75, .24, .38),
             legend.cex = 0.7,
             axis.args = list(cex.axis = 0.9),
             legend.width = 0.8,
             legend.mar = 6,
             zlim = c(min(gam$fitted.values), 
                          max(gam$fitted.values)),
             legend.args = list("Occurrence",
                                side = 2, cex = 0.8))
  my_color = colorRampPalette(c("#1C0D51", "#4C408E", "#7E77B0",
                                "#AFABCB", "#DAD9E5", "#F9F9F9",
                                "#FFDAB7", "#FFB377","#E18811",
                                "#AC6000", "#743700"))
  color_levels = 100
  max_absolute_value = max(abs(c(min(grids[[1]]$diff, na.rm = T), 
                                 max(grids[[1]]$diff, na.rm = T)))) 
  color_sequence = seq(-max_absolute_value, max_absolute_value, 
                       length.out = color_levels + 1)
  n_in_class = hist(grids[[1]]$diff, breaks = color_sequence, plot = F)$counts > 0
  col_to_include = min(which(n_in_class == T)):max(which(n_in_class == T))
  breaks_to_include = min(which(n_in_class == T)):(max(which(n_in_class == T)) + 1)
     image(lond,
         latd,
         t(matrix(grids[[1]]$diff,
                 nrow = length(latd),
                 ncol = length(lond),
                 byrow = T)),
        xlim = c(-176.5, -156.5),
        ylim = c(52, 62),
        axes = FALSE,
        xlab = "",
        ylab = "")
  rect(par("usr")[1], par("usr")[3], par("usr")[2], par("usr")[4], col = "mintcream")
  par(new = TRUE)
  image(lond,
        latd,
        t(matrix(grids[[1]]$diff,
                 nrow = length(latd),
                 ncol = length(lond),
                 byrow = T)),
        col = my_color(n = color_levels)[col_to_include],
        breaks = color_sequence[breaks_to_include],
        ylab = "Longitude",
        xlab = "Latitude",
        xlim = c(-176.5, -156.5),
        ylim = c(52, 62),
        main = 'Change in distribution',
        cex.main = 1.5,
        cex.lab = 1.5,
        cex.axis = 1.5)
  maps::map("worldHires",
            fill = T,
            col = "wheat4",
            add = T)
  image.plot(legend.only = T,
             col = my_color(n = color_levels)[col_to_include],
             legend.shrink = 0.2,
             smallplot = c(.73, .76, .22, .36),
             legend.cex = 0.7,
             axis.args = list(cex.axis = 0.9),
             legend.width = 0.8,
             legend.mar = 6,
             zlim = c(min(grids[[1]]$diff, na.rm = T), 
                      max(grids[[1]]$diff, na.rm = T)),
             legend.args = list("Predicted \n Change",
                                side = 2, cex = 0.8))
   plot(grids[[2]]$doy,
       grids[[2]]$pred,
       main = 'Change in phenology',
       type = 'l',
       ylim = range(c(grids[[2]]$pred_up,
                      grids[[2]]$pred2_up,
                      grids[[2]]$pred_lw,
                      grids[[2]]$pred2_lw)),
       xlim = c(min(grids[[2]]$doy), max(grids[[2]]$doy)),
       col = '#000000',
       lwd = 2,
       xlab = 'Day of the year',
       ylab = 'Egg density ln(n/10m2)',
       cex.lab = 1.5,
       cex.axis = 1.5,
       cex.main = 1.5)
  polygon(c(grids[[2]]$doy, rev(grids[[2]]$doy)),
          c(grids[[2]]$pred_lw, rev(grids[[2]]$pred_up)),
          col = alpha('#000000', 0.2), 
          lty = 0)
  lines(grids[[2]]$doy,
        grids[[2]]$pred2,
        col = '#E69F00',
        lwd = 2)
  polygon(c(grids[[2]]$doy, rev(grids[[2]]$doy)),
    c(grids[[2]]$pred2_lw, rev(grids[[2]]$pred2_up)),
    col = alpha('#E69F00', 0.2),
    lty = 0)
}

# Plot the results of the average geography and phenology and decrease of MSE
threepanel_base_mse <- function(data, base_model) {
  nlat = 80
  nlon = 120
  latd = seq(min(data$lat), max(data$lat), length.out = nlat)
  lond = seq(min(data$lon), max(data$lon), length.out = nlon)
  grid <- expand.grid(lond, latd)
  names(grid) <- c('lon', 'lat')
  
  # Geography grid
  grid$dist <- NA
  for (k in 1:nrow(grid)) {
    dist <-
      distance_function(grid$lat[k],
                        grid$lon[k],
                        data$lat,
                        data$lon)
    grid$dist[k] <- min(dist)
  }
  grid$year <- 2014
  grid$doy <- median(data$doy)
  grid$pred <- predict(base_model, newdata = grid)
  grid$pred[grid$dist > 30000] <- NA
  
  # Phenology grid
  grid2 <-  data.frame('lon' = rep(-170, 100),
                                   'lat' = rep(57, 100),
                                   'doy' = seq(min(data$doy),
                                               max(data$doy),
                                               length = 100),
                                   'year' = rep(2014, 100))
  grid2$pred <- predict(base_model, newdata = grid2)
  grid2$se <- predict(base_model, newdata = grid2, se = T)[[2]]
  grid2$pred_up <- grid2$pred + 1.96 * grid2$se
  grid2$pred_lw <- grid2$pred - 1.96 * grid2$se
  return(list(grid, grid2))
}

vc_grids <- function(data, gam_list){
  nlat = 80
  nlon = 120
  latd = seq(min(data$lat), max(data$lat), length.out = nlat)
  lond = seq(min(data$lon), max(data$lon), length.out = nlon)
  spatial_grid <- expand.grid(lond, latd)
  names(spatial_grid) <- c('lon', 'lat')
  spatial_grid$dist <- NA
  for (k in 1:nrow(spatial_grid)) {
    dist <-  distance_function(spatial_grid$lat[k],
                               spatial_grid$lon[k],
                               data$lat,
                               data$lon)
    spatial_grid$dist[k] <- min(dist)
  }
  spatial_grid$year <- 2014
  spatial_grid$doy <- median(data$doy)
  spatial_grid$mean_temp <- mean(data$mean_temp)
  spatial_grid$roms_temperature <- mean(data$roms_temperature, na.rm = T)
  spatial_grid$roms_salinity <- mean(data$roms_salinity, na.rm = T)
  spatial_grid$pred <- predict(gam_list[[1]][[7]], newdata = spatial_grid)
  spatial_grid$se <- predict(gam_list[[1]][[7]], newdata = spatial_grid, se = T)[[2]]
  spatial_grid$pred_up <- spatial_grid$pred + 1.96 * spatial_grid$se
  spatial_grid$pred_lw <- spatial_grid$pred - 1.96 * spatial_grid$se
  spatial_grid$pred[spatial_grid$dist > 30000] <- NA
  spatial_grid$mean_temp <- mean(data$mean_temp) + 1
  spatial_grid$pred2 <- predict(gam_list[[1]][[7]], newdata = spatial_grid)
  spatial_grid$se2 <- predict(gam_list[[1]][[7]], newdata = spatial_grid, se = T)[[2]]
  spatial_grid$pred2_up <- spatial_grid$pred2 + 1.96 * spatial_grid$se2
  spatial_grid$pred2_lw <- spatial_grid$pred2 - 1.96 * spatial_grid$se2
  spatial_grid$diff <- spatial_grid$pred2 - spatial_grid$pred
  spatial_grid$sig_pos <- c(spatial_grid$pred2_lw > spatial_grid$pred_up)
  spatial_grid$sig_neg <- c(spatial_grid$pred2_up < spatial_grid$pred_lw)
  spatial_grid$pos_diff <- spatial_grid$diff * spatial_grid$sig_pos
  spatial_grid$neg_diff <- spatial_grid$diff * spatial_grid$sig_neg
  max_slope <- max(spatial_grid$diff, na.rm = T)
  
  phenology_grid <-  data.frame('lon' = rep(-170, 100),
                                'lat' = rep(57, 100),
                                'doy' = seq(min(data$doy),
                                            max(data$doy),
                                            length = 100),
                                mean_temp = rep(mean(data$mean_temp), 100),
                                'year' = rep(2014, 100),
                                'roms_temperature' = rep(mean(data$roms_temperature, na.rm = T), 100),
                                'roms_salinity' = rep(mean(data$roms_salinity, na.rm = T), 100))
  phenology_grid$pred <- predict(gam_list[[1]][[5]], newdata = phenology_grid)
  phenology_grid$se <- predict(gam_list[[1]][[5]], newdata = phenology_grid, se = T)[[2]]
  phenology_grid$pred_up <- phenology_grid$pred + 1.96 * phenology_grid$se
  phenology_grid$pred_lw <- phenology_grid$pred - 1.96 * phenology_grid$se
  phenology_grid$mean_temp <- mean(data$mean_temp) + 1
  phenology_grid$pred2 <- predict(gam_list[[1]][[5]], newdata = phenology_grid)
  phenology_grid$se2 <- predict(gam_list[[1]][[5]], newdata = phenology_grid, se = T)[[2]]
  phenology_grid$pred2_up <- phenology_grid$pred2 + 1.96 * phenology_grid$se2
  phenology_grid$pred2_lw <- phenology_grid$pred2 - 1.96 * phenology_grid$se2
  return(list(spatial_grid, phenology_grid))
}
```

Base models: Currently using only presence in a Gaussian GAM, may switch to Tweedie With Gaussian, multiplication by binomial GAM required (two-stage)
```{r}
# Gaussian
pk_egg_base <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                     s(doy) +
                     s(lon, lat),
                   data = pk_egg[pk_egg$larvalcatchper10m2 > 0, ])
summary(pk_egg_base)

# Tweedie
pk_egg_base_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                       s(lon, lat) + 
                       s(doy),
                    data = pk_egg,
                    family = tw(link = 'log'),
                    method = 'REML')
summary(pk_egg_base_t)
```
#### Pollock
### Gaussian
## Eggs

Models with flexible phenology or geography 
Note variable coefficient by year for each
```{r}
pk_egg_phenology <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) + 
                          s(doy) +
                          s(lon, lat) + 
                          s(doy, by = factor(year)), 
                        data = pk_egg[pk_egg$larvalcatchper10m2 > 0, ])
summary(pk_egg_phenology)
AIC(pk_egg_phenology)
# AIC: 8713

pk_egg_geography <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                          s(lon, lat) +
                          s(lon, lat, by = factor(year)) +
                          s(doy), 
                        data = pk_egg[pk_egg$larvalcatchper10m2 > 0, ])
summary(pk_egg_geography)
AIC(pk_egg_geography)
# AIC: 8369
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_pkegg_phenology <- (summary(pk_egg_base)$scale - 
                      summary(pk_egg_phenology)$scale) / summary(pk_egg_base)$scale
ratio_pkegg_phenology

ratio_pkegg_geography <- (summary(pk_egg_base)$scale - 
                      summary(pk_egg_geography)$scale) / summary(pk_egg_base)$scale
ratio_pkegg_geography
```

Add ROMS mean temperatures Use a representative area with averaged values from Feb - April for each year This can then be matched to the egg/larvae data for use in variable coefficient by SST instead of year as above

Phenology Compare formulations with temp/salinity formulations
```{r}
# Add monthly temperature values from ROMS
pk_egg$mean_temp <- roms_temps$mean[match(pk_egg$year, roms_temps$year)]
range(pk_egg$mean_temp)

# This will again use the presence GAM from the two stage models
# create variable phenology model by adding doy*sst
pk_egg_month1 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6),
                     data = pk_egg[pk_egg$larvalcatchper10m2 > 0, ])
summary(pk_egg_month1)
AIC(pk_egg_month1)
# Deviance explained: 44.8%
# R2 adj: 0.431
# AIC: 8691
par(mfrow = c(2, 2))
gam.check(pk_egg_month1)


pk_egg_month2 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6) +
                       s(doy, by = mean_temp, k = 6),
                    data = pk_egg[pk_egg$larvalcatchper10m2 > 0, ])
summary(pk_egg_month2)
AIC(pk_egg_month2)
# Deviance explained: 45.1%
# R2 adj: 0.433
# AIC: 8685
par(mfrow = c(2, 2))
gam.check(pk_egg_month2)


pk_egg_month3 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, roms_salinity),
                     data = pk_egg[pk_egg$larvalcatchper10m2 > 0, ])
summary(pk_egg_month3)
AIC(pk_egg_month3)
# Deviance explained: 40.9%
# R2 adj: 0.435
# AIC: 8688
par(mfrow = c(2, 2))
gam.check(pk_egg_month3)


pk_egg_month4 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, roms_salinity) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6),
                     data = pk_egg[pk_egg$larvalcatchper10m2 > 0, ])
summary(pk_egg_month4)
AIC(pk_egg_month4)
# Deviance explained: 45.9%
# R2 adj: 0.438
# AIC: 8676
par(mfrow = c(2, 2))
gam.check(pk_egg_month4)


pk_egg_month5 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, roms_salinity) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6) +
                       s(doy, by = mean_temp, k = 6),
                     data = pk_egg[pk_egg$larvalcatchper10m2 > 0, ])
summary(pk_egg_month5)
AIC(pk_egg_month5)
# Deviance explained: 46.2%
# R2 adj: 0.441
# AIC: 8670
par(mfrow = c(2, 2))
gam.check(pk_egg_month5)
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(pk_egg_month5, select = 1, main = "DOY")
plot(pk_egg_month5, select = 3, main = "Temperature")
plot(pk_egg_month5, select = 4, main = "Salinity")
plot(pk_egg_month5, select = 5, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_monthvc.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pk_egg_month5)
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_monthvc_resid.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Geography Compare formulations with temp/salinity smooth terms
```{r}
# Create variable geography using space*sst
# Compare to the first three phenology models for model selection
pk_egg_space1 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6) +
                       s(lon, lat, by = mean_temp, k = 6),
                    data = pk_egg[pk_egg$larvalcatchper10m2 > 0, ])
summary(pk_egg_space1)
AIC(pk_egg_space1)
# Deviance explained: 45.3%
# R2 adj.: 0.435
# AIC: 8679
par(mfrow = c(2, 2))
gam.check(pk_egg_space1)


pk_egg_space2 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, roms_salinity) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6) +
                       s(lon, lat, by = mean_temp, k = 6),
                    data = pk_egg[pk_egg$larvalcatchper10m2 > 0, ])
summary(pk_egg_space2)
AIC(pk_egg_space2)
# Deviance explained: 46.3%
# R2 adj.: 0.442
# AIC: 8666
par(mfrow = c(2, 2))
gam.check(pk_egg_space2)
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(pk_egg_space2, select = 1, main = "DOY")
plot(pk_egg_space2, select = 3, main = "Temperature")
plot(pk_egg_space2, select = 4, main = "Salinity")
plot(pk_egg_space2, select = 5, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_spacevc.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pk_egg_space2)
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_spacevc_resid.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_pkegg_month <- (summary(pk_egg_base)$scale - 
                         summary(pk_egg_month2)$scale) / summary(pk_egg_base)$scale
var_ratio_pkegg_month 

var_ratio_pkegg_space <- (summary(pk_egg_base)$scale - 
                         summary(pk_egg_space2)$scale) / summary(pk_egg_base)$scale
var_ratio_pkegg_space
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
# Plot the results of the average geography and phenology and decrease of MSE
nlat = 80
nlon = 120
latd = seq(min(pk_egg$lat), max(pk_egg$lat), length.out = nlat)
lond = seq(min(pk_egg$lon), max(pk_egg$lon), length.out = nlon)
grid_pkegg_avg <- expand.grid(lond, latd)
names(grid_pkegg_avg) <- c('lon', 'lat')

# Geography grid
grid_pkegg_avg$dist <- NA
for (k in 1:nrow(grid_pkegg_avg)) {
  dist <-
    distance_function(grid_pkegg_avg$lat[k],
                      grid_pkegg_avg$lon[k],
                      pk_egg$lat,
                      pk_egg$lon)
  grid_pkegg_avg$dist[k] <- min(dist)
}
grid_pkegg_avg$year <- 2014
grid_pkegg_avg$doy <- median(pk_egg$doy)
grid_pkegg_avg$pred <- predict(pk_egg_base, newdata = grid_pkegg_avg)
grid_pkegg_avg$pred[grid_pkegg_avg$dist > 30000] <- NA

# Phenology grid
grid_pkegg_avg2 <-  data.frame('lon' = rep(-170, 100),
                                'lat' = rep(57, 100),
                                'doy' = seq(min(pk_egg$doy), 
                                            max(pk_egg$doy), 
                                            length = 100),
                                'year' = rep(2014, 100))
grid_pkegg_avg2$pred <- predict(pk_egg_base, newdata = grid_pkegg_avg2)
grid_pkegg_avg2$se <- predict(pk_egg_base, newdata = grid_pkegg_avg2, se = T)[[2]]
grid_pkegg_avg2$pred_up <- grid_pkegg_avg2$pred + 1.96 * grid_pkegg_avg2$se
grid_pkegg_avg2$pred_lw <- grid_pkegg_avg2$pred - 1.96 * grid_pkegg_avg2$se
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(pk_egg, grid_pkegg_avg, grid_pkegg_avg2)

# Plot MSE as stacked bars, including year variability and SST variability
barplot(matrix(c(ratio_pkegg_geography,
                 var_ratio_pkegg_space,
                 ratio_pkegg_phenology,
                 var_ratio_pkegg_month) * 100, 
               ncol = 2,
               nrow = 2),
        ylab = 'Delta MSE (%)',
        names.arg = c('Variable distribution', 'Variable phenologies'),
        ylim = c(0, 35),
        main = 'Delta MSE',
        cex.lab = 1.1,
        cex.main = 1.2,
        cex.axis = 1.1,
        cex.names = 1.1,
        space = c(0, 1),
        beside = T,
        col = c('azure4', 'azure3'))
box()
legend("topright",
       legend = c('D-MSE|Year', 'D-MSE|SST'),
       bty = 'n',
       col = c('azure4', 'azure3'),
       pch = 15,
       pt.cex = 2.5,
       cex = 1.1)
dev.copy(jpeg,
         here('results/pollock_hindcast', 
              'pollock_egg_MSE.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs Spatial grid
```{r}
nlat = 80
nlon = 120
latd = seq(min(pk_egg$lat), max(pk_egg$lat), length.out = nlat)
lond = seq(min(pk_egg$lon), max(pk_egg$lon), length.out = nlon)
grid_vc_eggpk <- expand.grid(lond, latd)
names(grid_vc_eggpk) <- c('lon', 'lat')
grid_vc_eggpk$dist <- NA
for (k in 1:nrow(grid_vc_eggpk)) {
  dist <-  distance_function(grid_vc_eggpk$lat[k],
                             grid_vc_eggpk$lon[k],
                             pk_egg$lat,
                             pk_egg$lon)
  grid_vc_eggpk$dist[k] <- min(dist)
}
grid_vc_eggpk$year <- 2014
grid_vc_eggpk$doy <- median(pk_egg$doy)
grid_vc_eggpk$mean_temp <- mean(pk_egg$mean_temp)
grid_vc_eggpk$roms_temperature <- mean(pk_egg$roms_temperature, na.rm = T)
grid_vc_eggpk$roms_salinity <- mean(pk_egg$roms_salinity, na.rm = T)
grid_vc_eggpk$pred <- predict(pk_egg_space2, newdata = grid_vc_eggpk)
grid_vc_eggpk$se <- predict(pk_egg_space2, newdata = grid_vc_eggpk, se = T)[[2]]
grid_vc_eggpk$pred_up <- grid_vc_eggpk$pred + 1.96 * grid_vc_eggpk$se
grid_vc_eggpk$pred_lw <- grid_vc_eggpk$pred - 1.96 * grid_vc_eggpk$se
grid_vc_eggpk$pred[grid_vc_eggpk$dist > 30000] <- NA
grid_vc_eggpk$mean_temp <- mean(pk_egg$mean_temp) + 1
grid_vc_eggpk$pred2 <- predict(pk_egg_space2, newdata = grid_vc_eggpk)
grid_vc_eggpk$se2 <- predict(pk_egg_space2, newdata = grid_vc_eggpk, se = T)[[2]]
grid_vc_eggpk$pred2_up <- grid_vc_eggpk$pred2 + 1.96 * grid_vc_eggpk$se2
grid_vc_eggpk$pred2_lw <- grid_vc_eggpk$pred2 - 1.96 * grid_vc_eggpk$se2
grid_vc_eggpk$diff <- grid_vc_eggpk$pred2 - grid_vc_eggpk$pred
grid_vc_eggpk$sig_pos <- c(grid_vc_eggpk$pred2_lw > grid_vc_eggpk$pred_up)
grid_vc_eggpk$sig_neg <- c(grid_vc_eggpk$pred2_up < grid_vc_eggpk$pred_lw)
grid_vc_eggpk$pos_diff <- grid_vc_eggpk$diff * grid_vc_eggpk$sig_pos
grid_vc_eggpk$neg_diff <- grid_vc_eggpk$diff * grid_vc_eggpk$sig_neg
max_slope <- max(grid_vc_eggpk$diff, na.rm = T)
```

Temporal grid
```{r}
grid_vc_eggpk2 <-  data.frame('lon' = rep(-170, 100),
                           'lat' = rep(57, 100),
                           'doy' = seq(min(pk_egg$doy), 
                                       max(pk_egg$doy), 
                                       length = 100),
                           mean_temp = rep(mean(pk_egg$mean_temp), 100),
                           'year' = rep(2014, 100),
                           'roms_temperature' = rep(mean(pk_egg$roms_temperature, na.rm = T), 100),
                           'roms_salinity' = rep(mean(pk_egg$roms_salinity, na.rm = T), 100))
grid_vc_eggpk2$pred <- predict(pk_egg_month5, newdata = grid_vc_eggpk2)
grid_vc_eggpk2$se <- predict(pk_egg_month5, newdata = grid_vc_eggpk2, se = T)[[2]]
grid_vc_eggpk2$pred_up <- grid_vc_eggpk2$pred + 1.96 * grid_vc_eggpk2$se
grid_vc_eggpk2$pred_lw <- grid_vc_eggpk2$pred - 1.96 * grid_vc_eggpk2$se
grid_vc_eggpk2$mean_temp <- mean(pk_egg$mean_temp) + 1
grid_vc_eggpk2$pred2 <- predict(pk_egg_month5, newdata = grid_vc_eggpk2)
grid_vc_eggpk2$se2 <- predict(pk_egg_month5, newdata = grid_vc_eggpk2, se = T)[[2]]
grid_vc_eggpk2$pred2_up <- grid_vc_eggpk2$pred2 + 1.96 * grid_vc_eggpk2$se2
grid_vc_eggpk2$pred2_lw <- grid_vc_eggpk2$pred2 - 1.96 * grid_vc_eggpk2$se2
```

Create two panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc(pk_egg, pk_egg_space2, grid_vc_eggpk, grid_vc_eggpk2, "Spatial GAM Hindcast")
  legend(130,
         11,
         legend = c('Mean SST', '+ 1C'),
         col = c('#000000', '#E69F00'),
         lty = 1,
         bty = 'n',
         lwd = 2,
         cex = 0.6)
dev.copy(jpeg,
         here('results/pollock_hindcast',
         'pollock_egg_best.jpg'),
         height = 3.5,
         width = 8,
         res = 200,
         units = 'in')
dev.off()
```

## Larvae
Base model:
Currently using only presence in a Gaussian GAM, may switch to Tweedie
With Gaussian, multiplication by binomial GAM required (two-stage)
```{r}
# Gaussian
pk_larvae_base <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                     s(doy) +
                     s(lon, lat),
                   data = pk_larvae[pk_larvae$larvalcatchper10m2 > 0, ])
summary(pk_larvae_base)

# Tweedie
pk_larvae_base_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                       s(lon, lat) + 
                       s(doy),
                    data = pk_larvae,
                    family = tw(link = 'log'),
                    method = 'REML')
summary(pk_larvae_base_t)
```

Models with flexible phenology or geography
Note variable coefficient by year for each
```{r}
pk_larvae_phenology <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) + 
                             s(lon, lat) +
                             s(doy) +
                             s(doy, by = factor(year)), 
                           data = pk_larvae[pk_larvae$larvalcatchper10m2 > 0, ])
summary(pk_larvae_phenology)
AIC(pk_larvae_phenology)
# AIC: 7501

pk_larvae_geography <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                             s(lon, lat) +
                             s(lon, lat, by = factor(year)) +
                             s(doy), 
                           data = pk_larvae[pk_larvae$larvalcatchper10m2 > 0, ])
summary(pk_larvae_geography)
AIC(pk_larvae_geography)
# AIC: 6694
```

Ratio for comparison between base and flexible models
Use to look at mean square error, base should have higher error
```{r}
ratio_pklarvae_phenology <- (summary(pk_larvae_base)$scale - 
                      summary(pk_larvae_phenology)$scale) / summary(pk_larvae_base)$scale
ratio_pklarvae_phenology

ratio_pklarvae_geography <- (summary(pk_larvae_base)$scale - 
                      summary(pk_larvae_geography)$scale) / summary(pk_larvae_base)$scale
ratio_pklarvae_geography 
```

Add ROMS mean temperatures
Use a representative area with averaged values from Feb - April for each year
This can then be matched to the egg/larvae data for use in variable coefficient by SST 
instead of year as above

Phenology
Compare formulations with temp/salinity formulations
```{r}
# Add monthly temperature values from ROMS
pk_larvae$mean_temp <- roms_temps$mean[match(pk_larvae$year, roms_temps$year)]
range(pk_larvae$mean_temp)

# This will again use the presence GAM from the two stage models
# create variable phenology model by adding doy*sst
pk_larvae_month1 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6),
                     data = pk_larvae[pk_larvae$larvalcatchper10m2 > 0, ])
summary(pk_larvae_month1)
AIC(pk_larvae_month1)
# Deviance explained: 48.1%
# R2 adj: 0.464
# AIC: 7523
par(mfrow = c(2, 2))
gam.check(pk_larvae_month1)


pk_larvae_month2 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6) +
                       s(doy, by = mean_temp, k = 6),
                    data = pk_larvae[pk_larvae$larvalcatchper10m2 > 0, ])
summary(pk_larvae_month2)
AIC(pk_larvae_month2)
# Deviance explained: 48.6%
# R2 adj: 0.468
# AIC: 7513
par(mfrow = c(2, 2))
gam.check(pk_larvae_month2)


pk_larvae_month3 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, roms_salinity),
                     data = pk_larvae[pk_larvae$larvalcatchper10m2 > 0, ])
summary(pk_larvae_month3)
AIC(pk_larvae_month3)
# Deviance explained: 45%
# R2 adj: 0.433
# AIC: 7631
par(mfrow = c(2, 2))
gam.check(pk_larvae_month3)


pk_larvae_month4 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, roms_salinity) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6),
                     data = pk_larvae[pk_larvae$larvalcatchper10m2 > 0, ])
summary(pk_larvae_month4)
AIC(pk_larvae_month4)
# Deviance explained: 48.3%
# R2 adj: 0.465
# AIC: 7518
par(mfrow = c(2, 2))
gam.check(pk_larvae_month4)


pk_larvae_month5 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, roms_salinity) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6) +
                       s(doy, by = mean_temp, k = 6),
                     data = pk_larvae[pk_larvae$larvalcatchper10m2 > 0, ])
summary(pk_larvae_month5)
AIC(pk_larvae_month5)
# Deviance explained: 48.7%
# R2 adj: 0.469
# AIC: 7510
par(mfrow = c(2, 2))
gam.check(pk_larvae_month5)
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(pk_larvae_month5, select = 1, main = "DOY")
plot(pk_larvae_month5, select = 3, main = "Temperature")
plot(pk_larvae_month5, select = 4, main = "Salinity")
plot(pk_larvae_month5, select = 5, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_larvae_roms_monthvc.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pk_larvae_month5)
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_larvae_roms_monthvc_resid.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Geography
Compare formulations with temp/salinity smooth terms
```{r}
# Create variable geography using space*sst
# Compare to the first three phenology models for model selection
pk_larvae_space1 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6) +
                       s(lon, lat, by = mean_temp, k = 6),
                    data = pk_larvae[pk_larvae$larvalcatchper10m2 > 0, ])
summary(pk_larvae_space1)
AIC(pk_larvae_space1)
# Deviance explained: 50.7%
# R2 adj.: 0.489
# AIC: 7431
par(mfrow = c(2, 2))
gam.check(pk_larvae_space1)


pk_larvae_space2 <- gam(log(larvalcatchper10m2 + 1) ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, roms_salinity) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6) +
                       s(lon, lat, by = mean_temp, k = 6),
                    data = pk_larvae[pk_larvae$larvalcatchper10m2 > 0, ])
summary(pk_larvae_space2)
AIC(pk_larvae_space2)
# Deviance explained: 50.7%
# R2 adj.: 0.489
# AIC: 7431
par(mfrow = c(2, 2))
gam.check(pk_larvae_space2)
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(pk_larvae_space2, select = 1, main = "DOY")
plot(pk_larvae_space2, select = 3, main = "Temperature")
plot(pk_larvae_space2, select = 4, main = "Salinity")
plot(pk_larvae_space2, select = 5, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_larvae_roms_spacevc.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pk_larvae_space2)
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_larvae_roms_spacevc_resid.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```


VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_pklarvae_month <- (summary(pk_larvae_base)$scale - 
                         summary(pk_larvae_month2)$scale) / summary(pk_larvae_base)$scale
var_ratio_pklarvae_month 

var_ratio_pklarvae_space <- (summary(pk_larvae_base)$scale - 
                         summary(pk_larvae_space2)$scale) / summary(pk_larvae_base)$scale
var_ratio_pklarvae_space
```

Plot the results of the GAMs that vary by year
This generates a three panel figure with a map, phenology curve, and MSE barplot
Grids:
```{r}
# Plot the results of the average geography and phenology and decrease of MSE
nlat = 80
nlon = 120
latd = seq(min(pk_larvae$lat), max(pk_larvae$lat), length.out = nlat)
lond = seq(min(pk_larvae$lon), max(pk_larvae$lon), length.out = nlon)
grid_pklarvae_avg <- expand.grid(lond, latd)
names(grid_pklarvae_avg) <- c('lon', 'lat')

# Geography grid
grid_pklarvae_avg$dist <- NA
for (k in 1:nrow(grid_pklarvae_avg)) {
  dist <-
    distance_function(grid_pklarvae_avg$lat[k],
                      grid_pklarvae_avg$lon[k],
                      pk_larvae$lat,
                      pk_larvae$lon)
  grid_pklarvae_avg$dist[k] <- min(dist)
}
grid_pklarvae_avg$year <- 2014
grid_pklarvae_avg$doy <- median(pk_larvae$doy)
grid_pklarvae_avg$pred <- predict(pk_larvae_base, newdata = grid_pklarvae_avg)
grid_pklarvae_avg$pred[grid_pklarvae_avg$dist > 30000] <- NA

# Phenology grid
grid_pklarvae_avg2 <-  data.frame('lon' = rep(-170, 100),
                                'lat' = rep(57, 100),
                                'doy' = seq(min(pk_larvae$doy), 
                                            max(pk_larvae$doy), 
                                            length = 100),
                                'year' = rep(2014, 100))
grid_pklarvae_avg2$pred <- predict(pk_larvae_base, newdata = grid_pklarvae_avg2)
grid_pklarvae_avg2$se <- predict(pk_larvae_base, newdata = grid_pklarvae_avg2, se = T)[[2]]
grid_pklarvae_avg2$pred_up <- grid_pklarvae_avg2$pred + 1.96 * grid_pklarvae_avg2$se
grid_pklarvae_avg2$pred_lw <- grid_pklarvae_avg2$pred - 1.96 * grid_pklarvae_avg2$se
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), mai = c(0.7, 0.6, 0.4, 0.4))
map_phenology(pk_larvae, grid_pklarvae_avg, grid_pklarvae_avg2)

# Plot MSE as stacked bars, including year variability and SST variability
barplot(matrix(c(ratio_pklarvae_geography,
                 var_ratio_pklarvae_space,
                 ratio_pklarvae_phenology,
                 var_ratio_pklarvae_month) * 100, 
               ncol = 2,
               nrow = 2),
        ylab = 'Delta MSE (%)',
        names.arg = c('Variable distribution', 'Variable phenologies'),
        ylim = c(0, 50),
        main = 'Delta MSE',
        cex.lab = 1.1,
        cex.main = 1.2,
        cex.axis = 1.1,
        cex.names = 1.1,
        space = c(0, 1),
        beside = T,
        col = c('azure4', 'azure3'))
box()
legend("topright",
       legend = c('D-MSE|Year', 'D-MSE|SST'),
       bty = 'n',
       col = c('azure4', 'azure3'),
       pch = 15,
       pt.cex = 2.5,
       cex = 1.1)
dev.copy(jpeg,
         here('results/pollock_hindcast', 
              'pollock_larvae_MSE.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs
Spatial grid
```{r}
nlat = 80
nlon = 120
latd = seq(min(pk_larvae$lat), max(pk_larvae$lat), length.out = nlat)
lond = seq(min(pk_larvae$lon), max(pk_larvae$lon), length.out = nlon)
grid_vc_larvaepk <- expand.grid(lond, latd)
names(grid_vc_larvaepk) <- c('lon', 'lat')
grid_vc_larvaepk$dist <- NA
for (k in 1:nrow(grid_vc_larvaepk)) {
  dist <-  distance_function(grid_vc_larvaepk$lat[k],
                             grid_vc_larvaepk$lon[k],
                             pk_larvae$lat,
                             pk_larvae$lon)
  grid_vc_larvaepk$dist[k] <- min(dist)
}
grid_vc_larvaepk$year <- 2014
grid_vc_larvaepk$doy <- median(pk_larvae$doy)
grid_vc_larvaepk$mean_temp <- mean(pk_larvae$mean_temp)
grid_vc_larvaepk$roms_temperature <- mean(pk_larvae$roms_temperature, na.rm = T)
grid_vc_larvaepk$roms_salinity <- mean(pk_larvae$roms_salinity, na.rm = T)
grid_vc_larvaepk$pred <- predict(pk_larvae_space2, newdata = grid_vc_larvaepk)
grid_vc_larvaepk$se <- predict(pk_larvae_space2, newdata = grid_vc_larvaepk, se = T)[[2]]
grid_vc_larvaepk$pred_up <- grid_vc_larvaepk$pred + 1.96 * grid_vc_larvaepk$se
grid_vc_larvaepk$pred_lw <- grid_vc_larvaepk$pred - 1.96 * grid_vc_larvaepk$se
grid_vc_larvaepk$pred[grid_vc_larvaepk$dist > 30000] <- NA
grid_vc_larvaepk$mean_temp <- mean(pk_larvae$mean_temp) + 1
grid_vc_larvaepk$pred2 <- predict(pk_larvae_space2, newdata = grid_vc_larvaepk)
grid_vc_larvaepk$se2 <- predict(pk_larvae_space2, newdata = grid_vc_larvaepk, se = T)[[2]]
grid_vc_larvaepk$pred2_up <- grid_vc_larvaepk$pred2 + 1.96 * grid_vc_larvaepk$se2
grid_vc_larvaepk$pred2_lw <- grid_vc_larvaepk$pred2 - 1.96 * grid_vc_larvaepk$se2
grid_vc_larvaepk$diff <- grid_vc_larvaepk$pred2 - grid_vc_larvaepk$pred
grid_vc_larvaepk$sig_pos <- c(grid_vc_larvaepk$pred2_lw > grid_vc_larvaepk$pred_up)
grid_vc_larvaepk$sig_neg <- c(grid_vc_larvaepk$pred2_up < grid_vc_larvaepk$pred_lw)
grid_vc_larvaepk$pos_diff <- grid_vc_larvaepk$diff * grid_vc_larvaepk$sig_pos
grid_vc_larvaepk$neg_diff <- grid_vc_larvaepk$diff * grid_vc_larvaepk$sig_neg
max_slope <- max(grid_vc_larvaepk$diff, na.rm = T)
```

Temporal grid
```{r}
grid_vc_larvaepk2 <-  data.frame('lon' = rep(-170, 100),
                           'lat' = rep(57, 100),
                           'doy' = seq(min(pk_larvae$doy), 
                                       max(pk_larvae$doy), 
                                       length = 100),
                           mean_temp = rep(mean(pk_larvae$mean_temp), 100),
                           'year' = rep(2014, 100),
                           'roms_temperature' = rep(mean(pk_larvae$roms_temperature, na.rm = T), 100),
                           'roms_salinity' = rep(mean(pk_larvae$roms_salinity, na.rm = T), 100))
grid_vc_larvaepk2$pred <- predict(pk_larvae_month5, newdata = grid_vc_larvaepk2)
grid_vc_larvaepk2$se <- predict(pk_larvae_month5, newdata = grid_vc_larvaepk2, se = T)[[2]]
grid_vc_larvaepk2$pred_up <- grid_vc_larvaepk2$pred + 1.96 * grid_vc_larvaepk2$se
grid_vc_larvaepk2$pred_lw <- grid_vc_larvaepk2$pred - 1.96 * grid_vc_larvaepk2$se
grid_vc_larvaepk2$mean_temp <- mean(pk_larvae$mean_temp) + 1
grid_vc_larvaepk2$pred2 <- predict(pk_larvae_month5, newdata = grid_vc_larvaepk2)
grid_vc_larvaepk2$se2 <- predict(pk_larvae_month5, newdata = grid_vc_larvaepk2, se = T)[[2]]
grid_vc_larvaepk2$pred2_up <- grid_vc_larvaepk2$pred2 + 1.96 * grid_vc_larvaepk2$se2
grid_vc_larvaepk2$pred2_lw <- grid_vc_larvaepk2$pred2 - 1.96 * grid_vc_larvaepk2$se2
```

Create two panel plot
Map of distribution & phenology curves with +1 temperature change
```{r}
par(mfrow = c(1, 2), 
    mai = c(0.8, 0.9, 0.5, 0.5),
    family = "serif")
map_vc(pk_larvae, grid_vc_larvaepk, grid_vc_larvaepk2)
  legend(110,
         4,
         legend = c('Mean SST', '+ 1C'),
         col = c('#000000', '#E69F00'),
         lty = 1,
         bty = 'n',
         lwd = 2,
         cex = 0.6)
dev.copy(jpeg,
         here('results/pollock_hindcast',
         'pollock_larvae_vc.jpg'),
         height = 3.5,
         width = 8,
         res = 200,
         units = 'in')
dev.off()
```

### Tweedie
## Eggs

Models with flexible phenology or geography 
Note variable coefficient by year for each
This takes forever to run, don't do unless necessary to recreate figure
```{r}
pk_egg_phenology_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) + 
                          s(doy) +
                          s(lon, lat) + 
                          s(doy, by = factor(year)), 
                        data = pk_egg,
                        family = tw(link = 'log'),
                        method = 'REML')
summary(pk_egg_phenology_t)
AIC(pk_egg_phenology_t)
# AIC: 33996

pk_egg_geography_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                          s(lon, lat) +
                          s(lon, lat, by = factor(year)) +
                          s(doy), 
                        data = pk_egg,
                        family = tw(link = 'log'),
                        method = 'REML')
summary(pk_egg_geography_t)
AIC(pk_egg_geography_t)
# AIC: 33177
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_pkegg_phenology_t <- (summary(pk_egg_base_t)$scale - 
                      summary(pk_egg_phenology_t)$scale) / summary(pk_egg_base_t)$scale
ratio_pkegg_phenology_t #0.111

ratio_pkegg_geography_t <- (summary(pk_egg_base_t)$scale - 
                      summary(pk_egg_geography_t)$scale) / summary(pk_egg_base_t)$scale
ratio_pkegg_geography_t #0.310
```

Add ROMS mean temperatures Use a representative area with averaged values from Feb - April for each year This can then be matched to the egg/larvae data for use in variable coefficient by SST instead of year as above

Determine best GAM from 7 formulations (see function)
```{r}
pkegg_gams_t <- gam_selection(pk_egg, roms_temps)
AIC(pkegg_gams_t[[1]][[1]])
AIC(pkegg_gams_t[[1]][[2]])
AIC(pkegg_gams_t[[1]][[3]])
AIC(pkegg_gams_t[[1]][[4]])
AIC(pkegg_gams_t[[1]][[5]])
AIC(pkegg_gams_t[[1]][[6]])
AIC(pkegg_gams_t[[1]][[7]])
summary(pkegg_gams_t[[2]])
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(pkegg_gams_t[[1]][[5]], select = 1, main = "DOY")
plot(pkegg_gams_t[[1]][[5]], select = 4, main = "Temperature")
plot(pkegg_gams_t[[1]][[5]], select = 5, main = "Salinity")
plot(pkegg_gams_t[[1]][[5]], select = 6, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pkegg_gams_t[[1]][[5]])
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(pkegg_gams_t[[1]][[7]], select = 1, main = "DOY")
plot(pkegg_gams_t[[1]][[7]], select = 4, main = "Temperature")
plot(pkegg_gams_t[[1]][[7]], select = 5, main = "Salinity")
plot(pkegg_gams_t[[1]][[7]], select = 6, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pkegg_gams_t[[1]][[7]])
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_pkegg_month_t <- (summary(pk_egg_base_t)$scale - 
                         summary(pk_egg_month2_t)$scale) / summary(pk_egg_base_t)$scale
var_ratio_pkegg_month_t 

var_ratio_pkegg_space_t <- (summary(pk_egg_base_t)$scale - 
                         summary(pk_egg_space1_t)$scale) / summary(pk_egg_base_t)$scale
var_ratio_pkegg_space_t
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
pkegg_grids <- threepanel_base_mse(pk_egg, pk_egg_base_t)
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(pk_egg, pkegg_grids, ratio_pkegg_geography_t,
                 var_ratio_pkegg_space_t,
                 ratio_pkegg_phenology_t,
                 var_ratio_pkegg_month_t)
dev.copy(jpeg,
         here('results/pollock_hindcast', 
              'pollock_egg_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs
```{r}

pkegg_vcgrids <- vc_grids(pk_egg, pkegg_gams_t)
```

Create two panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc(pk_egg, pkegg_gams[[1]][[5]], pkegg_vcgrids, "Spatial GAM hindcast")
legend(140,
       11,
         legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
         lty = 1,
         bty = 'n',
         lwd = 2,
         cex = 1.2)
dev.copy(jpeg,
         here('results/pollock_hindcast',
         'pollock_egg_vc_t.jpg'),
         height = 3.5,
         width = 10,
         res = 200,
         units = 'in')
dev.off()
```

## Larvae

Models with flexible phenology or geography 
Note variable coefficient by year for each
```{r}
pk_larvae_phenology_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) + 
                          s(doy) +
                          s(lon, lat) + 
                          s(doy, by = factor(year)), 
                        data = pk_larvae,
                        family = tw(link = 'log'),
                        method = 'REML')
summary(pk_larvae_phenology_t)
AIC(pk_larvae_phenology_t)
# AIC: 32891

pk_larvae_geography_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                          s(lon, lat) +
                          s(lon, lat, by = factor(year)) +
                          s(doy), 
                        data = pk_larvae,
                        family = tw(link = 'log'),
                        method = 'REML')
summary(pk_larvae_geography_t)
AIC(pk_larvae_geography_t)
# AIC: 31370
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_pklarvae_phenology_t <- (summary(pk_larvae_base_t)$scale - 
                      summary(pk_larvae_phenology_t)$scale) / summary(pk_larvae_base_t)$scale
ratio_pklarvae_phenology_t # 0.119

ratio_pklarvae_geography_t <- (summary(pk_larvae_base_t)$scale - 
                      summary(pk_larvae_geography_t)$scale) / summary(pk_larvae_base_t)$scale
ratio_pklarvae_geography_t # 0.426
```

Determine best GAM from 7 formulations (see function)
```{r}
pklarvae_gams_t <- gam_selection(pk_larvae, roms_temps)
AIC(pklarvae_gams_t[[1]][[1]])
AIC(pklarvae_gams_t[[1]][[2]])
AIC(pklarvae_gams_t[[1]][[3]])
AIC(pklarvae_gams_t[[1]][[4]])
AIC(pklarvae_gams_t[[1]][[5]])
AIC(pklarvae_gams_t[[1]][[6]])
AIC(pklarvae_gams_t[[1]][[7]])
summary(pklarvae_gams_t[[2]])
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(pklarvae_gams_t[[1]][[5]], select = 1, main = "DOY")
plot(pklarvae_gams_t[[1]][[5]], select = 4, main = "Temperature")
plot(pklarvae_gams_t[[1]][[5]], select = 5, main = "Salinity")
plot(pklarvae_gams_t[[1]][[5]], select = 6, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_larvae_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pklarvae_gams_t[[1]][[5]])
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_larvae_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(pklarvae_gams_t[[1]][[7]], select = 1, main = "DOY")
plot(pklarvae_gams_t[[1]][[7]], select = 4, main = "Temperature")
plot(pklarvae_gams_t[[1]][[7]], select = 5, main = "Salinity")
plot(pklarvae_gams_t[[1]][[7]], select = 6, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_larvae_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pklarvae_gams_t[[1]][[7]])
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_larvae_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_pklarvae_month_t <- (summary(pk_larvae_base_t)$scale - 
                         summary(pk_larvae_month2_t)$scale) / summary(pk_larvae_base_t)$scale
var_ratio_pklarvae_month_t 

var_ratio_pklarvae_space_t <- (summary(pk_larvae_base_t)$scale - 
                         summary(pk_larvae_space1_t)$scale) / summary(pk_larvae_base_t)$scale
var_ratio_pklarvae_space_t
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
pklarvae_grids <- threepanel_base_mse(pk_larvae, pk_larvae_base_t)
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(pk_larvae, pklarvae_grids, ratio_pklarvae_geography_t,
                 var_ratio_pklarvae_space_t,
                 ratio_pklarvae_phenology_t,
                 var_ratio_pklarvae_month_t)
dev.copy(jpeg,
         here('results/pollock_hindcast', 
              'pollock_larvae_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs
```{r}

pklarvae_vcgrids <- vc_grids(pk_larvae, pklarvae_gams_t)
```

Create two panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc(pk_larvae, pklarvae_gams[[1]][[5]], pklarvae_vcgrids, "Spatial GAM hindcast")
legend(140,
       11,
         legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
         lty = 1,
         bty = 'n',
         lwd = 2,
         cex = 1.2)
dev.copy(jpeg,
         here('results/pollock_hindcast',
         'pollock_larvae_vc_t.jpg'),
         height = 3.5,
         width = 10,
         res = 200,
         units = 'in')
dev.off()
```

#### Flathead Sole
### Tweedie
```{r}
fhs_egg_base_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                       s(lon, lat) + 
                       s(doy),
                    data = fhs_egg,
                    family = tw(link = 'log'),
                    method = 'REML')
summary(fhs_egg_base_t)

fhs_larvae_base_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                       s(lon, lat) + 
                       s(doy),
                    data = fhs_larvae,
                    family = tw(link = 'log'),
                    method = 'REML')
summary(fhs_larvae_base_t)
```

## Eggs

Models with flexible phenology or geography 
Note variable coefficient by year for each
This takes forever to run, don't do unless necessary to recreate figure
```{r}
fhs_egg_phenology_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) + 
                          s(doy) +
                          s(lon, lat) + 
                          s(doy, by = factor(year)), 
                        data = fhs_egg,
                        family = tw(link = 'log'),
                        method = 'REML')
summary(fhs_egg_phenology_t)
AIC(fhs_egg_phenology_t)
# AIC: 9907

fhs_egg_geography_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                          s(lon, lat) +
                          s(lon, lat, by = factor(year)) +
                          s(doy), 
                        data = fhs_egg,
                        family = tw(link = 'log'),
                        method = 'REML')
summary(fhs_egg_geography_t)
AIC(fhs_egg_geography_t)
# AIC: 8939
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_fhsegg_phenology_t <- (summary(fhs_egg_base_t)$scale - 
                      summary(fhs_egg_phenology_t)$scale) / summary(fhs_egg_base_t)$scale
ratio_fhsegg_phenology_t #0.171

ratio_fhsegg_geography_t <- (summary(fhs_egg_base_t)$scale - 
                      summary(fhs_egg_geography_t)$scale) / summary(fhs_egg_base_t)$scale
ratio_fhsegg_geography_t #0.496
```

Add ROMS mean temperatures Use a representative area with averaged values from Feb - April for each year This can then be matched to the egg/larvae data for use in variable coefficient by SST instead of year as above

Phenology Compare formulations with temp/salinity formulations
```{r}
# Add monthly temperature values from ROMS
fhs_egg$mean_temp <- roms_temps$mean[match(fhs_egg$year, roms_temps$year)]
range(fhs_egg$mean_temp)

# This will again use the presence GAM from the two stage models
# create variable phenology model by adding doy*sst
fhs_egg_month1_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                         s(doy, k = 8) +
                         s(lon, lat) +
                         s(roms_temperature, k = 6) +
                         s(roms_salinity, k = 6), 
                       data = fhs_egg,
                       family = tw(link = 'log'),
                       method = 'REML')
summary(fhs_egg_month1_t)
AIC(fhs_egg_month1_t)
# Deviance explained: 67.8%
# AIC: 10144
par(mfrow = c(2, 2))
gam.check(fhs_egg_month1_t)


fhs_egg_month2_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                         s(doy, k = 8) +
                         s(lon, lat) +
                         s(roms_temperature, k = 6) +
                         s(roms_salinity, k = 6) +
                         s(doy, by = mean_temp, k = 6),
                       data = fhs_egg,
                       family = tw(link = 'log'),
                       method = 'REML')
summary(fhs_egg_month2_t)
AIC(fhs_egg_month2_t)
# Deviance explained: 68.5%
# AIC: 10105
par(mfrow = c(2, 2))
gam.check(fhs_egg_month2_t)


fhs_egg_month3_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                         s(doy, k = 8) +
                         s(lon, lat) +
                         s(roms_temperature, roms_salinity),
                       data = fhs_egg,
                       family = tw(link = 'log'),
                       method = 'REML')
summary(fhs_egg_month3_t)
AIC(fhs_egg_month3_t)
# Deviance explained: 69.5%
# AIC: 10058
par(mfrow = c(2, 2))
gam.check(fhs_egg_month3_t)


fhs_egg_month4_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                         s(doy, k = 8) +
                         s(lon, lat) +
                         s(roms_temperature, roms_salinity) +
                         s(roms_temperature, k = 6) +
                         s(roms_salinity, k = 6),
                       data = fhs_egg,
                       family = tw(link = 'log'),
                       method = 'REML')
summary(fhs_egg_month4_t)
AIC(fhs_egg_month4_t)
# Deviance explained: 69.5%
# AIC: 10060
par(mfrow = c(2, 2))
gam.check(fhs_egg_month4_t)


fhs_egg_month5_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                         s(doy, k = 8) +
                         s(lon, lat) +
                         s(roms_temperature, roms_salinity) +
                         s(roms_temperature) +
                         s(roms_salinity, k = 4) +
                         s(doy, by = mean_temp, k = 6),
                       data = fhs_egg,
                       family = tw(link = 'log'),
                       method = 'REML')
summary(fhs_egg_month5_t)
AIC(fhs_egg_month5_t)
# Deviance explained: 70%
# AIC: 10035
par(mfrow = c(2, 2))
gam.check(fhs_egg_month5_t)
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(fhs_egg_month5_t, select = 1, main = "DOY")
plot(fhs_egg_month5_t, select = 4, main = "Temperature")
plot(fhs_egg_month5_t, select = 5, main = "Salinity")
plot(fhs_egg_month5_t, select = 6, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_egg_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(fhs_egg_month5_t)
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_egg_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Geography Compare formulations with temp/salinity smooth terms
```{r}
# Create variable geography using space*sst
# Compare to the first three phenology models for model selection
fhs_egg_space1_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                         s(doy, k = 8) +
                         s(lon, lat) +
                         s(roms_temperature, k = 6) +
                         s(roms_salinity, k = 6) +
                         s(lon, lat, by = mean_temp, k = 6),
                       data = fhs_egg,
                       family = tw(link = 'log'),
                       method = 'REML')
summary(fhs_egg_space1_t)
AIC(fhs_egg_space1_t)
# Deviance explained: 68.7%
# AIC: 10092
par(mfrow = c(2, 2))
gam.check(fhs_egg_space1_t)


fhs_egg_space2_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, roms_salinity) +
                       s(roms_temperature, k = 6) +
                       s(roms_salinity, k = 6) +
                       s(lon, lat, by = mean_temp, k = 6),
                     data = fhs_egg,
                     family = tw(link = 'log'),
                     method = 'REML')
summary(fhs_egg_space2_t)
AIC(fhs_egg_space2_t)
# Deviance explained: 70.2%
# AIC: 10022
par(mfrow = c(2, 2))
gam.check(fhs_egg_space2_t)
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(fhs_egg_space2_t, select = 1, main = "DOY")
plot(fhs_egg_space2_t, select = 4, main = "Temperature")
plot(fhs_egg_space2_t, select = 5, main = "Salinity")
plot(fhs_egg_space2_t, select = 6, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_egg_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(fhs_egg_space2_t)
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_egg_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_fhsegg_month_t <- (summary(fhs_egg_base_t)$scale - 
                         summary(fhs_egg_month2_t)$scale) / summary(fhs_egg_base_t)$scale
var_ratio_fhsegg_month_t #0.0604

var_ratio_fhsegg_space_t <- (summary(fhs_egg_base_t)$scale - 
                         summary(fhs_egg_space1_t)$scale) / summary(fhs_egg_base_t)$scale
var_ratio_fhsegg_space_t #0.0652
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
# Plot the results of the average geography and phenology and decrease of MSE
nlat = 80
nlon = 120
latd = seq(min(fhs_egg$lat), max(fhs_egg$lat), length.out = nlat)
lond = seq(min(fhs_egg$lon), max(fhs_egg$lon), length.out = nlon)
grid_fhsegg_avg_t <- expand.grid(lond, latd)
names(grid_fhsegg_avg_t) <- c('lon', 'lat')

# Geography grid
grid_fhsegg_avg_t$dist <- NA
for (k in 1:nrow(grid_fhsegg_avg_t)) {
  dist <-
    distance_function(grid_fhsegg_avg_t$lat[k],
                      grid_fhsegg_avg_t$lon[k],
                      fhs_egg$lat,
                      fhs_egg$lon)
  grid_fhsegg_avg_t$dist[k] <- min(dist)
}
grid_fhsegg_avg_t$year <- 2014
grid_fhsegg_avg_t$doy <- median(fhs_egg$doy)
grid_fhsegg_avg_t$pred <- predict(fhs_egg_base_t, newdata = grid_fhsegg_avg_t)
grid_fhsegg_avg_t$pred[grid_fhsegg_avg_t$dist > 30000] <- NA

# Phenology grid
grid_fhsegg_avg_t2 <-  data.frame('lon' = rep(-170, 100),
                                'lat' = rep(57, 100),
                                'doy' = seq(min(fhs_egg$doy), 
                                            max(fhs_egg$doy), 
                                            length = 100),
                                'year' = rep(2014, 100))
grid_fhsegg_avg_t2$pred <- predict(fhs_egg_base_t, newdata = grid_fhsegg_avg_t2)
grid_fhsegg_avg_t2$se <- predict(fhs_egg_base_t, newdata = grid_fhsegg_avg_t2, se = T)[[2]]
grid_fhsegg_avg_t2$pred_up <- grid_fhsegg_avg_t2$pred + 1.96 * grid_fhsegg_avg_t2$se
grid_fhsegg_avg_t2$pred_lw <- grid_fhsegg_avg_t2$pred - 1.96 * grid_fhsegg_avg_t2$se
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(fhs_egg, grid_fhsegg_avg_t, grid_fhsegg_avg_t2)

# Plot MSE as stacked bars, including year variability and SST variability
barplot(matrix(c(ratio_fhsegg_geography_t,
                 var_ratio_fhsegg_space_t,
                 ratio_fhsegg_phenology_t,
                 var_ratio_fhsegg_month_t) * 100, 
               ncol = 2,
               nrow = 2),
        ylab = 'Delta MSE (%)',
        names.arg = c('Variable distribution', 'Variable phenologies'),
        ylim = c(0, 50),
        main = 'Delta MSE',
        cex.lab = 1.1,
        cex.main = 1.2,
        cex.axis = 1.1,
        cex.names = 1.1,
        space = c(0, 1),
        beside = T,
        col = c('azure4', 'azure3'))
box()
legend("topright",
       legend = c('D-MSE|Year', 'D-MSE|SST'),
       bty = 'n',
       col = c('azure4', 'azure3'),
       pch = 15,
       pt.cex = 2.5,
       cex = 1.1)
dev.copy(jpeg,
         here('results/flathead_hindcast', 
              'flathead_egg_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs Spatial grid
```{r}
nlat = 80
nlon = 120
latd = seq(min(fhs_egg$lat), max(fhs_egg$lat), length.out = nlat)
lond = seq(min(fhs_egg$lon), max(fhs_egg$lon), length.out = nlon)
grid_vc_eggfhs_t <- expand.grid(lond, latd)
names(grid_vc_eggfhs_t) <- c('lon', 'lat')
grid_vc_eggfhs_t$dist <- NA
for (k in 1:nrow(grid_vc_eggfhs_t)) {
  dist <-  distance_function(grid_vc_eggfhs_t$lat[k],
                             grid_vc_eggfhs_t$lon[k],
                             fhs_egg$lat,
                             fhs_egg$lon)
  grid_vc_eggfhs_t$dist[k] <- min(dist)
}
grid_vc_eggfhs_t$year <- 2014
grid_vc_eggfhs_t$doy <- median(fhs_egg$doy)
grid_vc_eggfhs_t$mean_temp <- mean(fhs_egg$mean_temp)
grid_vc_eggfhs_t$roms_temperature <- mean(fhs_egg$roms_temperature, na.rm = T)
grid_vc_eggfhs_t$roms_salinity <- mean(fhs_egg$roms_salinity, na.rm = T)
grid_vc_eggfhs_t$pred <- predict(fhs_egg_space2_t, newdata = grid_vc_eggfhs_t)
grid_vc_eggfhs_t$se <- predict(fhs_egg_space2_t, newdata = grid_vc_eggfhs_t, se = T)[[2]]
grid_vc_eggfhs_t$pred_up <- grid_vc_eggfhs_t$pred + 1.96 * grid_vc_eggfhs_t$se
grid_vc_eggfhs_t$pred_lw <- grid_vc_eggfhs_t$pred - 1.96 * grid_vc_eggfhs_t$se
grid_vc_eggfhs_t$pred[grid_vc_eggfhs_t$dist > 30000] <- NA
grid_vc_eggfhs_t$mean_temp <- mean(fhs_egg$mean_temp) + 1
grid_vc_eggfhs_t$pred2 <- predict(fhs_egg_space2_t, newdata = grid_vc_eggfhs_t)
grid_vc_eggfhs_t$se2 <- predict(fhs_egg_space2_t, newdata = grid_vc_eggfhs_t, se = T)[[2]]
grid_vc_eggfhs_t$pred2_up <- grid_vc_eggfhs_t$pred2 + 1.96 * grid_vc_eggfhs_t$se2
grid_vc_eggfhs_t$pred2_lw <- grid_vc_eggfhs_t$pred2 - 1.96 * grid_vc_eggfhs_t$se2
grid_vc_eggfhs_t$diff <- grid_vc_eggfhs_t$pred2 - grid_vc_eggfhs_t$pred
grid_vc_eggfhs_t$sig_pos <- c(grid_vc_eggfhs_t$pred2_lw > grid_vc_eggfhs_t$pred_up)
grid_vc_eggfhs_t$sig_neg <- c(grid_vc_eggfhs_t$pred2_up < grid_vc_eggfhs_t$pred_lw)
grid_vc_eggfhs_t$pos_diff <- grid_vc_eggfhs_t$diff * grid_vc_eggfhs_t$sig_pos
grid_vc_eggfhs_t$neg_diff <- grid_vc_eggfhs_t$diff * grid_vc_eggfhs_t$sig_neg
max_slope <- max(grid_vc_eggfhs_t$diff, na.rm = T)
```

Temporal grid
```{r}
grid_vc_eggfhs2_t <-  data.frame('lon' = rep(-170, 100),
                           'lat' = rep(57, 100),
                           'doy' = seq(min(fhs_egg$doy), 
                                       max(fhs_egg$doy), 
                                       length = 100),
                           mean_temp = rep(mean(fhs_egg$mean_temp), 100),
                           'year' = rep(2014, 100),
                           'roms_temperature' = rep(mean(fhs_egg$roms_temperature, na.rm = T), 100),
                           'roms_salinity' = rep(mean(fhs_egg$roms_salinity, na.rm = T), 100))
grid_vc_eggfhs2_t$pred <- predict(fhs_egg_month5_t, newdata = grid_vc_eggfhs2_t)
grid_vc_eggfhs2_t$se <- predict(fhs_egg_month5_t, newdata = grid_vc_eggfhs2_t, se = T)[[2]]
grid_vc_eggfhs2_t$pred_up <- grid_vc_eggfhs2_t$pred + 1.96 * grid_vc_eggfhs2_t$se
grid_vc_eggfhs2_t$pred_lw <- grid_vc_eggfhs2_t$pred - 1.96 * grid_vc_eggfhs2_t$se
grid_vc_eggfhs2_t$mean_temp <- mean(fhs_egg$mean_temp) + 1
grid_vc_eggfhs2_t$pred2 <- predict(fhs_egg_month5_t, newdata = grid_vc_eggfhs2_t)
grid_vc_eggfhs2_t$se2 <- predict(fhs_egg_month5_t, newdata = grid_vc_eggfhs2_t, se = T)[[2]]
grid_vc_eggfhs2_t$pred2_up <- grid_vc_eggfhs2_t$pred2 + 1.96 * grid_vc_eggfhs2_t$se2
grid_vc_eggfhs2_t$pred2_lw <- grid_vc_eggfhs2_t$pred2 - 1.96 * grid_vc_eggfhs2_t$se2
```

Create three panel plot map of distribution & phenology curves with +1 temperature change
Make map with the best gam (spatial or temporal)
```{r}
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc(fhs_egg, fhs_egg_space2_t, 
       grid_vc_eggfhs_t, 
       grid_vc_eggfhs2_t,
       "Spatial GAM hindcast")
  legend(140,
         0.5,
         legend = c('Mean SST', '+ 1C'),
         col = c('#000000', '#E69F00'),
         lty = 1,
         bty = 'n',
         lwd = 2,
         cex = 1.2)
  dev.copy(jpeg,
         here('results/flathead_hindcast', 
              'flathead_egg_best_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```



## Larvae

Models with flexible phenology or geography 
Note variable coefficient by year for each
```{r}
fhs_larvae_phenology_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) + 
                          s(doy) +
                          s(lon, lat) + 
                          s(doy, by = factor(year)), 
                        data = fhs_larvae,
                        family = tw(link = 'log'),
                        method = 'REML')
summary(fhs_larvae_phenology_t)
AIC(fhs_larvae_phenology_t)
# AIC: 32891

fhs_larvae_geography_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                          s(lon, lat) +
                          s(lon, lat, by = factor(year)) +
                          s(doy), 
                        data = fhs_larvae,
                        family = tw(link = 'log'),
                        method = 'REML')
summary(fhs_larvae_geography_t)
AIC(fhs_larvae_geography_t)
# AIC: 31370
```

Ratio for comparison between base and flexible models 
Use to look at mean square error, base should have higher error
```{r}
ratio_fhslarvae_phenology_t <- (summary(fhs_larvae_base_t)$scale - 
                      summary(fhs_larvae_phenology_t)$scale) / summary(fhs_larvae_base_t)$scale
ratio_fhslarvae_phenology_t # 0.119

ratio_fhslarvae_geography_t <- (summary(fhs_larvae_base_t)$scale - 
                      summary(fhs_larvae_geography_t)$scale) / summary(fhs_larvae_base_t)$scale
ratio_fhslarvae_geography_t # 0.426
```

Add ROMS mean temperatures Use a representative area with averaged values from Feb - April for each year This can then be matched to the larvae/larvae data for use in variable coefficient by SST instead of year as above

Phenology Compare formulations with temp/salinity formulations
```{r}
# Add monthly temperature values from ROMS
fhs_larvae$mean_temp <- roms_temps$mean[match(fhs_larvae$year, roms_temps$year)]
range(fhs_larvae$mean_temp)

# This will again use the presence GAM from the two stage models
# create variable phenology model by adding doy*sst
fhs_larvae_month1_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                         s(doy, k = 8) +
                         s(lon, lat) +
                         s(roms_temperature, k = 6) +
                         s(roms_salinity, k = 6), 
                       data = fhs_larvae,
                       family = tw(link = 'log'),
                       method = 'REML')
summary(fhs_larvae_month1_t)
AIC(fhs_larvae_month1_t)
# Deviance explained: 59.4%
# AIC: 32821
par(mfrow = c(2, 2))
gam.check(fhs_larvae_month1_t)


fhs_larvae_month2_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                         s(doy, k = 8) +
                         s(lon, lat) +
                         s(roms_temperature, k = 6) +
                         s(roms_salinity, k = 6) +
                         s(doy, by = mean_temp, k = 6),
                       data = fhs_larvae,
                       family = tw(link = 'log'),
                       method = 'REML')
summary(fhs_larvae_month2_t)
AIC(fhs_larvae_month2_t)
# Deviance explained: 59.8%
# AIC: 32794
par(mfrow = c(2, 2))
gam.check(fhs_larvae_month2_t)


fhs_larvae_month3_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                         s(doy, k = 8) +
                         s(lon, lat) +
                         s(roms_temperature, roms_salinity),
                       data = fhs_larvae,
                       family = tw(link = 'log'),
                       method = 'REML')
summary(fhs_larvae_month3_t)
AIC(fhs_larvae_month3_t)
# Deviance explained: 61.8%
# AIC: 32627
par(mfrow = c(2, 2))
gam.check(fhs_larvae_month3_t)


fhs_larvae_month4_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                         s(doy, k = 8) +
                         s(lon, lat) +
                         s(roms_temperature, roms_salinity) +
                         s(roms_temperature, k = 6) +
                         s(roms_salinity, k = 6),
                       data = fhs_larvae,
                       family = tw(link = 'log'),
                       method = 'REML')
summary(fhs_larvae_month4_t)
AIC(fhs_larvae_month4_t)
# Deviance explained: 62.1%
# AIC: 32606
par(mfrow = c(2, 2))
gam.check(fhs_larvae_month4_t)


fhs_larvae_month5_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                         s(doy, k = 8) +
                         s(lon, lat) +
                         s(roms_temperature, roms_salinity) +
                         s(roms_temperature) +
                         s(roms_salinity, k = 6) +
                         s(doy, by = mean_temp, k = 6),
                       data = fhs_larvae,
                       family = tw(link = 'log'),
                       method = 'REML')
summary(fhs_larvae_month5_t)
AIC(fhs_larvae_month5_t)
# Deviance explained: 62.4%
# AIC: 32584
par(mfrow = c(2, 2))
gam.check(fhs_larvae_month5_t)
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(fhs_larvae_month5_t, select = 1, main = "DOY")
plot(fhs_larvae_month5_t, select = 4, main = "Temperature")
plot(fhs_larvae_month5_t, select = 5, main = "Salinity")
plot(fhs_larvae_month5_t, select = 6, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_larvae_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(fhs_larvae_month5_t)
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_larvae_roms_monthvc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

Geography Compare formulations with temp/salinity smooth terms
```{r}
# Create variable geography using space*sst
# Compare to the first three phenology models for model selection
fhs_larvae_space1_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                         s(doy, k = 8) +
                         s(lon, lat) +
                         s(roms_temperature, k = 6) +
                         s(roms_salinity, k = 6) +
                         s(lon, lat, by = mean_temp, k = 6),
                       data = fhs_larvae,
                       family = tw(link = 'log'),
                       method = 'REML')
summary(fhs_larvae_space1_t)
AIC(fhs_larvae_space1_t)
# Deviance explained: 60.6%
# AIC: 32717
par(mfrow = c(2, 2))
gam.check(fhs_larvae_space1_t)


fhs_larvae_space2_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                       s(doy, k = 8) +
                       s(lon, lat) +
                       s(roms_temperature, roms_salinity) +
                       s(roms_temperature) +
                       s(roms_salinity, k = 6) +
                       s(lon, lat, by = mean_temp, k = 6),
                     data = fhs_larvae,
                     family = tw(link = 'log'),
                     method = 'REML')
summary(fhs_larvae_space2_t)
AIC(fhs_larvae_space2_t)
# Deviance explained: 63.1%
# AIC: 32509
par(mfrow = c(2, 2))
gam.check(fhs_larvae_space2_t)
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(fhs_larvae_space2_t, select = 1, main = "DOY")
plot(fhs_larvae_space2_t, select = 4, main = "Temperature")
plot(fhs_larvae_space2_t, select = 5, main = "Salinity")
plot(fhs_larvae_space2_t, select = 6, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_larvae_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(fhs_larvae_space2_t)
dev.copy(jpeg, here('results/flathead_hindcast', 'flathead_larvae_roms_spacevc_resid_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()
```

VC GAM ratios
```{r}
# Use the original presence model from before
var_ratio_fhslarvae_month_t <- (summary(fhs_larvae_base_t)$scale - 
                         summary(fhs_larvae_month2_t)$scale) / summary(fhs_larvae_base_t)$scale
var_ratio_fhslarvae_month_t 

var_ratio_fhslarvae_space_t <- (summary(fhs_larvae_base_t)$scale - 
                         summary(fhs_larvae_space1_t)$scale) / summary(fhs_larvae_base_t)$scale
var_ratio_fhslarvae_space_t
```

Plot the results of the GAMs that vary by year This generates a three panel figure with a map, phenology curve, and MSE barplot Grids:
```{r}
# Plot the results of the average geography and phenology and decrease of MSE
nlat = 80
nlon = 120
latd = seq(min(fhs_larvae$lat), max(fhs_larvae$lat), length.out = nlat)
lond = seq(min(fhs_larvae$lon), max(fhs_larvae$lon), length.out = nlon)
grid_fhslarvae_avg_t <- expand.grid(lond, latd)
names(grid_fhslarvae_avg_t) <- c('lon', 'lat')

# Geography grid
grid_fhslarvae_avg_t$dist <- NA
for (k in 1:nrow(grid_fhslarvae_avg_t)) {
  dist <-
    distance_function(grid_fhslarvae_avg_t$lat[k],
                      grid_fhslarvae_avg_t$lon[k],
                      fhs_larvae$lat,
                      fhs_larvae$lon)
  grid_fhslarvae_avg_t$dist[k] <- min(dist)
}
grid_fhslarvae_avg_t$year <- 2014
grid_fhslarvae_avg_t$doy <- median(fhs_larvae$doy)
grid_fhslarvae_avg_t$pred <- predict(fhs_larvae_base_t, newdata = grid_fhslarvae_avg_t)
grid_fhslarvae_avg_t$pred[grid_fhslarvae_avg_t$dist > 30000] <- NA

# Phenology grid
grid_fhslarvae_avg_t2 <-  data.frame('lon' = rep(-170, 100),
                                'lat' = rep(57, 100),
                                'doy' = seq(min(fhs_larvae$doy), 
                                            max(fhs_larvae$doy), 
                                            length = 100),
                                'year' = rep(2014, 100))
grid_fhslarvae_avg_t2$pred <- predict(fhs_larvae_base_t, newdata = grid_fhslarvae_avg_t2)
grid_fhslarvae_avg_t2$se <- predict(fhs_larvae_base_t, newdata = grid_fhslarvae_avg_t2, se = T)[[2]]
grid_fhslarvae_avg_t2$pred_up <- grid_fhslarvae_avg_t2$pred + 1.96 * grid_fhslarvae_avg_t2$se
grid_fhslarvae_avg_t2$pred_lw <- grid_fhslarvae_avg_t2$pred - 1.96 * grid_fhslarvae_avg_t2$se
```

Plots:
```{r}
# Map & curve
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_phenology(fhs_larvae, grid_fhslarvae_avg_t, grid_fhslarvae_avg_t2)

# Plot MSE as stacked bars, including year variability and SST variability
barplot(matrix(c(ratio_fhslarvae_geography_t,
                 var_ratio_fhslarvae_space_t,
                 ratio_fhslarvae_phenology_t,
                 var_ratio_fhslarvae_month_t) * 100, 
               ncol = 2,
               nrow = 2),
        ylab = 'Delta MSE (%)',
        names.arg = c('Variable distribution', 'Variable phenologies'),
        ylim = c(0, 50),
        main = 'Delta MSE',
        cex.lab = 1.1,
        cex.main = 1.2,
        cex.axis = 1.1,
        cex.names = 1.1,
        space = c(0, 1),
        beside = T,
        col = c('azure4', 'azure3'))
box()
legend("topright",
       legend = c('D-MSE|Year', 'D-MSE|SST'),
       bty = 'n',
       col = c('azure4', 'azure3'),
       pch = 15,
       pt.cex = 2.5,
       cex = 1.1)
dev.copy(jpeg,
         here('results/flathead_hindcast', 
              'flathead_larvae_MSE_t.jpg'),
         height = 3.5,
         width = 12,
         res = 200,
         units = 'in')
```

Fill grids with output from SST VC GAMs Spatial grid
```{r}
nlat = 80
nlon = 120
latd = seq(min(fhs_larvae$lat), max(fhs_larvae$lat), length.out = nlat)
lond = seq(min(fhs_larvae$lon), max(fhs_larvae$lon), length.out = nlon)
grid_vc_larvaefhs_t <- expand.grid(lond, latd)
names(grid_vc_larvaefhs_t) <- c('lon', 'lat')
grid_vc_larvaefhs_t$dist <- NA
for (k in 1:nrow(grid_vc_larvaefhs_t)) {
  dist <-  distance_function(grid_vc_larvaefhs_t$lat[k],
                             grid_vc_larvaefhs_t$lon[k],
                             fhs_larvae$lat,
                             fhs_larvae$lon)
  grid_vc_larvaefhs_t$dist[k] <- min(dist)
}
grid_vc_larvaefhs_t$year <- 2014
grid_vc_larvaefhs_t$doy <- median(fhs_larvae$doy)
grid_vc_larvaefhs_t$mean_temp <- mean(fhs_larvae$mean_temp)
grid_vc_larvaefhs_t$roms_temperature <- mean(fhs_larvae$roms_temperature, na.rm = T)
grid_vc_larvaefhs_t$roms_salinity <- mean(fhs_larvae$roms_salinity, na.rm = T)
grid_vc_larvaefhs_t$pred <- predict(fhs_larvae_space2_t, newdata = grid_vc_larvaefhs_t)
grid_vc_larvaefhs_t$se <- predict(fhs_larvae_space2_t, newdata = grid_vc_larvaefhs_t, se = T)[[2]]
grid_vc_larvaefhs_t$pred_up <- grid_vc_larvaefhs_t$pred + 1.96 * grid_vc_larvaefhs_t$se
grid_vc_larvaefhs_t$pred_lw <- grid_vc_larvaefhs_t$pred - 1.96 * grid_vc_larvaefhs_t$se
grid_vc_larvaefhs_t$pred[grid_vc_larvaefhs_t$dist > 30000] <- NA
grid_vc_larvaefhs_t$mean_temp <- mean(fhs_larvae$mean_temp) + 1
grid_vc_larvaefhs_t$pred2 <- predict(fhs_larvae_space2_t, newdata = grid_vc_larvaefhs_t)
grid_vc_larvaefhs_t$se2 <- predict(fhs_larvae_space2_t, newdata = grid_vc_larvaefhs_t, se = T)[[2]]
grid_vc_larvaefhs_t$pred2_up <- grid_vc_larvaefhs_t$pred2 + 1.96 * grid_vc_larvaefhs_t$se2
grid_vc_larvaefhs_t$pred2_lw <- grid_vc_larvaefhs_t$pred2 - 1.96 * grid_vc_larvaefhs_t$se2
grid_vc_larvaefhs_t$diff <- grid_vc_larvaefhs_t$pred2 - grid_vc_larvaefhs_t$pred
grid_vc_larvaefhs_t$sig_pos <- c(grid_vc_larvaefhs_t$pred2_lw > grid_vc_larvaefhs_t$pred_up)
grid_vc_larvaefhs_t$sig_neg <- c(grid_vc_larvaefhs_t$pred2_up < grid_vc_larvaefhs_t$pred_lw)
grid_vc_larvaefhs_t$pos_diff <- grid_vc_larvaefhs_t$diff * grid_vc_larvaefhs_t$sig_pos
grid_vc_larvaefhs_t$neg_diff <- grid_vc_larvaefhs_t$diff * grid_vc_larvaefhs_t$sig_neg
max_slope <- max(grid_vc_larvaefhs_t$diff, na.rm = T)
```

Temporal grid
```{r}
grid_vc_larvaefhs2_t <-  data.frame('lon' = rep(-170, 100),
                           'lat' = rep(57, 100),
                           'doy' = seq(min(fhs_larvae$doy), 
                                       max(fhs_larvae$doy), 
                                       length = 100),
                           mean_temp = rep(mean(fhs_larvae$mean_temp), 100),
                           'year' = rep(2014, 100),
                           'roms_temperature' = rep(mean(fhs_larvae$roms_temperature, na.rm = T), 100),
                           'roms_salinity' = rep(mean(fhs_larvae$roms_salinity, na.rm = T), 100))
grid_vc_larvaefhs2_t$pred <- predict(fhs_larvae_month5_t, newdata = grid_vc_larvaefhs2_t)
grid_vc_larvaefhs2_t$se <- predict(fhs_larvae_month5_t, newdata = grid_vc_larvaefhs2_t, se = T)[[2]]
grid_vc_larvaefhs2_t$pred_up <- grid_vc_larvaefhs2_t$pred + 1.96 * grid_vc_larvaefhs2_t$se
grid_vc_larvaefhs2_t$pred_lw <- grid_vc_larvaefhs2_t$pred - 1.96 * grid_vc_larvaefhs2_t$se
grid_vc_larvaefhs2_t$mean_temp <- mean(fhs_larvae$mean_temp) + 1
grid_vc_larvaefhs2_t$pred2 <- predict(fhs_larvae_month5_t, newdata = grid_vc_larvaefhs2_t)
grid_vc_larvaefhs2_t$se2 <- predict(fhs_larvae_month5_t, newdata = grid_vc_larvaefhs2_t, se = T)[[2]]
grid_vc_larvaefhs2_t$pred2_up <- grid_vc_larvaefhs2_t$pred2 + 1.96 * grid_vc_larvaefhs2_t$se2
grid_vc_larvaefhs2_t$pred2_lw <- grid_vc_larvaefhs2_t$pred2 - 1.96 * grid_vc_larvaefhs2_t$se2
```

Create two panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
par(mfrow = c(1, 2), 
    mai = c(0.8, 0.9, 0.5, 0.5),
    family = "serif")
map_vc(fhs_larvae, grid_vc_larvaefhs_t, grid_vc_larvaefhs2_t)
  legend(140,
         11,
         legend = c('Mean SST', '+ 1C'),
         col = c('#000000', '#E69F00'),
         lty = 1,
         bty = 'n',
         lwd = 2,
         cex = 0.6)
dev.copy(jpeg,
         here('results/flathead_hindcast',
         'flathead_larvae_vc_t.jpg'),
         height = 3.5,
         width = 8,
         res = 200,
         units = 'in')
dev.off()
```