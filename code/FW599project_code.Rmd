---
title: "FW 599 Project"
author: "Rebecca Howard"
date: "10/18/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(marmap)
library(maps)
library(mapdata)
library(fields)
library(here)
library(mgcv)
library(tidyr)
library(dplyr)
library(ggplot2)
library(raster)
library(rgdal)
library(viridis)
library(dismo)
library(gbm)
library(blockCV)
library(sf)
library(RANN)
source(here('code/functions', 'vis_gam_COLORS.R'))
source(here('code/functions', 'distance_function.R'))
source(here('code/functions', 'gam_selection.R'))
source(here('code/functions', 'map_vc.R'))
source(here('code/functions', 'map_phenology.R'))
source(here('code/functions', 'threepanel_base_mse.R'))
source(here('code/functions', 'vc_grids.R'))
source(here('code/functions', 'plot_variable.R'))
source(here('code/functions', 'location_plot.R'))

# Load fish data
pk_egg <- readRDS(here('data', 'pk_egg.rds'))
pk_larvae <- readRDS(here('data', 'pk_larvae.rds'))

# Load ROMS temperature means
roms_temps <- readRDS(here('data', 'roms_temps.rds'))
```

Split into train and test (original)
```{r}
pk_egg <- as.data.frame(pk_egg)
pk_egg$presence <- 1 * (pk_egg$count > 0)
pk_egg <- na.omit(pk_egg)
pk_egg$abundance <- log(pk_egg$larvalcatchper10m2 + 1)
pk_egg$offset <- log(pk_egg$volume_filtered)

npoints = nrow(pk_egg) / 2
set.seed(1993)
points = sample_n(pk_egg, npoints, sp = TRUE)
lat_lons = pk_egg[c('lat', 'lon')]
pkegg_train_data = pk_egg[1:(npoints / 2), ]
pkegg_test_data = pk_egg[(npoints / 2 + 1):npoints, ]
```

Split into train and test (blockCV version)
Eggs:
```{r}
pk_egg$mean_temp <- roms_temps$mean[match(pk_egg$year, roms_temps$year)]
pk_egg <- as.data.frame(pk_egg)
pk_egg$presence <- 1 * (pk_egg$count > 0)
pk_egg <- na.omit(pk_egg)
pk_egg$abundance <- log(pk_egg$larvalcatchper10m2 + 1)
pk_egg$offset <- log(pk_egg$volume_filtered)
lat_lons = pk_egg[c('lat', 'lon')]

pkegg_spatial <- st_as_sf(pk_egg, coords = c("lat", "lon"))
pkegg_spatial

nfolds <- 5

pkegg_sb <- spatialBlock(speciesData = pkegg_spatial,
                         species = "presence",
                         rows = 5,
                         cols = 6,
                         k = nfolds,
                         selection = "systematic",
                         biomod2Format = T)

pkegg_spatial <- cbind(fold <- pkegg_sb$foldID,
                       pkegg_spatial)

pk_egg <- st_drop_geometry(pkegg_spatial)
pk_egg <- cbind(lat_lons, pk_egg)
colnames(pk_egg)[3] <- "folds"

pkegg_train_data <- pk_egg[pk_egg$folds == nfolds, ]
pkegg_test_data <- pk_egg[pk_egg$folds != nfolds, ]
```

```{r}
pk_larvae$mean_temp <- roms_temps$mean[match(pk_larvae$year, roms_temps$year)]
pk_larvae <- as.data.frame(pk_larvae)
pk_larvae$presence <- 1 * (pk_larvae$count > 0)
pk_larvae <- na.omit(pk_larvae)
pk_larvae$abundance <- log(pk_larvae$larvalcatchper10m2 + 1)
pk_larvae$offset <- log(pk_larvae$volume_filtered)
lat_lons = pk_larvae[c('lat', 'lon')]

pklarvae_spatial <- st_as_sf(pk_larvae, coords = c("lat", "lon"))
pklarvae_spatial

nfolds <- 5

pklarvae_sb <- spatialBlock(speciesData = pklarvae_spatial,
                         species = "presence",
                         rows = 5,
                         cols = 6,
                         k = nfolds,
                         selection = "systematic",
                         biomod2Format = T)

pklarvae_spatial <- cbind(fold <- pklarvae_sb$foldID,
                       pklarvae_spatial)

pk_larvae <- st_drop_geometry(pklarvae_spatial)
pk_larvae <- cbind(lat_lons, pk_larvae)
colnames(pk_larvae)[3] <- "folds"

pklarvae_train_data <- pk_larvae[pk_larvae$folds == nfolds, ]
pklarvae_test_data <- pk_larvae[pk_larvae$folds != nfolds, ]
```

### Tweedie
Base models
```{r}
# Tweedie
pk_egg_base_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                       s(lon, lat) + 
                       s(doy),
                    data = pkegg_train_data,
                    family = tw(link = 'log'),
                    method = 'REML')
summary(pk_egg_base_t)

pk_larvae_base_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                       s(lon, lat) + 
                       s(doy),
                    data = pklarvae_train_data,
                    family = tw(link = 'log'),
                    method = 'REML')
summary(pk_larvae_base_t)
```

## Eggs
Determine best GAM from 7 formulations (see function)
```{r}
pkegg_gams_t <- gam_selection(pkegg_train_data, roms_temps)
AIC(pkegg_gams_t[[1]][[1]]) #12733
AIC(pkegg_gams_t[[1]][[2]]) #12734
AIC(pkegg_gams_t[[1]][[3]]) #12715
summary(pkegg_gams_t[[2]]) # best model is spatial VC, retain all smooth terms
AIC(pkegg_gams_t[[1]][[1]]) - AIC(pkegg_gams_t[[1]][[3]]) #18.0
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(pkegg_gams_t[[1]][[2]], select = 1, main = "DOY")
plot(pkegg_gams_t[[1]][[2]], select = 3, main = "Temperature")
plot(pkegg_gams_t[[1]][[2]], select = 4, main = "Salinity")
plot(pkegg_gams_t[[1]][[2]], select = 5, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pkegg_gams_t[[1]][[2]])
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(pkegg_gams_t[[1]][[3]], select = 1, main = "DOY")
plot(pkegg_gams_t[[1]][[3]], select = 3, main = "Temperature")
plot(pkegg_gams_t[[1]][[3]], select = 4, main = "Salinity")
plot(pkegg_gams_t[[1]][[3]], select = 5, main = "Location by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_egg_roms_spacevc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pkegg_gams_t[[1]][[3]])
```

Fill grids with output from SST VC GAMs
```{r}
pkegg_vcgrids_t <- vc_grids(pkegg_train_data, pkegg_gams_t)
```

Create two panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc(pkegg_train_data, pkegg_gams_t[[2]], pkegg_vcgrids_t, "Spatial GAM hindcast")
legend(50,
       6,
       legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
       lty = 1,
       bty = 'n',
       lwd = 2,
       cex = 1.2)
```

## Larvae
Determine best GAM from 7 formulations (see function)
```{r}
pklarvae_gams_t <- gam_selection(pklarvae_train_data, roms_temps)
AIC(pklarvae_gams_t[[1]][[1]]) #11709
AIC(pklarvae_gams_t[[1]][[2]]) #11663
AIC(pklarvae_gams_t[[1]][[3]]) #11671
summary(pklarvae_gams_t[[2]]) # best model is spatial, retain all smooth terms
AIC(pklarvae_gams_t[[1]][[1]]) - AIC(pklarvae_gams_t[[2]]) #46.7
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(pklarvae_gams_t[[1]][[2]], select = 1, main = "DOY")
plot(pklarvae_gams_t[[1]][[2]], select = 3, main = "Temperature")
plot(pklarvae_gams_t[[1]][[2]], select = 4, main = "Salinity")
plot(pklarvae_gams_t[[1]][[2]], select = 5, main = "DOY by Mean ROMS SST")
dev.copy(jpeg, here('results/pollock_hindcast', 'pollock_larvae_roms_monthvc_t.jpg'), 
         height = 10, width = 10, units = 'in', res = 200)
dev.off()

par(mfrow = c(2, 2))
gam.check(pklarvae_gams_t[[1]][[2]])
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(pklarvae_gams_t[[1]][[3]], select = 1, main = "DOY")
plot(pklarvae_gams_t[[1]][[3]], select = 3, main = "Temperature")
plot(pklarvae_gams_t[[1]][[3]], select = 4, main = "Salinity")
plot(pklarvae_gams_t[[1]][[3]], select = 5, main = "Location by Mean ROMS SST")

par(mfrow = c(2, 2))
gam.check(pklarvae_gams_t[[1]][[3]])
```

Fill grids with output from SST VC GAMs
```{r}
pklarvae_vcgrids_t <- vc_grids(pklarvae_train_data, pklarvae_gams_t)
```

Create two panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
par(mfrow = c(1, 3), 
    mai = c(0.7, 0.6, 0.4, 0.4),
    family = "serif")
map_vc(pklarvae_train_data, pklarvae_gams_t[[2]], pklarvae_vcgrids_t, "Spatial GAM hindcast")
legend(50,
       2,
       legend = c('Mean SST', '+ 1C'),
       col = c('#000000', '#E69F00'),
       lty = 1,
       bty = 'n',
       lwd = 2,
       cex = 1.2)
```



### Boosted Regression Trees
Reference: [Example code](https://rspatial.org/raster/sdm/9_sdm_brt.html)

## Eggs
```{r}
brt_egg1 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.01,
                     bag.fraction = 0.5)

length(brt_egg1$fitted)
summary(brt_egg1)
```

Reduce the learning rate, too few trees above
```{r}
brt_egg2 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.001,
                     bag.fraction = 0.5)

length(brt_egg2$fitted)
summary(brt_egg2)
```

Slightly higher learning rate
```{r}
brt_egg3 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.005,
                     bag.fraction = 0.5)
length(brt_egg3$fitted)
summary(brt_egg3)
```

Tree complexity = 1
```{r}
brt_egg4 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 1,
                     learning.rate = 0.005,
                     bag.fraction = 0.5)
length(brt_egg4$fitted)
summary(brt_egg4)
```

Tree complexity = 10 
```{r}
brt_egg5 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.001,
                     bag.fraction = 0.5)
length(brt_egg5$fitted)
summary(brt_egg5)
```

```{r}
brt_egg6 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.01,
                     bag.fraction = 0.5)
length(brt_egg6$fitted)
summary(brt_egg6)
```

```{r}
brt_egg7 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.005,
                     bag.fraction = 0.5)
length(brt_egg7$fitted)
summary(brt_egg7)
```

```{r}
brt_egg8 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.005,
                     bag.fraction = 0.75)
length(brt_egg8$fitted)
summary(brt_egg8)
```

```{r}
brt_egg9 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.005,
                     bag.fraction = 0.25)
length(brt_egg9$fitted)
summary(brt_egg9)
```

Attempt dropping variables
```{r}
pkegg_simp <- gbm.simplify(brt_egg7, n.drops = 5)
summary(pkegg_simp)
```

Clear that two variables should be dropped
```{r}
pkegg_final <- gbm.step(pkegg_train_data,
                       gbm.x = pkegg_simp$pred.list[[2]], 
                       gbm.y = 21,
                       tree.complexity = 10, 
                       learning.rate = 0.005,
                       bag.fraction = 0.5,
                       family = "gaussian")
summary(pkegg_final)
```

Plot the variables
```{r}
gbm.plot(brt_egg3, 
         n.plots = 7, 
         plot.layout = c(3, 3), 
         write.title = F,
         smooth = T)
```

Plot the fits
```{r}
gbm.plot.fits(brt_egg3)
```

Find interactions
```{r}
pkegg_int <- gbm.interactions(brt_egg3)
pkegg_int$interactions

gbm.perspec(brt_egg3, 
            2, 3, 
            z.range = c(0, 6.64), 
            theta = 60,
            col = "light blue",
            cex.axis = 0.8,
            cex.lab = 1,
            ticktype = "detailed")
```



When ready, use to predict on test data
```{r}
preds <- predict.gbm(pkegg_final, 
                     pkegg_test_data,
                     n.trees = pkegg_final$gbm.call$best.trees, 
                     type = "response")
summary(preds)

calc.deviance(obs = pkegg_test_data$abundance,
              pred = preds,
              calc.mean = TRUE,
              family = "gaussian")

pkegg_test_data$pred <- predict.gbm(pkegg_final, 
                                    pkegg_test_data,
                                    n.trees = pkegg_final$gbm.call$best.trees,
                                    type = "response")
```

Create a grid, add predictions to it
```{r}
nlat = 160
nlon = 240
latd = seq(min(data$lat), max(data$lat), length.out = nlat)
lond = seq(min(data$lon), max(data$lon), length.out = nlon)
spatial_grid <- expand.grid(lond, latd)
names(spatial_grid) <- c('lon', 'lat')

# match nearest neighbor
spatial_grid[, c(3, 4)] <- as.data.frame(RANN::nn2(pkegg_test_data[, c(2, 1)], spatial_grid[, c(1, 2)], k = 1))
spatial_grid[, 5] <- pkegg_test_data[spatial_grid[, 3], 24]
spatial_grid <- spatial_grid[-c(3, 4)]
colnames(spatial_grid)[3] <- "pred"

spatial_grid$dist <- NA
  for (k in 1:nrow(spatial_grid)) {
    dist <-  distance_function(spatial_grid$lat[k],
                               spatial_grid$lon[k],
                               pk_egg$lat,
                               pk_egg$lon)
    spatial_grid$dist[k] <- min(dist)
  }
spatial_grid$pred[spatial_grid$dist > 30000] <- NA
```

Plot final SD map
```{r}
nlat = 80
nlon = 120
latd = seq(min(spatial_grid$lat), max(spatial_grid$lat), length.out = nlat)
lond = seq(min(spatial_grid$lon), max(spatial_grid$lon), length.out = nlon)
my_color = colorRampPalette(
  c("#1C0D51",
    "#4C408E",
    "#7E77B0",
    "#AFABCB",
    "#DAD9E5",
    "#F9F9F9",
    "#FFDAB7",
    "#FFB377",
    "#E18811",
    "#AC6000",
    "#743700"))
color_levels = 100
max_absolute_value = max(abs(c( min(spatial_grid$pred, na.rm = T),
                                max(spatial_grid$pred, na.rm = T))))
color_sequence = seq(-max_absolute_value, max_absolute_value,
                     length.out = color_levels + 1)
n_in_class = hist(spatial_grid$pred, breaks = color_sequence, plot = F)$counts > 0
col_to_include = min(which(n_in_class == T)):max(which(n_in_class == T))
breaks_to_include = min(which(n_in_class == T)):(max(which(n_in_class == T)) + 1)
image(lond,
      latd,
      t(matrix(
        spatial_grid$pred,
        nrow = length(latd),
        ncol = length(lond),
        byrow = T)),
      xlim = c(-176.5,-156.5),
      ylim = c(52, 62),
      axes = FALSE,
      xlab = "",
      ylab = "")
rect(par("usr")[1], par("usr")[3], par("usr")[2], par("usr")[4], col = "mintcream")
par(new = TRUE)
image(lond,
      latd,
      t(matrix(spatial_grid$pred,
                 nrow = length(latd),
                 ncol = length(lond),
               byrow = T)),
      col = my_color(n = color_levels)[col_to_include],
      breaks = color_sequence[breaks_to_include],
      ylab = "Latitude",
      xlab = "Longitude",
      xlim = c(-176.5,-156.5),
      ylim = c(52, 62),
      main = "Distribution",
      cex.main = 1.2,
      cex.lab = 1.1,
      cex.axis =  1.1)
symbols(pk_egg$lon[pk_egg$larvalcatchper10m2 > 0],
        pk_egg$lat[pk_egg$larvalcatchper10m2 > 0],
        circles = log(pk_egg$larvalcatchper10m2 + 1)[pk_egg$larvalcatchper10m2 > 0],
        inches = 0.1,
        bg = alpha('black', 0.2),
        fg = alpha('black', 0.1),
        add = T)
points(pk_egg$lon[pk_egg$larvalcatchper10m2 == 0],
       pk_egg$lat[pk_egg$larvalcatchper10m2 == 0],
       pch =  '')
maps::map("worldHires",
          fill = T,
          col = "wheat4",
          add = T)
```

