---
title: "FW 599 Project"
author: "Rebecca Howard"
date: "10/18/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(marmap)
library(maps)
library(mapdata)
library(fields)
library(here)
library(mgcv)
library(tidyr)
library(dplyr)
library(ggplot2)
library(raster)
library(rgdal)
library(viridis)
library(dismo)
library(gbm)
library(blockCV)
library(sf)
library(RANN)
library(MASS)
source(here('code/functions', 'vis_gam_COLORS.R'))
source(here('code/functions', 'distance_function.R'))
source(here('code/functions', 'gam_selection.R'))
source(here('code/functions', 'map_vc.R'))
source(here('code/functions', 'map_phenology.R'))
source(here('code/functions', 'threepanel_base_mse.R'))
source(here('code/functions', 'vc_grids.R'))
source(here('code/functions', 'plot_variable.R'))
source(here('code/functions', 'location_plot.R'))

# Load fish data
pk_egg <- as.data.frame(filter((readRDS(here('data', 'pk_egg.rds'))),
                 lat >= 52 & lat <= 62,
                  lon >= -176.5 & lon <= -156.5))
pk_larvae <- as.data.frame(filter(readRDS(here('data', 'pk_larvae.rds')),
                 lat >= 52 & lat <= 62,
                  lon >= -176.5 & lon <= -156.5))

# Load ROMS temperature means
roms_temps <- readRDS(here('data', 'roms_temps.rds'))
```

Split into train and test (original)
```{r}
# pk_egg <- as.data.frame(pk_egg)
# pk_egg$presence <- 1 * (pk_egg$count > 0)
# pk_egg <- na.omit(pk_egg)
# pk_egg$abundance <- log(pk_egg$larvalcatchper10m2 + 1)
# pk_egg$offset <- log(pk_egg$volume_filtered)
# 
# npoints = nrow(pk_egg) / 2
# set.seed(1993)
# points = sample_n(pk_egg, npoints, sp = TRUE)
# lat_lons = pk_egg[c('lat', 'lon')]
# pkegg_train_data = pk_egg[1:(npoints / 2), ]
# pkegg_test_data = pk_egg[(npoints / 2 + 1):npoints, ]
```

Split into train and test (blockCV version)
Eggs:
```{r}
set.seed(1993)
pk_egg$mean_temp <- roms_temps$mean[match(pk_egg$year, roms_temps$year)]
pk_egg <- as.data.frame(pk_egg)
pk_egg$presence <- 1 * (pk_egg$count > 0)
pk_egg <- na.omit(pk_egg)
pk_egg$abundance <- log(pk_egg$larvalcatchper10m2 + 1)
pk_egg$offset <- log(pk_egg$volume_filtered)
lat_lons = pk_egg[c('lat', 'lon')]

pkegg_spatial <- st_as_sf(pk_egg, coords = c("lat", "lon"))
pkegg_spatial

nfolds <- 2

pkegg_sb <- spatialBlock(speciesData = pkegg_spatial,
                         species = "presence",
                         rows = 5,
                         cols = 6,
                         selection = "checkerboard",
                         biomod2Format = T)

pkegg_spatial <- cbind(fold <- pkegg_sb$foldID,
                       pkegg_spatial)

pk_egg <- st_drop_geometry(pkegg_spatial)
pk_egg <- cbind(lat_lons, pk_egg)
colnames(pk_egg)[3] <- "folds"

pkegg_train_data <- pk_egg[pk_egg$folds == nfolds, ]
pkegg_test_data <- pk_egg[pk_egg$folds != nfolds, ]
```

```{r}
set.seed(1993)
pk_larvae$mean_temp <- roms_temps$mean[match(pk_larvae$year, roms_temps$year)]
pk_larvae <- as.data.frame(pk_larvae)
pk_larvae$presence <- 1 * (pk_larvae$count > 0)
pk_larvae <- na.omit(pk_larvae)
pk_larvae$abundance <- log(pk_larvae$larvalcatchper10m2 + 1)
pk_larvae$offset <- log(pk_larvae$volume_filtered)
lat_lons = pk_larvae[c('lat', 'lon')]

pklarvae_spatial <- st_as_sf(pk_larvae, coords = c("lat", "lon"))
pklarvae_spatial

nfolds <- 2

pklarvae_sb <- spatialBlock(speciesData = pklarvae_spatial,
                         species = "presence",
                         rows = 5,
                         cols = 6,
                         selection = "checkerboard",
                         biomod2Format = T)

pklarvae_spatial <- cbind(fold <- pklarvae_sb$foldID,
                       pklarvae_spatial)

pk_larvae <- st_drop_geometry(pklarvae_spatial)
pk_larvae <- cbind(lat_lons, pk_larvae)
colnames(pk_larvae)[3] <- "folds"

pklarvae_train_data <- pk_larvae[pk_larvae$folds == nfolds, ]
pklarvae_test_data <- pk_larvae[pk_larvae$folds != nfolds, ]
```

### Tweedie
Base models
```{r}
# Tweedie
pk_egg_base_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                       s(lon, lat) + 
                       s(doy),
                    data = pkegg_train_data,
                    family = tw(link = 'log'),
                    method = 'REML')
summary(pk_egg_base_t)

pk_larvae_base_t <- gam(larvalcatchper10m2 + 1 ~ factor(year) +
                       s(lon, lat) + 
                       s(doy),
                    data = pklarvae_train_data,
                    family = tw(link = 'log'),
                    method = 'REML')
summary(pk_larvae_base_t)
```

## Eggs
Determine best GAM from 7 formulations (see function)
```{r}
pkegg_gams_t <- gam_selection(pkegg_train_data, roms_temps)
AIC(pkegg_gams_t[[1]][[1]]) #12733
AIC(pkegg_gams_t[[1]][[2]]) #12734
AIC(pkegg_gams_t[[1]][[3]]) #12715
summary(pkegg_gams_t[[2]]) # best model is doy VC, retain all smooth terms
AIC(pkegg_gams_t[[1]][[1]]) - AIC(pkegg_gams_t[[1]][[3]]) # 21.3
```

Plot best model for phenology
```{r}
par(mfrow = c(2, 2))
plot(pkegg_gams_t[[1]][[3]], select = 1, main = "DOY")
plot(pkegg_gams_t[[1]][[3]], select = 3, main = "Temperature")
plot(pkegg_gams_t[[1]][[3]], select = 4, main = "Salinity")
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(pkegg_gams_t[[1]][[3]], select = 1, main = "DOY",
     shade = T, shade.col = "#eb8055b2", xlab = "Day of Year", 
     ylab = "Species Abundance Anomalies", seWithMean = T, 
     scale = 0, cex.axis = 1.2, cex.lab = 1.2, family = "serif", 
     lwd = 0.5, ylim = c(-5.5, 8))
plot(pkegg_gams_t[[1]][[3]], select = 3, main = "SST",
     shade = T, shade.col = "#eb8055b2", xlab = "Temperature", 
     ylab = "Species Abundance Anomalies", seWithMean = T, 
     scale = 0, cex.axis = 1.2, cex.lab = 1.2, family = "serif", 
     lwd = 0.5, ylim = c(-5.5, 8))
plot(pkegg_gams_t[[1]][[3]], select = 4, main = "SSS",
     shade = T, shade.col = "#eb8055b2", xlab = "Salinity", 
     ylab = "Species Abundance Anomalies", seWithMean = T, 
     scale = 0, cex.axis = 1.2, cex.lab = 1.2, family = "serif", 
     lwd = 0.5, ylim = c(-5.5, 8))
```

Fill grids with output from SST VC GAMs, performance metrics
```{r}
pkegg_vcgrids_t <- vc_grids(pkegg_test_data, pkegg_gams_t)

pkegg_test_data$pred <- predict(pkegg_gams_t[[1]][[3]], newdata = pkegg_test_data)
rmse_egg_gam <- sqrt(mean((pkegg_test_data$abundance - pkegg_test_data$pred)^2))
rmse_egg_gam # 2.89

pkegg_test_data <- pkegg_test_data[-c(23)]

summary(pkegg_gams_t[[1]][[3]]) # deviance explained: 61.4%
```

Create two panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
nlat = 80
nlon = 120
latd = seq(min(pk_egg$lat), max(pk_egg$lat), length.out = nlat)
lond = seq(min(pk_egg$lon), max(pk_egg$lon), length.out = nlon)
contour_col <- rgb(0, 0, 255, max = 255, alpha = 0, names = "white")

jet.colors = colorRampPalette(rev(c("#FFFFCC", "#FBF2A8", "#F9E585",
                                    "#F5D363", "#EFBA55", "#EAA352",
                                    "#E68C51", "#E0754F", "#D75C4D",
                                    "#BB4A48", "#994240", "#763931", 
                                    "#542D20", "#352311", "#191900")))
myvis_gam(pkegg_gams_t[[2]],
          view = c('lon', 'lat'),
          too.far = 0.04,
          plot.type = 'contour',
          contour.col = contour_col,
          color = "jet",
          type = 'link',
          xlim = c(-176.5,-156.5),
          ylim = c(52, 62),
          xlab = "",
          ylab = "",
          main = "",
          axes = FALSE)
rect(par("usr")[1], par("usr")[3], par("usr")[2], par("usr")[4], col = "mintcream")
par(new = TRUE)
myvis_gam(pkegg_gams_t[[2]],
          view = c('lon', 'lat'),
          too.far = 0.04,
          plot.type = 'contour',
          contour.col = contour_col,
          color = "jet" ,
          type = 'link',
          xlim = c(-176.5,-156.5),
          ylim = c(52, 62),
          family = "serif",
          xlab = "Longitude",
          ylab = "Latitude",
          main = "Distribution of Walleye Pollock Eggs (GAM)",
          cex.main = 1.5,
          cex.lab = 1.5,
          cex.axis = 1.5,
          zlim = c(-2.5, 12.5))
symbols(pk_egg$lon[pk_egg$larvalcatchper10m2 > 0],
        pk_egg$lat[pk_egg$larvalcatchper10m2 > 0],
        circles = log(pk_egg$larvalcatchper10m2 + 1)[pk_egg$larvalcatchper10m2 > 0],
        inches = 0.1,
        bg = alpha('grey', 0.3),
        fg = alpha('black', 0.1),
        add = T)
points(pk_egg$lon[pk_egg$larvalcatchper10m2 == 0],
       pk_egg$lat[pk_egg$larvalcatchper10m2 == 0],
       pch =  '')
maps::map('worldHires',
          add = T,
          col = 'wheat4',
          fill = T)
image.plot(legend.only = T,
           col = jet.colors(100),
           legend.shrink = 0.2,
           smallplot = c(.85, .88, .14, .38),
           legend.cex = 1,
           axis.args = list(cex.axis = 1.2),
           legend.width = 0.8,
           legend.mar = 6,
           zlim = c(-2.5, 12.5),
           legend.args = list("Occurrence",
                              side = 2, cex = 1.1))
```

## Larvae
Determine best GAM from 7 formulations (see function)
```{r}
pklarvae_gams_t <- gam_selection(pklarvae_train_data, roms_temps)
AIC(pklarvae_gams_t[[1]][[1]]) #11709
AIC(pklarvae_gams_t[[1]][[2]]) #11663
AIC(pklarvae_gams_t[[1]][[3]]) #11671
summary(pklarvae_gams_t[[2]]) # best model is doy, retain all smooth terms
AIC(pklarvae_gams_t[[1]][[1]]) - AIC(pklarvae_gams_t[[2]]) # 33.9
```

Plot best model for phenology
```{r}
# Best model by AIC is model 2
par(mfrow = c(2, 2))
plot(pklarvae_gams_t[[1]][[2]], select = 3, main = "SST",
     shade = T, shade.col = "#eb8055b2", xlab = "Temperature", 
     ylab = "Species Abundance Anomalies", seWithMean = T, 
     scale = 0, cex.axis = 1.2, cex.lab = 1.2, family = "serif", 
     lwd = 0.5, ylim = c(-5.5, 2))
plot(pklarvae_gams_t[[1]][[2]], select = 1, main = "DOY",
     shade = T, shade.col = "#eb8055b2", xlab = "Day of Year", 
     ylab = "Species Abundance Anomalies", seWithMean = T, 
     scale = 0, cex.axis = 1.2, cex.lab = 1.2, family = "serif", 
     lwd = 0.5, ylim = c(-5.5, 2))
plot(pklarvae_gams_t[[1]][[2]], select = 4, main = "SSS",
     shade = T, shade.col = "#eb8055b2", xlab = "Salinity", 
     ylab = "Species Abundance Anomalies", seWithMean = T, 
     scale = 0, cex.axis = 1.2, cex.lab = 1.2, family = "serif", 
     lwd = 0.5, ylim = c(-5.5, 2))
```

Plot best model for geography
```{r}
par(mfrow = c(2, 2))
plot(pklarvae_gams_t[[1]][[3]], select = 1, main = "DOY")
plot(pklarvae_gams_t[[1]][[3]], select = 3, main = "Temperature")
plot(pklarvae_gams_t[[1]][[3]], select = 4, main = "Salinity")
plot(pklarvae_gams_t[[1]][[3]], select = 5, main = "Location by Mean ROMS SST")

par(mfrow = c(2, 2))
gam.check(pklarvae_gams_t[[1]][[3]])
```

Fill grids with output from SST VC GAMs
```{r}
pklarvae_vcgrids_t <- vc_grids(pklarvae_test_data, pklarvae_gams_t)

pklarvae_test_data$pred <- predict(pklarvae_gams_t[[2]], newdata = pklarvae_test_data)
rmse_larvae_gam <- sqrt(mean((pklarvae_test_data$abundance - pklarvae_test_data$pred)^2))
rmse_larvae_gam # 2.73

pklarvae_test_data <- pklarvae_test_data[-c(23)]

summary(pklarvae_gams_t[[2]]) # deviance explained: 59.6%
```

Create two panel plot Map of distribution & phenology curves with +1 temperature change
```{r}
nlat = 80
nlon = 120
latd = seq(min(pk_larvae$lat), max(pk_larvae$lat), length.out = nlat)
lond = seq(min(pk_larvae$lon), max(pk_larvae$lon), length.out = nlon)
contour_col <- rgb(0, 0, 255, max = 255, alpha = 0, names = "white")

jet.colors = colorRampPalette(rev(c("#FFFFCC", "#FBF2A8", "#F9E585",
                                    "#F5D363", "#EFBA55", "#EAA352",
                                    "#E68C51", "#E0754F", "#D75C4D",
                                    "#BB4A48", "#994240", "#763931", 
                                    "#542D20", "#352311", "#191900")))
myvis_gam(pklarvae_gams_t[[2]],
          view = c('lon', 'lat'),
          too.far = 0.04,
          plot.type = 'contour',
          contour.col = contour_col,
          color = "jet",
          type = 'link',
          xlim = c(-176.5,-156.5),
          ylim = c(52, 62),
          xlab = "",
          ylab = "",
          main = "",
          axes = FALSE)
rect(par("usr")[1], par("usr")[3], par("usr")[2], par("usr")[4], col = "mintcream")
par(new = TRUE)
myvis_gam(pklarvae_gams_t[[2]],
          view = c('lon', 'lat'),
          too.far = 0.04,
          plot.type = 'contour',
          contour.col = contour_col,
          color = "jet" ,
          type = 'link',
          xlim = c(-176.5,-156.5),
          ylim = c(52, 62),
          family = "serif",
          xlab = "Longitude",
          ylab = "Latitude",
          main = "Distribution of Walleye Pollock Larvae (GAM)",
          cex.main = 1.5,
          cex.lab = 1.5,
          cex.axis = 1.5,
          zlim = c(-2.5, 12.5))
symbols(pk_larvae$lon[pk_larvae$larvalcatchper10m2 > 0],
        pk_larvae$lat[pk_larvae$larvalcatchper10m2 > 0],
        circles = log(pk_larvae$larvalcatchper10m2 + 1)[pk_larvae$larvalcatchper10m2 > 0],
        inches = 0.1,
        bg = alpha('grey', 0.3),
        fg = alpha('black', 0.1),
        add = T)
points(pk_larvae$lon[pk_larvae$larvalcatchper10m2 == 0],
       pk_larvae$lat[pk_larvae$larvalcatchper10m2 == 0],
       pch =  '')
maps::map('worldHires',
          add = T,
          col = 'wheat4',
          fill = T)
image.plot(legend.only = T,
           col = jet.colors(100),
           legend.shrink = 0.2,
           smallplot = c(.85, .88, .14, .38),
           legend.cex = 1,
           axis.args = list(cex.axis = 1.2),
           legend.width = 0.8,
           legend.mar = 6,
           zlim = c(-2.5, 12.5),
           legend.args = list("Occurrence",
                              side = 2, cex = 1.1))
```



### Boosted Regression Trees: Comparison Models
Reference: [Example code](https://rspatial.org/raster/sdm/9_sdm_brt.html)

## Eggs
```{r}
brt_pkegg1 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.01,
                     bag.fraction = 0.5)

length(brt_pkegg1$fitted)
summary(brt_pkegg1)
```

Reduce the learning rate, too few trees above
```{r}
brt_pkegg2 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.001,
                     bag.fraction = 0.5)

length(brt_pkegg2$fitted)
summary(brt_pkegg2)
```

Slightly higher learning rate
```{r}
brt_pkegg3 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.005,
                     bag.fraction = 0.5)
length(brt_pkegg3$fitted)
summary(brt_pkegg3)
```

Tree complexity = 1
```{r}
brt_pkegg4 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 1,
                     learning.rate = 0.005,
                     bag.fraction = 0.5)
length(brt_pkegg4$fitted)
summary(brt_pkegg4)
```

Tree complexity = 10 
```{r}
brt_pkegg5 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.001,
                     bag.fraction = 0.5)
length(brt_pkegg5$fitted)
summary(brt_pkegg5)
```

```{r}
brt_pkegg6 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.01,
                     bag.fraction = 0.5)
length(brt_pkegg6$fitted)
summary(brt_pkegg6)
```

```{r}
brt_pkegg7 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.01,
                     bag.fraction = 0.75)
length(brt_pkegg7$fitted)
summary(brt_pkegg7)

dev_egg_brt <- (brt_pkegg7$self.statistics$mean.null - brt_pkegg7$cv.statistics$deviance.mean) /
  brt_pkegg7$self.statistics$mean.null
dev_egg_brt # 50% deviance explained
```

```{r}
brt_pkegg8 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.01,
                     bag.fraction = 0.25)
length(brt_pkegg8$fitted)
summary(brt_pkegg8)
```


Attempt dropping variables
```{r}
pkegg_simp <- gbm.simplify(brt_pkegg7, n.drops = 5)
summary(pkegg_simp)
```

Clear that no variables should be dropped
```{r}
pkegg_final <- brt_pkegg7
```

Plot the variables
```{r}
gbm.plot(pkegg_final, 
         n.plots = 4, 
         plot.layout = c(2, 2), 
         write.title = F,
         smooth = T,
         common.scale = T,
         cex.axis = 1.7, 
         cex.lab = 1.7,
         lwd = 1.5)
```

Plot the fits
```{r}
gbm.plot.fits(pkegg_final)
```

Find interactions
```{r}
pkegg_int <- gbm.interactions(pkegg_final)
pkegg_int$interactions

par(mfrow = c(1, 3))
gbm.perspec(pkegg_final, 
            2, 3, 
            z.range = c(0, 7.69), 
            theta = 60,
            col = "light blue",
            cex.axis = 0.8,
            cex.lab = 1,
            ticktype = "detailed")

gbm.perspec(pkegg_final, 
            1, 3, 
            z.range = c(0, 10.75), 
            theta = 60,
            col = "light blue",
            cex.axis = 0.8,
            cex.lab = 1,
            ticktype = "detailed")

gbm.perspec(pkegg_final, 
            1, 2, 
            z.range = c(0, 9.45), 
            theta = 60,
            col = "light blue",
            cex.axis = 0.8,
            cex.lab = 1,
            ticktype = "detailed")
```


When ready, use to predict on test data
```{r}
preds <- predict.gbm(pkegg_final, 
                     pkegg_test_data,
                     n.trees = pkegg_final$gbm.call$best.trees, 
                     type = "response")
summary(preds)

pkegg_test_data$pred <- predict(pkegg_final, 
                     pkegg_test_data,
                     n.trees = pkegg_final$gbm.call$best.trees, 
                     type = "response")

rmse_egg_gam <- sqrt(mean((pkegg_test_data$abundance - pkegg_test_data$pred)^2))
rmse_egg_gam # 2.34

pkegg_test_data <- pkegg_test_data[-c(23)]

calc.deviance(obs = pkegg_test_data$abundance,
              pred = preds,
              calc.mean = TRUE,
              family = "gaussian")

pk_egg$pred <- predict.gbm(pkegg_final, 
                           pk_egg,
                           n.trees = pkegg_final$gbm.call$best.trees,
                           type = "response")
```

Create a grid, add predictions to it
```{r}
nlat = 80
nlon = 120
latd = seq(min(pk_egg$lat), max(pk_egg$lat), length.out = nlat)
lond = seq(min(pk_egg$lon), max(pk_egg$lon), length.out = nlon)
spatial_grid <- expand.grid(lond, latd)
names(spatial_grid) <- c('lon', 'lat')

# match nearest neighbor
spatial_grid[, c(3, 4)] <- as.data.frame(RANN::nn2(pk_egg[, c(2, 1)], spatial_grid[, c(1, 2)], k = 1))
spatial_grid[, 5] <- pk_egg[spatial_grid[, 3], 23]
spatial_grid <- spatial_grid[-c(3, 4)]
colnames(spatial_grid)[3] <- "pred"
spatial_grid$dist <- NA
  for (k in 1:nrow(spatial_grid)) {
    dist <-  distance_function(spatial_grid$lat[k],
                               spatial_grid$lon[k],
                               pk_egg$lat,
                               pk_egg$lon)
    spatial_grid$dist[k] <- min(dist)
  }
spatial_grid$pred[spatial_grid$dist > 30000] <- NA
```

Plot final SD map
```{r}
nlat = 80
nlon = 120
latd = seq(min(spatial_grid$lat), max(spatial_grid$lat), length.out = nlat)
lond = seq(min(spatial_grid$lon), max(spatial_grid$lon), length.out = nlon)
my_color = colorRampPalette(rev(
  c("#FFFFCC", "#FBF2A8", "#F9E585",
    "#F5D363", "#EFBA55", "#EAA352",
    "#E68C51", "#E0754F", "#D75C4D",
    "#BB4A48", "#994240", "#763931", 
    "#542D20", "#352311", "#191900")))
color_levels = 100
max_absolute_value = max(abs(c( min(spatial_grid$pred, na.rm = T),
                                max(spatial_grid$pred, na.rm = T))))
color_sequence = seq(-max_absolute_value, max_absolute_value,
                     length.out = color_levels + 1)
n_in_class = hist(spatial_grid$pred, breaks = color_sequence, plot = F)$counts > 0
col_to_include = min(which(n_in_class == T)):max(which(n_in_class == T))
breaks_to_include = min(which(n_in_class == T)):(max(which(n_in_class == T)) + 1)

par(mfrow = c(1, 1),
    family = "serif")
image(lond,
      latd,
      t(matrix(
        spatial_grid$pred,
        nrow = length(latd),
        ncol = length(lond),
        byrow = T)),
      xlim = c(-176.5,-156.5),
      ylim = c(52, 62),
      axes = FALSE,
      xlab = "",
      ylab = "")
rect(par("usr")[1], par("usr")[3], par("usr")[2], par("usr")[4], col = "mintcream")
par(new = TRUE)
image(lond,
      latd,
      t(matrix(spatial_grid$pred,
                 nrow = length(latd),
                 ncol = length(lond),
               byrow = T)),
      col = my_color(n = color_levels)[col_to_include],
      breaks = color_sequence[breaks_to_include],
      ylab = "Latitude",
      xlab = "Longitude",
      xlim = c(-176.5,-156.5),
      ylim = c(52, 62),
      main = "Distribution of Walleye Pollock Eggs (BRT)",
      cex.main = 1.5,
      cex.lab = 1.5,
      cex.axis = 1.5,)
symbols(pk_egg$lon[pk_egg$larvalcatchper10m2 > 0],
        pk_egg$lat[pk_egg$larvalcatchper10m2 > 0],
        circles = log(pk_egg$larvalcatchper10m2 + 1)[pk_egg$larvalcatchper10m2 > 0],
        inches = 0.1,
        bg = alpha('grey', 0.3),
        fg = alpha('black', 0.1),
        add = T)
points(pk_egg$lon[pk_egg$larvalcatchper10m2 == 0],
       pk_egg$lat[pk_egg$larvalcatchper10m2 == 0],
       pch =  '')
maps::map("worldHires",
          fill = T,
          col = "wheat4",
          add = T)
image.plot(legend.only = T,
           col = jet.colors(100),
           legend.shrink = 0.2,
           smallplot = c(.85, .88, .14, .38),
           legend.cex = 1,
           axis.args = list(cex.axis = 1.2),
           legend.width = 0.8,
           legend.mar = 6,
           zlim = c(-1.60, 10.89),
           legend.args = list("Occurrence",
                              side = 2, cex = 1.1))
```


## Larvae
```{r}
brt_pklarvae1 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.01,
                     bag.fraction = 0.5)

length(brt_pklarvae1$fitted)
summary(brt_pklarvae1)
```

Reduce the learning rate, too few trees above
```{r}
brt_pklarvae2 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.001,
                     bag.fraction = 0.5)

length(brt_pklarvae2$fitted)
summary(brt_pklarvae2)
```

Slightly higher learning rate
```{r}
brt_pklarvae3 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.005,
                     bag.fraction = 0.5)
length(brt_pklarvae3$fitted)
summary(brt_pklarvae3)
```

Tree complexity = 1
```{r}
brt_pklarvae4 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 1,
                     learning.rate = 0.005,
                     bag.fraction = 0.5)
length(brt_pklarvae4$fitted)
summary(brt_pklarvae4)
```

Tree complexity = 10 
```{r}
brt_pklarvae5 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.001,
                     bag.fraction = 0.5)
length(brt_pklarvae5$fitted)
summary(brt_pklarvae5)
```

```{r}
brt_pklarvae6 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.01,
                     bag.fraction = 0.5)
length(brt_pklarvae6$fitted)
summary(brt_pklarvae6)
```

```{r}
brt_pklarvae7 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.01,
                     bag.fraction = 0.75)
length(brt_pklarvae7$fitted)
summary(brt_pklarvae7)

dev_larvae_brt <- (brt_pklarvae7$self.statistics$mean.null - brt_pklarvae7$cv.statistics$deviance.mean) /
  brt_pklarvae7$self.statistics$mean.null
dev_larvae_brt # 55.4% deviance explained
```

```{r}
brt_pklarvae8 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(6, 7, 11:12, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.01,
                     bag.fraction = 0.25)
length(brt_pklarvae8$fitted)
summary(brt_pklarvae8)
```


Attempt dropping variables
```{r}
pklarvae_simp <- gbm.simplify(brt_pklarvae7, n.drops = 5)
summary(pklarvae_simp)
```

Clear that no variables should be dropped
```{r}
pklarvae_final <- brt_pklarvae7
```

Plot the variables
```{r}
gbm.plot(pklarvae_final, 
         n.plots = 4, 
         plot.layout = c(2, 2), 
         write.title = F,
         smooth = T,
         cex.lab = 1.7,
         cex.axis = 1.7,
         lwd = 1.5)
```

Plot the fits
```{r}
gbm.plot.fits(pklarvae_final)
```

Find interactions
```{r}
pklarvae_int <- gbm.interactions(pklarvae_final)
pklarvae_int$interactions

par(mfrow = c(1, 3))
gbm.perspec(pklarvae_final, 
            2, 3, 
            z.range = c(0, 7.69), 
            theta = 60,
            col = "light blue",
            cex.axis = 0.8,
            cex.lab = 1,
            ticktype = "detailed")

gbm.perspec(pklarvae_final, 
            1, 3, 
            z.range = c(0, 10.75), 
            theta = 60,
            col = "light blue",
            cex.axis = 0.8,
            cex.lab = 1,
            ticktype = "detailed")

gbm.perspec(pklarvae_final, 
            1, 2, 
            z.range = c(0, 9.45), 
            theta = 60,
            col = "light blue",
            cex.axis = 0.8,
            cex.lab = 1,
            ticktype = "detailed")
```


When ready, use to predict on test data
```{r}
preds <- predict.gbm(pklarvae_final, 
                     pklarvae_test_data,
                     n.trees = pklarvae_final$gbm.call$best.trees, 
                     type = "response")
summary(preds)

pklarvae_test_data$pred <- predict(pklarvae_final, 
                     pklarvae_test_data,
                     n.trees = pklarvae_final$gbm.call$best.trees, 
                     type = "response")

rmse_larvae_gam <- sqrt(mean((pklarvae_test_data$abundance - pklarvae_test_data$pred)^2))
rmse_larvae_gam # 2.36


calc.deviance(obs = pklarvae_test_data$abundance,
              pred = preds,
              calc.mean = TRUE,
              family = "gaussian")

pklarvae_test_data <- pklarvae_test_data[-c(23)]

pk_larvae$pred <- predict.gbm(pklarvae_final, 
                           pk_larvae,
                           n.trees = pklarvae_final$gbm.call$best.trees,
                           type = "response")
```

Create a grid, add predictions to it
```{r}
nlat = 80
nlon = 120
latd = seq(min(pk_larvae$lat), max(pk_larvae$lat), length.out = nlat)
lond = seq(min(pk_larvae$lon), max(pk_larvae$lon), length.out = nlon)
spatial_grid <- expand.grid(lond, latd)
names(spatial_grid) <- c('lon', 'lat')

# match nearest neighbor
spatial_grid[, c(3, 4)] <- as.data.frame(RANN::nn2(pk_larvae[, c(2, 1)], spatial_grid[, c(1, 2)], k = 1))
spatial_grid[, 5] <- pk_larvae[spatial_grid[, 3], 23]
spatial_grid <- spatial_grid[-c(3, 4)]
colnames(spatial_grid)[3] <- "pred"
spatial_grid$dist <- NA
  for (k in 1:nrow(spatial_grid)) {
    dist <-  distance_function(spatial_grid$lat[k],
                               spatial_grid$lon[k],
                               pk_larvae$lat,
                               pk_larvae$lon)
    spatial_grid$dist[k] <- min(dist)
  }
spatial_grid$pred[spatial_grid$dist > 30000] <- NA
```

Plot final SD map
```{r}
nlat = 80
nlon = 120
latd = seq(min(spatial_grid$lat), max(spatial_grid$lat), length.out = nlat)
lond = seq(min(spatial_grid$lon), max(spatial_grid$lon), length.out = nlon)
my_color = colorRampPalette(rev(
  c("#FFFFCC", "#FBF2A8", "#F9E585",
    "#F5D363", "#EFBA55", "#EAA352",
    "#E68C51", "#E0754F", "#D75C4D",
    "#BB4A48", "#994240", "#763931", 
    "#542D20", "#352311", "#191900")))
color_levels = 100
max_absolute_value = max(abs(c( min(spatial_grid$pred, na.rm = T),
                                max(spatial_grid$pred, na.rm = T))))
color_sequence = seq(-max_absolute_value, max_absolute_value,
                     length.out = color_levels + 1)
n_in_class = hist(spatial_grid$pred, breaks = color_sequence, plot = F)$counts > 0
col_to_include = min(which(n_in_class == T)):max(which(n_in_class == T))
breaks_to_include = min(which(n_in_class == T)):(max(which(n_in_class == T)) + 1)

par(mfrow = c(1, 1),
    family = "serif")
image(lond,
      latd,
      t(matrix(
        spatial_grid$pred,
        nrow = length(latd),
        ncol = length(lond),
        byrow = T)),
      xlim = c(-176.5,-156.5),
      ylim = c(52, 62),
      axes = FALSE,
      xlab = "",
      ylab = "")
rect(par("usr")[1], par("usr")[3], par("usr")[2], par("usr")[4], col = "mintcream")
par(new = TRUE)
image(lond,
      latd,
      t(matrix(spatial_grid$pred,
                 nrow = length(latd),
                 ncol = length(lond),
               byrow = T)),
      col = my_color(n = color_levels)[col_to_include],
      breaks = color_sequence[breaks_to_include],
      ylab = "Latitude",
      xlab = "Longitude",
      xlim = c(-176.5,-156.5),
      ylim = c(52, 62),
      main = "Distribution of Walleye Pollock Larvae (BRT)",
      cex.main = 1.5,
      cex.lab = 1.5,
      cex.axis = 1.5,)
symbols(pk_larvae$lon[pk_larvae$larvalcatchper10m2 > 0],
        pk_larvae$lat[pk_larvae$larvalcatchper10m2 > 0],
        circles = log(pk_larvae$larvalcatchper10m2 + 1)[pk_larvae$larvalcatchper10m2 > 0],
        inches = 0.1,
        bg = alpha('grey', 0.3),
        fg = alpha('black', 0.1),
        add = T)
points(pk_larvae$lon[pk_larvae$larvalcatchper10m2 == 0],
       pk_larvae$lat[pk_larvae$larvalcatchper10m2 == 0],
       pch =  '')
maps::map("worldHires",
          fill = T,
          col = "wheat4",
          add = T)
image.plot(legend.only = T,
           col = jet.colors(100),
           legend.shrink = 0.2,
           smallplot = c(.85, .88, .14, .38),
           legend.cex = 1,
           axis.args = list(cex.axis = 1.2),
           legend.width = 0.8,
           legend.mar = 6,
           zlim = c(-1.60, 10.89),
           legend.args = list("Occurrence",
                              side = 2, cex = 1.1))
```


### Boosted Regression Trees: Extra Terms
## Eggs
```{r}
brt_egg1 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.01,
                     bag.fraction = 0.5)

length(brt_egg1$fitted)
summary(brt_egg1)
```

Reduce the learning rate, too few trees above
```{r}
brt_egg2 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.001,
                     bag.fraction = 0.5)

length(brt_egg2$fitted)
summary(brt_egg2)
```

Slightly higher learning rate
```{r}
brt_egg3 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.005,
                     bag.fraction = 0.5)
length(brt_egg3$fitted)
summary(brt_egg3)
```

Tree complexity = 1
```{r}
brt_egg4 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 1,
                     learning.rate = 0.005,
                     bag.fraction = 0.5)
length(brt_egg4$fitted)
summary(brt_egg4)
```

Tree complexity = 10 
```{r}
brt_egg5 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.001,
                     bag.fraction = 0.5)
length(brt_egg5$fitted)
summary(brt_egg5)
```

```{r}
brt_egg6 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.01,
                     bag.fraction = 0.5)
length(brt_egg6$fitted)
summary(brt_egg6)
```

```{r}
brt_egg7 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(6, 7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.005,
                     bag.fraction = 0.5)
length(brt_egg7$fitted)
summary(brt_egg7)
```

```{r}
brt_egg8 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(6, 7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.005,
                     bag.fraction = 0.75)
length(brt_egg8$fitted)
summary(brt_egg8)

dev_egg_brt2 <- (brt_egg8$self.statistics$mean.null - brt_egg8$cv.statistics$deviance.mean) /
  brt_egg8$self.statistics$mean.null
dev_egg_brt2 # 50.4%
```

```{r}
brt_egg9 <- gbm.step(data = pkegg_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.005,
                     bag.fraction = 0.25)
length(brt_egg9$fitted)
summary(brt_egg9)
```

Attempt dropping variables
```{r}
pkegg_simp <- gbm.simplify(brt_egg8, n.drops = 4)
summary(pkegg_simp)
```

Clear that two variables should be dropped
```{r}
pkegg_final2 <- gbm.step(pkegg_train_data,
                       gbm.x = pkegg_simp$pred.list[[1]], 
                       gbm.y = 21,
                       tree.complexity = 10, 
                       learning.rate = 0.005,
                       bag.fraction = 0.75,
                       family = "gaussian")
summary(pkegg_final2)

dev_egg_brt2 <- (pkegg_final2$self.statistics$mean.null - pkegg_final2$cv.statistics$deviance.mean) /
  pkegg_final2$self.statistics$mean.null
dev_egg_brt2 # 50.4%
```

Plot the variables
```{r}
gbm.plot(pkegg_final2, 
         n.plots = 7, 
         plot.layout = c(3, 3), 
         write.title = F,
         smooth = T)
```

Plot the fits
```{r}
gbm.plot.fits(pkegg_final2)
```

Find interactions
```{r}
pkegg_int <- gbm.interactions(pkegg_final2)
pkegg_int$interactions

gbm.perspec(pkegg_final2, 
            2, 3, 
            z.range = c(0, 6.64), 
            theta = 60,
            col = "light blue",
            cex.axis = 0.8,
            cex.lab = 1,
            ticktype = "detailed")
```


When ready, use to predict on test data
```{r}
preds <- predict.gbm(pkegg_final2, 
                     pkegg_test_data,
                     n.trees = pkegg_final2$gbm.call$best.trees, 
                     type = "response")
summary(preds)

pkegg_test_data$pred <- predict(pkegg_final2, 
                     pkegg_test_data,
                     n.trees = pkegg_final2$gbm.call$best.trees, 
                     type = "response")

rmse_egg_gam <- sqrt(mean((pkegg_test_data$abundance - pkegg_test_data$pred)^2))
rmse_egg_gam # 2.41

calc.deviance(obs = pkegg_test_data$abundance,
              pred = preds,
              calc.mean = TRUE,
              family = "gaussian")

pkegg_test_data <- pkegg_test_data[-c(23)]
```

## Larvae
```{r}
brt_larvae1 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.01,
                     bag.fraction = 0.5)

length(brt_larvae1$fitted)
summary(brt_larvae1)
```

Reduce the learning rate, too few trees above
```{r}
brt_larvae2 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.001,
                     bag.fraction = 0.5)

length(brt_larvae2$fitted)
summary(brt_larvae2)
```

Slightly higher learning rate
```{r}
brt_larvae3 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 5,
                     learning.rate = 0.005,
                     bag.fraction = 0.5)
length(brt_larvae3$fitted)
summary(brt_larvae3)
```

Tree complexity = 1
```{r}
brt_larvae4 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 1,
                     learning.rate = 0.005,
                     bag.fraction = 0.5)
length(brt_larvae4$fitted)
summary(brt_larvae4)
```

Tree complexity = 10 
```{r}
brt_larvae5 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.001,
                     bag.fraction = 0.5)
length(brt_larvae5$fitted)
summary(brt_larvae5)
```

```{r}
brt_larvae6 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.01,
                     bag.fraction = 0.5)
length(brt_larvae6$fitted)
summary(brt_larvae6)
```

```{r}
brt_larvae7 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.005,
                     bag.fraction = 0.5)
length(brt_larvae7$fitted)
summary(brt_larvae7)
```

```{r}
brt_larvae8 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(6, 7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.005,
                     bag.fraction = 0.75)
length(brt_larvae8$fitted)
summary(brt_larvae8)

dev_larvae_brt2 <- (brt_larvae8$self.statistics$mean.null - brt_larvae8$cv.statistics$deviance.mean) /
  brt_larvae8$self.statistics$mean.null
dev_larvae_brt2 # 55.4%
```

```{r}
brt_larvae9 <- gbm.step(data = pklarvae_train_data,
                     gbm.x = c(7, 11:17, 19),
                     gbm.y = 21,
                     family = 'gaussian',
                     tree.complexity = 10,
                     learning.rate = 0.005,
                     bag.fraction = 0.25)
length(brt_larvae9$fitted)
summary(brt_larvae9)
```

Attempt dropping variables
```{r}
pklarvae_simp <- gbm.simplify(brt_larvae8, n.drops = 4)
summary(pklarvae_simp)
```

Clear that three variables should be dropped
```{r}
pklarvae_final2 <- gbm.step(pklarvae_train_data,
                       gbm.x = pklarvae_simp$pred.list[[3]], 
                       gbm.y = 21,
                       tree.complexity = 10, 
                       learning.rate = 0.005,
                       bag.fraction = 0.75,
                       family = "gaussian")
summary(pklarvae_final2)

dev_larvae_brt2 <- (pklarvae_final2$self.statistics$mean.null -
                      pklarvae_final2$cv.statistics$deviance.mean) /
  pklarvae_final2$self.statistics$mean.null
dev_larvae_brt2 # 55.4%
```

Plot the variables
```{r}
gbm.plot(pklarvae_final2, 
         n.plots = 7, 
         plot.layout = c(3, 3), 
         write.title = F,
         smooth = T)
```

Plot the fits
```{r}
gbm.plot.fits(pklarvae_final2)
```

Find interactions
```{r}
pklarvae_int <- gbm.interactions(pklarvae_final2)
pklarvae_int$interactions

gbm.perspec(pklarvae_final2, 
            2, 3, 
            z.range = c(0, 6.64), 
            theta = 60,
            col = "light blue",
            cex.axis = 0.8,
            cex.lab = 1,
            ticktype = "detailed")
```


When ready, use to predict on test data
```{r}
preds <- predict.gbm(pklarvae_final2, 
                     pklarvae_test_data,
                     n.trees = pklarvae_final2$gbm.call$best.trees, 
                     type = "response")
summary(preds)

pklarvae_test_data$pred <- predict(pklarvae_final2, 
                     pklarvae_test_data,
                     n.trees = pklarvae_final2$gbm.call$best.trees, 
                     type = "response")

rmse_larvae_gam <- sqrt(mean((pklarvae_test_data$abundance - pklarvae_test_data$pred)^2))
rmse_larvae_gam # 2.11

calc.deviance(obs = pklarvae_test_data$abundance,
              pred = preds,
              calc.mean = TRUE,
              family = "gaussian")

pklarvae_test_data <- pklarvae_test_data[-c(23)]
```

### Introduction map
```{r}
BS_bathy <- getNOAA.bathy(lon1 = -176.5, lon2 = -156.5, 
                           lat1 = 51, lat2 = 65.5, 
                           resolution = 1)
blues <- c("lightsteelblue4", "lightsteelblue3", "lightsteelblue2", "lightsteelblue1")
greys <- c(grey(0.6), grey(0.93), grey(0.99))
```

```{r}
windows(width = 17,
        height = 14,)
par(mfrow = c(1, 1),
    family = 'serif',
    mar = c(4, 5, 3, .2) + .15)
plot.bathy(
  BS_bathy,
  image = T,
  axes = T,
  lwd = 0.03,
  land = T,
  n = 0,
  bpal = list(c(0,
                max(BS_bathy),
                greys),
              c(min(BS_bathy),
                0,
                blues)),
  xlim = c(-176.5,-156.8),
  ylim = c(51, 65.5),
  ylab = "Latitude °N",
  xlab = "Longitude °W",
  main = "",
  cex.lab = 2,
  cex.main = 2.5,
  cex.axis = 1.8)
points(pk_egg$lon[pk_egg$presence == 0],
       pk_egg$lat[pk_egg$presence == 0],
       pch = 4,
       col = 'red',
       cex = 1.1)
points(pk_egg$lon[pk_egg$presence == 1],
       pk_egg$lat[pk_egg$presence == 1],
       pch = 18,
       col = 'black',
       cex = 1)

```

